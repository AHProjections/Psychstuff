<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Inner Theatre — A Psychoanalytic Journey</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=IM+Fell+English:ital@0;1&family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #1a1018;
    --parchment: #f0e8d8;
    --aged: #c8b89a;
    --deep-violet: #2d1b4e;
    --violet: #4a2d7a;
    --crimson: #8b1a2e;
    --gold: #b8902a;
    --teal: #1a5c5c;
    --env-color: #b8902a;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--ink);
    color: var(--parchment);
    font-family: 'IM Fell English', serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    overflow-y: auto;
    overflow-x: hidden;
    position: relative;
    padding: 32px 16px 80px;
    -webkit-text-size-adjust: 100%;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse at 15% 50%, rgba(45,27,78,0.35) 0%, transparent 55%),
      radial-gradient(ellipse at 85% 20%, rgba(139,26,46,0.18) 0%, transparent 45%),
      radial-gradient(ellipse at 55% 85%, rgba(74,45,122,0.25) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");
    opacity: 0.35;
    pointer-events: none;
    z-index: 1;
  }

  #game-container {
    position: relative;
    z-index: 2;
    width: min(720px, 96vw);
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  /* ── HEADER ── */
  .header-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid rgba(184,144,42,0.25);
    padding-bottom: 10px;
    margin-bottom: 22px;
  }
  .game-title {
    font-family: 'Playfair Display', serif;
    font-size: 0.75rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: #c8a040;
    opacity: 0.9;
  }
  .stage-indicator {
    font-family: 'Cormorant Garamond', serif;
    font-size: 0.82rem;
    letter-spacing: 0.15em;
    color: #c8b89a;
    font-style: italic;
  }

  /* ── TRAIT BAR ── */
  #trait-panel {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 14px;
  }
  .trait-chip {
    font-family: 'Cormorant Garamond', serif;
    font-size: 0.72rem;
    letter-spacing: 0.12em;
    padding: 3px 10px;
    border: 1px solid rgba(184,144,42,0.35);
    color: var(--aged);
    font-style: italic;
    opacity: 0;
    transform: translateY(4px);
    transition: opacity 0.5s, transform 0.5s;
  }
  .trait-chip.visible { opacity: 1; transform: translateY(0); }
  .trait-chip.highlight { border-color: var(--gold); color: var(--gold); }

  /* ── SCENE BOX ── */
  .scene-box {
    border: 1px solid rgba(184,144,42,0.28);
    background: #100a14;
    padding: 34px 38px;
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 18px;
    /* Always opaque — flash prevention */
    will-change: auto;
  }
  .scene-box::before {
    content: '❧';
    position: absolute;
    top: 9px; left: 14px;
    color: var(--gold);
    opacity: 0.35;
    font-size: 1.1rem;
    pointer-events: none;
  }
  .scene-box::after {
    content: '❧';
    position: absolute;
    bottom: 9px; right: 14px;
    color: var(--gold);
    opacity: 0.35;
    font-size: 1.1rem;
    transform: rotate(180deg);
    pointer-events: none;
  }

  .age-label {
    font-family: 'Playfair Display', serif;
    font-size: 0.7rem;
    letter-spacing: 0.35em;
    text-transform: uppercase;
    color: #c8a040;
    opacity: 1;
  }
  .scene-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.75rem;
    line-height: 1.28;
    color: #f5ede0;
    font-weight: 400;
    letter-spacing: 0.01em;
  }
  .scene-text {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.22rem;
    line-height: 2.0;
    color: rgba(245,237,224,0.94);
    font-weight: 400;
  }
  .scene-text em { color: #d4b87a; font-style: italic; }
  .scene-text strong { color: #f5ede0; font-weight: 400; }

  /* Echo box — shows earlier pattern repeating */
  .echo-box {
    border-left: 2px solid var(--gold);
    padding: 10px 18px;
    background: rgba(184,144,42,0.06);
    margin: 4px 0;
  }
  .echo-label {
    font-family: 'Playfair Display', serif;
    font-size: 0.68rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: #c8a040;
    opacity: 1;
    margin-bottom: 5px;
  }
  .echo-text {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.05rem;
    line-height: 1.78;
    color: rgba(210,194,164,0.95);
    font-style: italic;
    font-weight: 400;
  }

  /* Insight box — collapsible */
  .insight-box {
    border-left: 2px solid var(--crimson);
    background: rgba(139,26,46,0.07);
  }
  .insight-toggle {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 11px 18px 11px;
    cursor: pointer;
    user-select: none;
    list-style: none;
  }
  .insight-toggle::-webkit-details-marker { display: none; }
  .insight-label {
    font-family: 'Playfair Display', serif;
    font-size: 0.68rem;
    letter-spacing: 0.28em;
    text-transform: uppercase;
    color: #c84050;
    opacity: 1;
    flex: 1;
  }
  .insight-caret {
    font-size: 0.7rem;
    color: #c84050;
    opacity: 0.8;
    transition: transform 0.2s;
  }
  details[open] .insight-caret { transform: rotate(90deg); }
  .insight-text {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.05rem;
    line-height: 1.78;
    color: rgba(215,200,170,0.95);
    font-style: italic;
    font-weight: 400;
    padding: 0 18px 14px;
  }
  /* School label within insight */
  .school-label {
    font-family: 'Cormorant Garamond', serif;
    font-size: 0.72rem;
    letter-spacing: 0.18em;
    color: rgba(200,80,90,0.85);
    text-transform: uppercase;
    display: block;
    margin-bottom: 5px;
  }

  /* Paralysis state — when two defenses conflict */
  .paralysis-note {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.0rem;
    line-height: 1.75;
    color: rgba(196,160,72,0.92);
    font-style: italic;
    border: 1px solid rgba(184,144,42,0.2);
    border-left: 3px solid rgba(184,144,42,0.45);
    padding: 10px 16px;
    margin-bottom: 8px;
    background: rgba(184,144,42,0.04);
  }
  .choices-area.paralysed .choice-btn {
    opacity: 0.82;
    border-color: rgba(184,144,42,0.2);
    transition: all 0.4s ease;
  }
  .choices-area.paralysed .choice-btn:hover {
    opacity: 1;
    border-color: rgba(184,144,42,0.5);
  }

  /* Choices */
  .choices-area {
    display: flex;
    flex-direction: column;
    gap: 9px;
    margin-top: 6px;
  }
  .choice-btn {
    background: rgba(255,255,255,0.02);
    border: 1px solid rgba(184,144,42,0.35);
    color: #ede5d4;
    font-family: 'IM Fell English', serif;
    font-size: 1.08rem;
    padding: 16px 24px;
    text-align: left;
    cursor: pointer;
    transition: all 0.25s ease;
    line-height: 1.6;
    position: relative;
    z-index: 5;
  }
  .choice-btn::before { content: '◦  '; color: var(--gold); opacity: 0.6; transition: opacity 0.18s; }
  .choice-btn:hover { border-color: rgba(184,144,42,0.75); background: rgba(184,144,42,0.09); padding-left: 28px; color: #f5ede0; }
  .choice-btn:hover::before { opacity: 1; content: '◈  '; }
  .choice-btn.selected { border-color: var(--violet); background: rgba(74,45,122,0.18); pointer-events: none; color: #c8b8e8; }
  .choice-btn.post-faded { opacity: 0.22; pointer-events: none; }
  /* char-dominant: the character's path feels like home */
  .choice-btn.char-dominant { border-color: rgba(184,144,42,0.5); background: rgba(184,144,42,0.06); }
  .choice-btn.char-dominant::before { content: '◦  '; opacity: 0.85; color: var(--gold); }
  /* Resistance levels — against-character choices require multiple clicks */
  /* groove-1: mild resistance — 2 clicks needed */
  .choice-btn.groove-1 { opacity: 0.88; color: rgba(240,232,216,0.9); border-color: rgba(184,144,42,0.22); }
  .choice-btn.groove-1::before { content: '·  '; opacity: 0.4; }
  .choice-btn.groove-1:hover { opacity: 1; border-color: rgba(184,144,42,0.5); }

  /* groove-2: strong resistance — 3 clicks needed */
  .choice-btn.groove-2 { opacity: 0.75; color: rgba(240,232,216,0.78); border-color: rgba(184,144,42,0.15); border-style: dashed; }
  .choice-btn.groove-2::before { content: '·  '; opacity: 0.25; }
  .choice-btn.groove-2:hover { opacity: 0.88; border-color: rgba(184,144,42,0.38); }

  /* groove-3: deep resistance — 4 clicks needed, slightly muted */
  .choice-btn.groove-3 { opacity: 0.6; color: rgba(240,232,216,0.65); border-color: rgba(184,144,42,0.1); border-style: dashed; font-style: italic; }
  .choice-btn.groove-3::before { content: '·  '; opacity: 0.18; }
  .choice-btn.groove-3:hover { opacity: 0.75; }

  /* groove-4: gone */
  .choice-btn.groove-4 { display: none !important; }

  /* Unconscious voice — appears when resisting the original compromise */
  /* ── VOICE MODAL OVERLAY ── */
  .voice-modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(8,4,12,0.72);
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
    animation: backdrop-in 0.3s ease;
  }
  @keyframes backdrop-in {
    from { opacity: 0; }
    to   { opacity: 1; }
  }
  .voice-modal {
    background: rgba(14,8,18,0.97);
    border: 1px solid rgba(139,26,46,0.4);
    border-top: 3px solid rgba(139,26,46,0.65);
    max-width: 480px;
    width: 100%;
    padding: 32px 36px 28px;
    position: relative;
    animation: modal-in 0.35s cubic-bezier(0.34,1.56,0.64,1);
    box-shadow: 0 24px 80px rgba(0,0,0,0.7);
  }
  @keyframes modal-in {
    from { opacity: 0; transform: translateY(-18px) scale(0.97); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
  }
  .voice-modal-label {
    font-family: 'Playfair Display', serif;
    font-size: 0.68rem;
    letter-spacing: 0.32em;
    text-transform: uppercase;
    color: rgba(210,80,90,0.9);
    display: block;
    margin-bottom: 16px;
  }
  .voice-modal-text {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.1rem;
    line-height: 1.88;
    color: rgba(245,237,224,0.96);
    font-style: italic;
  }
  .voice-modal-divider {
    height: 1px;
    background: rgba(139,26,46,0.18);
    margin: 22px 0;
  }
  .voice-modal-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
  }
  .voice-modal-btn {
    font-family: 'IM Fell English', serif;
    font-size: 0.82rem;
    letter-spacing: 0.1em;
    padding: 9px 20px;
    cursor: pointer;
    border: 1px solid;
    background: none;
    transition: all 0.2s;
    position: relative;
    z-index: 5;
  }
  .voice-modal-btn-stay {
    color: rgba(184,144,42,0.9);
    border-color: rgba(184,144,42,0.4);
  }
  .voice-modal-btn-stay:hover {
    background: rgba(184,144,42,0.08);
    border-color: rgba(184,144,42,0.7);
  }
  .voice-modal-btn-override {
    color: rgba(240,232,216,0.7);
    border-color: rgba(240,232,216,0.35);
    font-style: italic;
  }
  .voice-modal-btn-override:hover {
    color: rgba(240,232,216,0.9);
    border-color: rgba(240,232,216,0.55);
  }
  /* Pulse on dominant button after modal closes */
  @keyframes dom-pulse {
    0%   { box-shadow: 0 0 0 0 rgba(184,144,42,0); }
    40%  { box-shadow: 0 0 0 6px rgba(184,144,42,0.22); }
    100% { box-shadow: 0 0 0 10px rgba(184,144,42,0); }
  }
  .choice-btn.dom-pulse { animation: dom-pulse 1.6s ease forwards; }
  /* resistance hint above an against-grain choice */
  .against-grain-note {
    font-family: 'Cormorant Garamond', serif;
    font-size: 0.82rem;
    color: rgba(210,80,90,0.88);
    font-style: italic;
    padding-left: 6px;
    margin-bottom: -4px;
  }

  /* Outcome / echo after choice */
  .outcome-text {
    font-family: 'Playfair Display', serif;
    font-size: 1.05rem;
    line-height: 1.72;
    color: var(--aged);
    font-style: italic;
    border-top: 1px solid rgba(184,144,42,0.18);
    padding-top: 14px;
    margin-top: 4px;
  }
  .pattern-echo {
    font-family: 'Cormorant Garamond', serif;
    font-size: 0.95rem;
    line-height: 1.65;
    color: rgba(184,144,42,0.75);
    font-style: italic;
    margin-top: 6px;
    padding: 8px 16px;
    border-left: 1px solid rgba(184,144,42,0.4);
  }

  /* Continue */
  .continue-btn {
    align-self: flex-end;
    background: rgba(184,144,42,0.14);
    border: 1px solid rgba(184,144,42,0.55);
    color: #d4a832;
    font-family: 'IM Fell English', serif;
    font-size: 1rem;
    letter-spacing: 0.14em;
    padding: 11px 30px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    z-index: 5;
  }
  .continue-btn:hover { background: rgba(184,144,42,0.22); border-color: #d4a832; color: #e8c050; }

  /* Progress */
  .psyche-bar-container {
    margin-top: 18px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .psyche-label {
    font-family: 'Playfair Display', serif;
    font-size: 0.68rem;
    letter-spacing: 0.22em;
    text-transform: uppercase;
    color: #c8b89a;
    opacity: 0.85;
    display: flex;
    justify-content: space-between;
  }
  .psyche-track { height: 2px; background: rgba(255,255,255,0.07); }
  .psyche-fill { height: 100%; background: linear-gradient(90deg, var(--crimson), var(--violet), var(--gold)); transition: width 0.9s ease; }

  /* ── TITLE SCREEN ── */
  #title-screen {
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 18px;
    padding: 44px 36px;
    border: 1px solid rgba(184,144,42,0.4);
    background: rgba(10,6,12,0.85);
  }
  .title-ornament { color: var(--gold); opacity: 0.8; animation: glow 5s ease-in-out infinite; }
  @keyframes glow { 0%,100%{opacity:0.55} 50%{opacity:1} }
  .main-title { font-family:'Playfair Display',serif; font-size:2.3rem; line-height:1.2; font-weight:400; color: var(--parchment); }
  .subtitle { font-family:'Cormorant Garamond',serif; font-size:0.9rem; letter-spacing:0.28em; text-transform:uppercase; color:var(--gold); opacity:0.9; }
  .intro-text { font-family:'Cormorant Garamond',serif; font-size:1.1rem; line-height:1.9; color: rgba(240,232,216,0.92); max-width:480px; font-weight:300; }
  .start-btn {
    margin-top: 10px;
    background: rgba(184,144,42,0.12);
    border: 1px solid var(--gold);
    color: var(--gold);
    font-family: 'IM Fell English', serif;
    font-size: 1.05rem;
    letter-spacing: 0.18em;
    padding: 13px 46px;
    cursor: pointer;
    transition: all 0.3s;
  }
  .start-btn:hover { background: rgba(184,144,42,0.09); letter-spacing: 0.26em; }


  /* ── DIFFICULTY SCREEN ───────────────────────────────────── */
  #difficulty-screen {
    border: 1px solid rgba(184,144,42,0.22);
    background: #100a14;
    padding: 34px 38px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  .difficulty-sub {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.08rem;
    line-height: 1.85;
    color: rgba(245,237,224,0.88);
  }
  .difficulty-cards { display: flex; flex-direction: column; gap: 10px; }
  .difficulty-card {
    border: 1px solid rgba(184,144,42,0.28);
    padding: 18px 22px;
    cursor: pointer;
    background: rgba(255,255,255,0.02);
    transition: all 0.22s ease;
  }
  .difficulty-card:hover { border-color: rgba(184,144,42,0.6); background: rgba(184,144,42,0.06); }
  .difficulty-card.selected { border-color: rgba(184,144,42,0.8); background: rgba(184,144,42,0.1); }
  .difficulty-card-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.05rem;
    color: #f5ede0;
    margin-bottom: 4px;
  }
  .difficulty-card-tagline {
    font-family: 'Cormorant Garamond', serif;
    font-size: 0.9rem;
    color: #c8a040;
    font-style: italic;
    margin-bottom: 6px;
  }
  .difficulty-card-desc {
    font-family: 'Cormorant Garamond', serif;
    font-size: 0.98rem;
    line-height: 1.68;
    color: rgba(240,232,216,0.85);
  }
  .difficulty-ace-preview {
    font-family: 'Cormorant Garamond', serif;
    font-size: 0.88rem;
    color: rgba(200,100,90,0.82);
    font-style: italic;
    border-left: 2px solid rgba(139,26,46,0.35);
    padding-left: 12px;
    margin-top: 9px;
    line-height: 1.65;
  }
  .difficulty-begin-btn {
    align-self: flex-end;
    background: rgba(184,144,42,0.14);
    border: 1px solid rgba(184,144,42,0.55);
    color: #d4a832;
    font-family: 'IM Fell English', serif;
    font-size: 1rem;
    letter-spacing: 0.14em;
    padding: 11px 30px;
    cursor: pointer;
    transition: all 0.2s;
    opacity: 0.35;
    pointer-events: none;
  }
  .difficulty-begin-btn.active {
    opacity: 1;
    pointer-events: all;
  }
  .difficulty-begin-btn.active:hover { background: rgba(184,144,42,0.22); border-color: #d4a832; color: #e8c050; }
  /* ACE stage — red-tinted age label */
  .age-label.ace { color: rgba(210,80,80,0.9); }

  /* ── ENVIRONMENT SELECT ── */
  #env-screen {
    display: flex;
    flex-direction: column;
    gap: 18px;
    padding: 34px 38px;
    border: 1px solid rgba(184,144,42,0.22);
    background: rgba(20,12,22,0.65);
  }
  .env-screen-title { color: var(--parchment);
    font-family: 'Playfair Display', serif;
    font-size: 1.4rem;
    color: var(--parchment);
  }
  .env-screen-sub {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.08rem;
    line-height: 1.8;
    color: rgba(240,232,216,0.88);
    font-weight: 300;
  }
  .env-cards {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 4px;
  }
  .env-card {
    border: 1px solid rgba(184,144,42,0.28);
    padding: 18px 22px;
    cursor: pointer;
    transition: all 0.25s;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .env-card:hover { border-color: rgba(184,144,42,0.7); background: rgba(184,144,42,0.05); }
  .env-card-title { font-family: 'Playfair Display', serif; font-size: 1.05rem; color: var(--parchment); }
  .env-card-tagline { font-family: 'Cormorant Garamond', serif; font-size: 0.9rem; color: var(--gold); font-style: italic; opacity: 0.9; }
  .env-card-desc { font-family: 'Cormorant Garamond', serif; font-size: 0.95rem; line-height: 1.6; color: rgba(240,232,216,0.88); font-weight: 300; margin-top: 2px; }

  /* ── END SCREEN ── */
  .resolution-badge { font-family:'Playfair Display',serif; font-size:1.65rem; color:var(--gold); text-align:center; }
  #psyche-scores { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px; }
  .score-pill { border:1px solid rgba(184,144,42,0.28); padding:5px 14px; font-family:'Cormorant Garamond',serif; font-size:0.82rem; color:var(--aged); }

  /* Pattern ledger */
  .pattern-ledger {
    border: 1px solid rgba(184,144,42,0.2);
    padding: 16px 20px;
    margin-top: 4px;
  }
  .pattern-ledger-title {
    font-family: 'Playfair Display', serif;
    font-size: 0.7rem;
    letter-spacing: 0.28em;
    text-transform: uppercase;
    color: #c8a040;
    opacity: 0.95;
    margin-bottom: 10px;
  }
  .pattern-row {
    font-family: 'Cormorant Garamond', serif;
    font-size: 0.98rem;
    line-height: 1.75;
    color: rgba(210,194,164,0.92);
    font-style: italic;
    padding: 4px 0;
    border-bottom: 1px solid rgba(184,144,42,0.1);
  }
  .pattern-row:last-child { border-bottom: none; }

  /* ── PRE-VERBAL STAGE STYLING (stages 0-2) ── */
  .scene-box.preverbal {
    background: rgba(10,5,14,0.85);
    border-color: rgba(184,144,42,0.12);
  }
  .preverbal-text {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.25rem;
    line-height: 2.6;
    letter-spacing: 0.08em;
    color: rgba(240,232,216,0.82);
    font-weight: 300;
    font-style: italic;
    text-align: center;
    padding: 12px 0;
  }
  .preverbal-text .word {
    display: inline-block;
    opacity: 0;
    animation: wordArrive 0.6s ease forwards;
    margin: 0 0.18em;
  }
  @keyframes wordArrive {
    from { opacity: 0; transform: translateY(6px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .preverbal-choice {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.05rem;
    font-style: italic;
    color: rgba(240,232,216,0.75);
    border: 1px solid rgba(184,144,42,0.2);
    padding: 14px 22px;
    cursor: pointer;
    background: none;
    text-align: center;
    transition: all 0.4s ease;
    letter-spacing: 0.04em;
    line-height: 1.5;
  }
  .preverbal-choice:hover {
    color: rgba(240,232,216,1);
    border-color: rgba(184,144,42,0.5);
    background: rgba(184,144,42,0.04);
  }

  /* ── UNCONSCIOUS INTRUSIONS ── */
  .unconscious-intrusion {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.0rem;
    font-style: italic;
    color: rgba(200,100,110,0.82);
    text-align: center;
    letter-spacing: 0.06em;
    padding: 6px 0;
    opacity: 0;
    animation: intrusionFade 3s ease forwards;
    pointer-events: none;
  }
  @keyframes intrusionFade {
    0%   { opacity: 0; }
    15%  { opacity: 1; }
    75%  { opacity: 1; }
    100% { opacity: 0.35; }
  }

  /* ── REPETITION CALLBACK ── */
  .repetition-callback {
    font-family: 'Cormorant Garamond', serif;
    font-size: 0.9rem;
    line-height: 1.65;
    color: rgba(184,144,42,0.6);
    font-style: italic;
    border-left: 2px solid rgba(184,144,42,0.3);
    padding: 8px 16px;
    margin-top: 2px;
    background: rgba(184,144,42,0.03);
  }
  .repetition-callback-label {
    font-family: 'Playfair Display', serif;
    font-size: 0.68rem;
    letter-spacing: 0.28em;
    text-transform: uppercase;
    color: rgba(196,160,72,0.85);
    display: block;
    margin-bottom: 4px;
  }

  /* ── SUPEREGO VOICE ── */
  .superego-voice {
    font-family: 'IM Fell English', serif;
    font-size: 0.88rem;
    font-style: italic;
    color: rgba(139,26,46,0.7);
    border: 1px solid rgba(139,26,46,0.2);
    border-left: 3px solid rgba(139,26,46,0.5);
    padding: 10px 16px;
    background: rgba(139,26,46,0.05);
    letter-spacing: 0.02em;
    line-height: 1.65;
  }
  .superego-label {
    font-family: 'Playfair Display', serif;
    font-size: 0.68rem;
    letter-spacing: 0.28em;
    text-transform: uppercase;
    color: rgba(210,80,90,0.85);
    display: block;
    margin-bottom: 5px;
  }

  /* ── AMBIVALENCE SPLIT ── */
  .ambivalence-split {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin: 4px 0;
  }
  .ambivalence-side {
    font-family: 'Cormorant Garamond', serif;
    font-size: 0.95rem;
    line-height: 1.65;
    padding: 12px 14px;
    font-style: italic;
  }
  .ambivalence-love {
    border-left: 2px solid rgba(184,144,42,0.4);
    color: rgba(240,232,216,0.8);
    background: rgba(184,144,42,0.04);
  }
  .ambivalence-hate {
    border-left: 2px solid rgba(139,26,46,0.4);
    color: rgba(240,232,216,0.75);
    background: rgba(139,26,46,0.04);
  }

  .stage-content {
    display: flex;
    flex-direction: column;
    gap: 18px;
    animation: fadeUp 0.5s ease forwards;
  }
  /* Utility */
  .hidden { display: none !important; }
  /* Fade only the inner content, not the box itself — prevents white flash on mobile */
  .fade-enter { animation: fadeUp 0.5s ease forwards; }
  @keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
  /* Scene box always dark — never transparent even mid-animation */
  .scene-box, .scene-box.preverbal {
    background: #100a14 !important;
  }

  @media(max-width:520px){
    .scene-box{padding:24px 20px}
    .scene-title{font-size:1.45rem}
    .scene-text{font-size:1.12rem;line-height:1.95}
    .choice-btn{font-size:1rem;padding:15px 18px}
    .main-title{font-size:1.75rem}
    #title-screen{padding:28px 18px}
    #env-screen{padding:22px 18px}
    .outcome-text{font-size:1.08rem}
    .continue-btn{font-size:0.95rem;padding:12px 26px}
  }
</style>
</head>
<body>
<div id="game-container">

  <!-- HEADER (hidden until game starts) -->
  <div class="header-bar hidden" id="game-header">
    <span class="game-title">The Inner Theatre</span>
    <span class="stage-indicator" id="stage-indicator">–</span>
  </div>

  <!-- TRAIT PANEL -->
  <div id="trait-panel" class="hidden"></div>

  <!-- SCREENS -->
  <div id="title-screen">
    <div class="title-ornament" style="font-size:2.2rem">⚘</div>
    <div class="main-title">The Inner Theatre</div>
    <div class="subtitle">A Psychoanalytic Journey</div>
    <p class="intro-text">
      You are about to traverse the invisible landscape of the developing psyche —
      from first breath through adult life. Every choice you make will become a
      default, used again and again until it shapes who you are.<br><br>
      <em>The environment you grow up in will determine which choices serve you best.</em>
    </p>
    <div style="color:var(--gold);opacity:0.3;font-size:0.9rem">— — —</div>
    <button class="start-btn" onclick="showEnvSelect()">Enter the Theatre</button>
  </div>

  <div id="env-screen" class="hidden">
    <div class="age-label">Before the curtain rises</div>
    <div class="env-screen-title">Choose Your World</div>
    <p class="env-screen-sub">
      The family you are born into is not your choice. But it will shape your first solutions
      to life's problems — and those solutions will follow you long after you leave.
      Choose the environment that calls to you.
    </p>
    <div class="env-cards">
      <div class="env-card" onclick="selectEnv('enmeshed')">
        <div class="env-card-title">The Warm House</div>
        <div class="env-card-tagline">A loving mother, a gentle but distant father — intimacy in abundance, separateness in short supply</div>
        <div class="env-card-desc">Your mother is devoted, present, occasionally overwhelming. She feels your feelings before you do. Your father loves the family but withdraws into work, returning in the evenings like a slightly foreign dignitary. The central challenge: <em>how to have a self when love feels like merger.</em></div>
      </div>
      <div class="env-card" onclick="selectEnv('cold')">
        <div class="env-card-title">The Orderly House</div>
        <div class="env-card-tagline">Capable, consistent parents — emotionally reserved, high-achieving, reliable but cool</div>
        <div class="env-card-desc">Your parents are competent and dependable. They provide — shelter, routine, education, security. But warmth is rationed; emotional expression makes them uncomfortable. The central challenge: <em>how to feel at home in your own need when need was met with silence.</em></div>
      </div>
      <div class="env-card" onclick="selectEnv('chaotic')">
        <div class="env-card-title">The Unpredictable House</div>
        <div class="env-card-tagline">A volatile household — love and rupture in equal measure, the ground always slightly uncertain</div>
        <div class="env-card-desc">Sometimes your home is warm and wonderful. Other times, something shifts — a mood, a fight, an absence — and the warmth disappears without explanation. Love is real here, but it is not reliable. The central challenge: <em>how to trust when trust has been broken and repaired so many times.</em></div>
      </div>
    </div>
  </div>


  <div id="difficulty-screen" class="hidden">
    <div class="age-label">Before the curtain rises</div>
    <div class="env-screen-title">The Weight of Circumstance</div>
    <p class="difficulty-sub">
      Some childhoods carry more adversity than others — not because of who the child is,
      but because of what the world delivers. Choose how much the world delivers to yours.
    </p>
    <div class="difficulty-cards">
      <div class="difficulty-card" onclick="selectDifficulty(0, this)">
        <div class="difficulty-card-title">Still Waters</div>
        <div class="difficulty-card-tagline">Ordinary developmental difficulty — the usual pressures of growing up</div>
        <div class="difficulty-card-desc">The normal turbulence of childhood: the oedipal drama, the rivalries, the first loves and losses. Nothing catastrophic arrives. The original compromise forms in ordinary conditions.</div>
      </div>
      <div class="difficulty-card" onclick="selectDifficulty(1, this)">
        <div class="difficulty-card-title">Troubled Waters</div>
        <div class="difficulty-card-tagline">Significant adversity — events that leave a mark, deepen the compromise</div>
        <div class="difficulty-card-desc">Two disruptions alter the arc of development. A parent struggles. Something is lost. The child adapts — and the adaptation echoes forward into adult life.</div>
        <div class="difficulty-ace-preview">A parent's depression or prolonged absence &nbsp;·&nbsp; A significant disruption in middle childhood</div>
      </div>
      <div class="difficulty-card" onclick="selectDifficulty(2, this)">
        <div class="difficulty-card-title">Deep Waters</div>
        <div class="difficulty-card-tagline">Pervasive adversity — the original compromise is built under pressure, not just difficulty</div>
        <div class="difficulty-card-desc">Four adverse events shape development. Some arrive before language. Some require the child to carry what adults should carry. The original compromise is formed not just to manage ordinary frustration, but to survive.</div>
        <div class="difficulty-ace-preview">Early attachment disruption &nbsp;·&nbsp; A parent who struggles &nbsp;·&nbsp; Sustained adversity in middle childhood &nbsp;·&nbsp; The cumulative toll by adolescence</div>
      </div>
    </div>
    <button class="difficulty-begin-btn" id="difficulty-begin-btn" onclick="beginGame()">Enter the Theatre →</button>
  </div>

  <div id="game-scene" class="hidden" style="position:relative;z-index:3">
    <div class="scene-box fade-enter" id="scene-box"></div>
    <div class="psyche-bar-container">
      <div class="psyche-label">
        <span>The Psyche's Journey</span>
        <span id="progress-label">–</span>
      </div>
      <div class="psyche-track">
        <div class="psyche-fill" id="psyche-fill" style="width:4%"></div>
      </div>
    </div>
  </div>

</div>

<script>
// ═══════════════════════════════════════════════════════════
// GAME STATE
// ═══════════════════════════════════════════════════════════

let env = null;
let difficulty = 0; // 0=still, 1=troubled, 2=deep
let stageIndex = 0;
let traits = {};
let choiceHistory = {};
let stageList = [];
let secondaryDefense = null;  // computed once original compromise is established
let crackCause = null;         // set at rupture, shapes the late-game crack

const TRAIT_NAMES = {
  protest:      'Protest', secure_wait: 'Basic Trust', withdraw_early: 'Self-Contained',
  assert:       'Assertive', appease:    'Placating',   burst:          'Impulsive',
  desire_rage:  'Rivalrous',desire_grief:'Mourning',    desire_redirect:'Forward-Oriented',
  identify:     'Identified',ambivalent: 'Ambivalent',
  merge_fear:   'Merger-Averse', self_erase: 'Self-Erasing', hypervigilant: 'Hypervigilant',
  reflect:      'Reflective',    escalate:   'Escalating',   collapse:       'Collapsing',
  reach_out:    'Reaching Out',  self_reliant:'Self-Reliant',
  repair:       'Seeks Repair',  settle:     'Settles',      leave:          'Avoids',
  parent_warm:  'Warm Parent',   parent_law: 'Lawful Parent',parent_lost:    'Lost to Feeling',
  intensify:    'Doubles Down',
};

function addTrait(tag, count=1) {
  if (!tag) return;
  traits[tag] = (traits[tag]||0) + count;
  updateSecondaryDefense();
  renderTraits();
}

function hasTrait(tag) { return (traits[tag]||0) > 0; }
function traitCount(tag) { return traits[tag]||0; }
function dominantTrait(list) {
  return list.reduce((a,b)=> (traits[a]||0)>=(traits[b]||0)?a:b, list[0]);
}

// Secondary defense: the fallback family when the primary is overwhelmed.
// Established once the dominant is clear and a second family has at least 1.
function updateSecondaryDefense() {
  const families = ['protest','secure','avoidant','assertive','reflective'];
  const scores = families.map(f => ({ f, s: familyScore(f) })).sort((a,b) => b.s - a.s);
  if (scores[0].s >= 3 && scores[1].s >= 1 && scores[0].f !== scores[1].f) {
    secondaryDefense = scores[1].f;
  }
}

function renderTraits() {
  const panel = document.getElementById('trait-panel');
  panel.innerHTML = '';
  for (const [k, v] of Object.entries(traits)) {
    if (v <= 0) continue;
    const chip = document.createElement('div');
    chip.className = 'trait-chip';
    chip.textContent = (TRAIT_NAMES[k]||k) + (v > 1 ? ` ×${v}` : '');
    panel.appendChild(chip);
    setTimeout(()=>chip.classList.add('visible'), 50);
  }
}

// ═══════════════════════════════════════════════════════════
// ENVIRONMENT DATA
// ═══════════════════════════════════════════════════════════

const ENVS = {
  enmeshed: {
    name: 'The Warm House',
    color: '#c87a3a',
    motherName: 'Mother',
    fatherName: 'Father',
    motherDesc: 'warm, devoted, sometimes suffocating',
    fatherDesc: 'kind but often absent, emotionally peripheral',
    challenge: 'how to be separate when love feels like merger',
    // Stage modifiers
    texts: {
      birth_context: 'She is there immediately — almost before you need her. The warmth is total.',
      separation_fear: 'Your mother appears before the cry has finished. There is scarcely a gap to learn from.',
      father_presence: 'Your father appears in the evenings, pleasant but slightly peripheral, as if your mother\'s gravitational field leaves little room for him.',
      autonomy_block: 'When you say no, she looks hurt before she looks firm. The no feels dangerous — not because of punishment, but because of what it does to her face.',
      oedipal_rival_soft: 'Your father is gentle. He rarely asserts himself enough to feel like a real obstacle. The triangle has one side that barely resists.',
    }
  },
  cold: {
    name: 'The Orderly House',
    color: '#3a7a8a',
    motherName: 'Mother',
    fatherName: 'Father',
    motherDesc: 'competent, reliable, emotionally reserved',
    fatherDesc: 'present, high-achieving, more comfortable with tasks than feelings',
    challenge: 'how to need when need is met with discomfort',
    texts: {
      birth_context: 'She is there — efficient, calm. You are fed and clean. Whether she is moved is harder to read.',
      separation_fear: 'The gap before she returns is long enough for you to feel it. But she always returns. Reliable if not warm.',
      father_presence: 'Your father is present — physically present, which is more than many can say. He is competent, interested in your progress, uncomfortable with tears.',
      autonomy_block: 'When you say no, there is a calm, firm correction. No drama. No negotiation. The limit is clear. So is the fact that your feeling about it is not particularly interesting to them.',
      oedipal_rival_soft: 'Your father is a clear authority — he commands respect, perhaps even a little awe. The triangle is vivid. He is a real rival and a real model.',
    }
  },
  chaotic: {
    name: 'The Unpredictable House',
    color: '#7a3a8a',
    motherName: 'Mother',
    fatherName: 'Father',
    motherDesc: 'loving when present, sometimes overwhelmed or absent',
    fatherDesc: 'alternately warm and volatile; the axis around which the household tilts',
    challenge: 'how to trust when the ground keeps moving',
    texts: {
      birth_context: 'She holds you tightly. Today the warmth is overwhelming. You will learn that today is not always like today.',
      separation_fear: 'Sometimes she returns quickly. Sometimes the gap is very long. Your body cannot yet learn which kind of wait this will be.',
      father_presence: 'Your father is large — emotionally large. When he is good, the house is warm. When something shifts in him, everything shifts. You become expert at reading his face the moment he enters.',
      autonomy_block: 'When you say no, the response depends entirely on which version of the day this is. Sometimes it is fine. Sometimes the no triggers something much larger. You begin to read the room before speaking.',
      oedipal_rival_soft: 'Your father\'s presence fills the room. He is at once deeply threatening and deeply needed. The triangle is not simple: you fear him and reach toward him at once.',
    }
  }
};

// ═══════════════════════════════════════════════════════════
// STAGES
// Each stage can have:
//   text: string | fn(env, traits) → string
//   choices: array of { text, tag, outcome: fn(env,traits)→string, patternEcho: fn(traits)→string|null }
//   insight: {label, text}
//   echo: fn(traits)→{label,text}|null   (shows if pattern already established)
// ═══════════════════════════════════════════════════════════

function buildStages() {
var stages = [

// ─────────────────────────────────────────────────────────
// STAGE 0 — BIRTH
// ─────────────────────────────────────────────────────────
{
  id: 'birth',
  stageLabel: (e)=>'Birth · Age 0',
  stageGroup: 'Oral Stage',
  title: 'The World Arrives',
  preverbal: true,
  text: (e,t)=>{
    const wordSets = {
      enmeshed: ['Warm.', 'Weight.', 'Breath.', 'Gone.', 'Back.', 'Warm again.', 'Always back.', 'The warmth is everything.', 'Everything is the warmth.'],
      cold:     ['Light.', 'Cold.', 'Handled.', 'Put down.', 'Clean.', 'Quiet.', 'She is there.', 'She is there, but somewhere else too.', 'Both at once.'],
      chaotic:  ['Warm.', 'Gone.', 'Loud.', 'Gone.', 'Warm.', 'Very warm.', 'Then gone again.', 'You do not know what comes next.', 'Neither does the world.']
    };
    const words = wordSets[e] || wordSets.cold;
    const wordsHtml = words.map((w,i)=>`<span class="word" style="animation-delay:${i*0.6}s">${w}</span>`).join(' ');
    const caption = {
      enmeshed: 'A face. Always the same face. Already it is the most important thing that has ever existed.',
      cold:     'A face. Present. Correct. You are fed, held, clean. Whether she is moved — this is harder to read.',
      chaotic:  'A face. Sometimes everything. Sometimes not there. Already you are learning to read which one is coming.'
    }[e];
    return `<div class="preverbal-text">${wordsHtml}</div>
      <div style="font-family:'Cormorant Garamond',serif;font-size:1rem;line-height:2;color:rgba(240,232,216,0.65);font-style:italic;text-align:center;margin-top:20px;padding:0 16px">
        ${caption}<br><br>
        <span style="font-size:0.92rem;opacity:0.78;letter-spacing:0.05em">There are no words yet. There is only what the body knows.</span>
      </div>`;
  },
  insight: { school: 'Object Relations · Winnicott / Bion', label: 'The Face as First Mirror', text: 'Winnicott wrote: "When I look I am seen, so I exist." The caregiver\'s face is the infant\'s first mirror — how she looks at you begins to constitute what you are. Bion described the mother\'s task as "containing" the infant\'s overwhelming proto-emotions: metabolising them through her own psyche and returning them in bearable form. The infant who is well-contained learns that experience can be processed. The infant who is not learns that experience is something to be survived alone.' },
  type: 'narrative',
  buttonText: 'Enter the world'
},

// ─────────────────────────────────────────────────────────
// ─────────────────────────────────────────────────────────
// STAGE 1 — FIRST SEPARATION (3–6 months)
// Pre-verbal: body-language choices, no full sentences in prompt
// ─────────────────────────────────────────────────────────
{
  id: 'separation_1',
  stageLabel: ()=>'Oral Stage · 3–6 months',
  stageGroup: 'Oral Stage',
  title: 'The First Absence',
  preverbal: true,
  text: (e,t)=>{
    const scene = {
      enmeshed: 'She leaves the room.<br><br>A second. Two seconds.<br><br><em>An enormous amount of time.</em><br><br>The warmth that organised the world is no longer here. What remains is the room — and something rising in the chest that has no name yet.',
      cold:     'She leaves the room.<br><br>The gap opens.<br><br>It stays open long enough to feel. Long enough for the body to register: she was here, and now she is not. The world is reliable — she will return — but the gap is real.<br><br><em>The gap is information.</em>',
      chaotic:  'She leaves the room.<br><br>Sometimes she comes back quickly. Sometimes not.<br><br>The body is already calculating: <em>which kind of absence is this?</em><br><br>There is no way to know yet. The not-knowing is its own kind of weight.'
    }[e];
    return `<div style="font-family:'Cormorant Garamond',serif;font-size:1.12rem;line-height:2.4;color:rgba(240,232,216,0.82);font-style:italic;text-align:center;padding:8px 16px">${scene}</div>`;
  },
  insight: { school: 'Object Relations · Winnicott', label: 'The Gap That Teaches', text: 'Winnicott\'s "good enough mother" is one who is responsive but not perfectly so — because the gap teaches the infant that absence is survivable. Too little gap and the infant never learns to self-soothe. Too much and the nervous system is overwhelmed before it can integrate the experience. The quality of early waiting — how the infant metabolises absence — shapes the nervous system\'s default orientation toward others for decades.' },
  type: 'choice',
  prompt: (e,t)=>'The absence stretches. Your body does something — not a decision, not yet. Something more like weather.',
  choices: [
    {
      text: 'The cry comes — immediately, urgently, as if the sound itself will bring her back',
      tag: 'protest',
      outcome: (e,t)=> {
        const result = {
          enmeshed: 'She appears before the cry has reached its full pitch. Breathless, apologetic. <em>The world has answered. The voice works.</em> You file this away in the body: urgency produces return.',
          cold:     'There is a pause before she comes — enough of one that the cry earns its response. She arrives calm, efficient. The voice worked, but it had to hold its ground first.',
          chaotic:  'Sometimes the cry brings her immediately. Sometimes it does not. The cry grows louder, more searching, tuning itself to the uncertainty. <em>You are already learning to calibrate your distress to an unreliable world.</em>'
        }[e];
        return result;
      },
      patternEcho: null
    },
    {
      text: 'A stillness — watchful, held, as if conserving something for later',
      tag: 'secure_wait',
      outcome: (e,t)=> {
        const result = {
          enmeshed: 'She returns almost before the wait has registered. The waiting barely had time to be waiting. <em>Something quiet is laid down: the world returns. Perhaps too quickly to fully learn it.</em>',
          cold:     'The wait is real, long enough to be felt. She comes. Something load-bearing is built: the world is, on balance, reliable. <em>This will serve you for a long time.</em>',
          chaotic:  'She returns — this time. The wait taught something. But the next wait may teach something different. <em>You are composing a more complex score than simple trust.</em>'
        }[e];
        return result;
      },
      patternEcho: null
    },
    {
      text: 'You turn — toward the wall, toward your own hand, inward away from the gap',
      tag: 'withdraw_early',
      outcome: (e,t)=> {
        const result = {
          enmeshed: 'She returns to find you turned away and is distressed by it — perhaps more than you are. The withdrawal has a strange power here: it pulls her closer. <em>The body is already learning: absence can summon.</em>',
          cold:     'You turn to your own sounds, your own hands. When she returns, you receive her without display. She approves of this — it looks like composure. <em>In a sense, it already is.</em>',
          chaotic:  'The inward turn is a form of self-protection. In an unreliable world, needing less is safety. <em>You are becoming, even now, harder to reach than your age should allow.</em>'
        }[e];
        return result;
      },
      patternEcho: null
    }
  ]
},

// ─────────────────────────────────────────────────────────
{
  id: 'trust_builds',
  stageLabel: ()=>'Oral Stage · 6–18 months',
  stageGroup: 'Oral Stage',
  title: 'What the Body Learns',
  text: (e,t)=>{
    const style = dominantTrait(['protest','secure_wait','withdraw_early']);
    const styleText = {
      protest: 'You have learned that the world responds to the urgent voice. The louder the expression, the more reliably the gap is closed. This is not manipulation — it is empiricism. The infant runs experiments, and yours have returned a consistent result.',
      secure_wait: 'You have learned to wait with something that resembles patience — not passivity, but a quiet faith that the gap will close. This will serve you for a long time.',
      withdraw_early: 'You have learned to manage the gap from within. Need has already begun to go quiet, turning inward rather than outward. You are becoming self-sufficient earlier than is perhaps ideal.'
    }[style] || 'A pattern is beginning to form — the body\'s first hypothesis about how the world works.';

    const envText = {
      enmeshed: `In the Warm House, the overall lesson is: <em>the world is full of love, and love is very close.</em> Perhaps so close that a self is hard to find within it.`,
      cold: `In the Orderly House, the overall lesson is: <em>the world is reliable, but its reliability is not the same as warmth.</em> You are learning to meet reliability with reliability — which is its own kind of competence.`,
      chaotic: `In the Unpredictable House, the overall lesson is: <em>the world is real, love is real, but neither is guaranteed.</em> Your nervous system is becoming an instrument finely tuned to read ambient signals.`
    }[e];
    return `${styleText}<br><br>${envText}<br><br>
Erikson called this stage's central question: <em>basic trust versus basic mistrust</em>. The answer is never simply one or the other — it is a ratio, a tilt, a lean. And that lean will whisper beneath every relationship you later form, like a bass note you will mostly be unaware of.`;
  },
  insight: { label: 'Psychoanalytic Note', text: 'The internal working model — the implicit template of what relationships are like — is established in this period. Secure attachment forms when the caregiver is reliable enough, warm enough, present enough. Anxious attachment when presence is unpredictable. Avoidant attachment when emotional bids are consistently unmet. These are not destinies but defaults — the first draft, not the final version.' },
  type: 'narrative',
  buttonText: 'Grow older'
},

// ─────────────────────────────────────────────────────────
// STAGE 3 — AUTONOMY (Age 2)
// ─────────────────────────────────────────────────────────
{
  id: 'autonomy',
  stageLabel: ()=>'Anal Stage · Age 2',
  stageGroup: 'Anal Stage',
  title: 'The Will Awakens',
  text: (e,t)=>`You are two. Something seismic has occurred: you have discovered that <em>you</em> exist separately, and that this separate self can say <em>No</em>.<br><br>
The word arrives with shocking power. You say it to the spoon. You say it to the coat. You say it sometimes simply to feel the force of your own will meet the resistance of the world. This is not defiance — it is the first rough draft of selfhood.<br><br>
<em>${ENVS[e].texts.autonomy_block}</em>`,
  echo: (t)=>{
    if (hasTrait('protest')) return { label: 'Pattern Already in Motion', text: 'The same urgency that drove your early cry is in the No too. The body knows only one volume for protest.' };
    if (hasTrait('withdraw_early')) return { label: 'Pattern Already in Motion', text: 'Even the No is quiet. It comes out sideways — as sulking, as refusal to engage — rather than as declaration. The inward turn has a new shape.' };
    return null;
  },
  insight: { label: 'Psychoanalytic Note', text: 'Freud\'s "anal stage" is misnamed for modern ears — it is fundamentally about the emergence of autonomous will and the dialectic between control and surrender, assertion and compliance. The healthy outcome is neither total submission nor pure willfulness, but the ability to assert one\'s own wants while remaining in relationship — what Winnicott called "the capacity to be alone in the presence of another."' },
  type: 'choice',
  prompt: `It is time to come inside. You are not ready.`,
  choices: [
    {
      text: 'You assert yourself clearly — you say No, firmly, and hold your ground',
      tag: 'assert',
      outcome: (e,t)=> {
        if (e==='enmeshed') return 'The assertion lands heavily. She looks wounded, then anxious, then overrides you with a flood of warmth and gentle pressure. The No worked physically — you stayed outside another minute — but it cost something in the emotional temperature. <em>You learn: self-assertion here has a relational price.</em>';
        if (e==='cold') return 'There is a moment of genuine standoff. Then a calm, firm repetition of the expectation. You comply, but with dignity — you made your position known. <em>You learn: assertion is met with counter-assertion, not warmth, but it is taken seriously.</em>';
        return 'The response is unpredictable — today it is fine; yesterday it would have ignited something larger. You cannot quite decode the rules. <em>You learn: assertion is a gamble, the outcome depends on the day.</em>';
      },
      patternEcho: (t)=> hasTrait('protest') ? 'You have been protesting since the first absence. The form is more sophisticated now; the function is the same.' : null
    },
    {
      text: 'You negotiate — "five more minutes?" — testing whether desire can be spoken',
      tag: 'assert',
      outcome: (e,t)=> {
        if (e==='enmeshed') return 'She brightens at the negotiation — it keeps you in dialogue, which she prefers. She gives you ten minutes. The relationship has solved the problem. <em>You learn: speech, directed toward her, is the most powerful tool.</em>';
        if (e==='cold') return 'She considers the request briefly, then concedes a compromise. The negotiation was treated as a reasonable bid. <em>You learn: rational articulation of desire is effective. Keep the feeling out of it; name what you want.</em>';
        return 'It depends entirely on which parent is asking and what kind of day it is. Sometimes the negotiation works beautifully. Other times it is ignored as if you hadn\'t spoken. <em>You learn: speak up, but don\'t rely on being heard.</em>';
      },
      patternEcho: (t)=> hasTrait('secure_wait') ? 'The same measured quality that marked your early waiting is here in the negotiation. You instinctively find the middle register.' : null
    },
    {
      text: 'You go in — the relationship matters more than the argument, and you know how to let things go',
      tag: 'appease',
      outcome: (e,t)=> {
        if (e==='enmeshed') return 'She is pleased, relieved — the harmony is intact. But somewhere in you, the unexpressed No settles like sediment. <em>You learn: compliance preserves warmth. And the self learns to be quiet about what it wants.</em>';
        if (e==='cold') return 'The compliance is unremarkable — as expected. No particular warmth is offered in exchange, but no rupture occurs either. <em>You learn: compliance is safe and invisible. The cost is that you, too, become a little invisible.</em>';
        return 'Compliance is the safest move today. The No, unexpressed, does not risk igniting anything. <em>You learn: read the room first, want second.</em>';
      },
      patternEcho: (t)=> hasTrait('withdraw_early') ? 'The inward turn you learned as an infant has a behavioral form now: you fold, you comply, you go quiet. The pattern completes itself.' : null
    }
  ]
},

// ─────────────────────────────────────────────────────────
// STAGE 4 — THE FATHER ENTERS (Age 3)
// ─────────────────────────────────────────────────────────
{
  id: 'father_enters',
  stageLabel: ()=>'Phallic Stage · Age 3',
  stageGroup: 'Phallic Stage',
  title: 'The Third',
  text: (e,t)=>`You are three. There are words now, and stories, and a sense of yourself as a character in a world with other characters.<br><br>
And there is, with new sharpness, a <em>triangle</em>.<br><br>
<em>${ENVS[e].texts.father_presence}</em><br><br>
Something about this arrangement troubles you in a way you cannot articulate. He and she share something — a language, a look, a bed — from which you are excluded. You want to be the centre of her world entirely. You remember, dimly, that you almost were.<br><br>
The rival has arrived. And he is also — somehow — the one you most want to become.`,
  insight: { label: 'Psychoanalytic Note', text: 'Lacan\'s concept of the "Name-of-the-Father" extends Freud here: the father (or the third term — it need not be a literal father) represents the principle of limit, of "not everything can be had." The triangle is constitutive of desire itself: we want most acutely what is partially withheld. The father\'s role is not primarily to threaten but to introduce the child to the reality of desire\'s structure.' },
  type: 'narrative',
  buttonText: 'Face the triangle'
},

// ─────────────────────────────────────────────────────────
// STAGE 5 — THE DESIRE (Age 3–4)
// ─────────────────────────────────────────────────────────
{
  id: 'desire',
  stageLabel: ()=>'Phallic Stage · Age 3–4',
  stageGroup: 'Phallic Stage',
  title: 'The Wanting',
  text: (e,t)=>`You make an announcement one evening — with total, unself-conscious certainty — that you are going to marry your mother when you grow up.<br><br>
The adults exchange a look. Something passes between them that you cannot decode. Your father's expression changes — slightly, briefly — but the change registers.<br><br>
This declaration was not simply naive. It expressed something real and important: the desire to be everything to someone, to restore the total possession of the earliest months, to eliminate the rival and be restored to the centre.<br><br>
It also, for the first time, put you in direct conflict with someone larger.`,
  echo: (t)=>{
    if (hasTrait('appease')) return { label: 'Pattern in Motion', text: 'Even as you made the announcement, some part of you was watching the room. The declaration was bold, but its aftermath will be shaped by what you have already learned about the cost of assertion.' };
    if (hasTrait('protest')) return { label: 'Pattern in Motion', text: 'The urgency of the desire is familiar — it has the same quality as the cry, the same intensity, the same certainty that the feeling must be expressed.' };
    return null;
  },
  insight: { label: 'Psychoanalytic Note', text: 'The Oedipal desire is universal — not because all children literally want to marry a parent, but because all children must navigate the first experience of desire meeting prohibition, of wanting what cannot be had, of a third party who embodies the limit. What the child does with this experience — how the desire is handled, metabolised, and redirected — shapes the basic structure of adult wanting.' },
  type: 'choice',
  prompt: `Your father has corrected you. The something-you-wanted is no longer available. Something in you responds.`,
  choices: [
    {
      text: 'As a fierce feeling — something large and hot that does not wait for words',
      tag: 'desire_rage',
      outcome: (e,t)=> {
        if (e==='enmeshed') return 'Your mother looks alarmed. Your father, uncertain. The rage fills the room, and the room is not sure what to do with it. <em>The anger is real — and it is not punished, exactly, but it creates a ripple. The mother moves to soothe. The father steps back. The triangle bends under the force of your feeling.</em>';
        if (e==='cold') return 'Your father addresses the rage calmly and firmly. He names it, contains it, redirects it. The rage is not met with rage — but it is not welcomed either. <em>You learn that large feelings produce a kind of controlled alarm in others. They are managed, not received.</em>';
        return 'Your father\'s response to your rage depends on what is happening inside him. Today it is handled. Another day it might ignite something in return. <em>You learn that your rage is powerful — and that its power is unpredictable.</em>';
      },
      patternEcho: (t)=> hasTrait('protest') ? 'The rage has the same quality as your earliest cry — full, urgent, total. The form has changed; the function is identical.' : null
    },
    {
      text: 'As something that quietens you — a weight that makes you go still',
      tag: 'desire_grief',
      outcome: (e,t)=> {
        if (e==='enmeshed') return 'Your mother is moved by the grief and gathers you up. Your father watches. The grief, here, is effective — it produces closeness, it produces tenderness. <em>You learn: sadness opens arms. This will be remembered.</em>';
        if (e==='cold') return 'The grief is met with gentle practicality. You are comforted, briefly, and then redirected. <em>You learn: sadness is acknowledged but not dwelt in. There is something after sadness, and the adults want you to move there quickly.</em>';
        return 'Your grief lands differently depending on the day. Sometimes it produces real tenderness, a moment of genuine closeness. Sometimes it seems to overwhelm the household and produce anxiety rather than comfort. <em>Your feeling is real; its reception is unreliable.</em>';
      },
      patternEcho: (t)=> hasTrait('withdraw_early') ? 'The grief is quiet, turned inward. Not a cry, but a stillness. The same inward movement, in a new register.' : null
    },
    {
      text: 'As a question — if not this, then what? The feeling moves toward something else',
      tag: 'desire_redirect',
      outcome: (e,t)=> `The question hangs in you like something beginning. <em>If not now, then someday. If not her, then someone.</em> The desire does not die — it picks up its things and begins to look for somewhere else to live. This is precisely what culture needs desire to do. ${e==='cold' ? 'Your parents look pleased, almost proud. The rational, forward-oriented response is the one they understand best.' : e==='enmeshed' ? 'Your mother watches this redirection with something complicated — relief, and perhaps a small, unacknowledged flicker of loss.' : 'The curiosity gives the situation somewhere to go, which is a relief in a household where emotions often have nowhere to go.'}`,
      patternEcho: (t)=> hasTrait('secure_wait') ? 'The same forward patience that marked your waiting is in this curiosity. You look toward what will be, rather than collapsing into what cannot be.' : null
    }
  ]
},

// ─────────────────────────────────────────────────────────
// STAGE 6 — CASTRATION ANXIETY / THE LAW (Age 4–5)
// ─────────────────────────────────────────────────────────
{
  id: 'the_law',
  stageLabel: ()=>'Phallic Stage · Age 4–5',
  stageGroup: 'Phallic Stage',
  title: 'The Prohibition',
  text: (e,t)=>{
    const envColor = {
      enmeshed: 'The law arrives not as thunder but as the slow accumulation of a thousand small moments: the look on your mother\'s face when you try to climb between your parents in the morning. The way she gently but consistently sends you back to your own bed. The way your father\'s presence makes certain things simply unavailable, as if by atmospheric pressure rather than rule.',
      cold: 'The law is clear here — almost explicit. The rules of the household are well-defined. You are the child; they are the parents. There are places you do not go, things you do not touch, moments that are not yours. The prohibition is delivered without cruelty, but also without ambiguity.',
      chaotic: 'The law is inconsistent — sometimes rigorously enforced, sometimes ignored. This inconsistency is its own kind of message: that the prohibition is real, but its application depends on forces outside your control. You become an expert in reading when the law is active and when it is dormant.'
    }[e];
    return `Something happens that is very hard to put into rational terms because it does not live there.<br><br>
The child begins to sense — through glances, tones, the texture of adults' reactions — that the desire for the primary caregiver is not just unattainable but <em>forbidden</em>. Not "not allowed" like touching the stove, but something heavier. A law that seems older than any rule.<br><br>
<em>${envColor}</em><br><br>
Freud called the dread accompanying this recognition <em>castration anxiety</em> — the wordless terror that pursuing the forbidden desire would cost something irreplaceable. The language is anatomical, but the experience is existential: the fear of being unmade.`;
  },
  insight: { label: 'Psychoanalytic Note', text: 'The superego — the internalized authority — is built from this moment outward. The external prohibition becomes an internal voice; the father\'s law becomes one\'s own conscience. This process is never clean: the superego always retains the harshness, the irrationality, the absolutism of the original prohibition. "The superego," Freud wrote, "does not merely say \'do not do this\' — it says \'you should not want to do this.\'"' },
  type: 'narrative',
  buttonText: 'Accept the limit'
},

// ─────────────────────────────────────────────────────────
// ─────────────────────────────────────────────────────────
// STAGE 6b — THE AMBIVALENCE (Age 4–5)
// Klein's depressive position: love and hate toward same object
// ─────────────────────────────────────────────────────────
{
  id: 'ambivalence',
  stageLabel: ()=>'Phallic Stage · Age 4–5',
  stageGroup: 'Phallic Stage',
  title: 'Both at Once',
  text: (e,t)=>{
    const envSuffix = {
      enmeshed: 'In the Warm House, the hate is particularly hard to hold. The mother who is loved so intensely becomes terrifying when she also frustrates — the gap between adoration and rage is vertiginous. To hate her even briefly feels like it will destroy everything.',
      cold:     'In the Orderly House, the ambivalence is managed through splitting — the parent is either entirely competent (good) or entirely disappointing (bad). That they could be both at once, simultaneously, is harder to hold.',
      chaotic:  'In the Unpredictable House, the same parent actually does alternate between warm and frightening. The ambivalence mirrors reality here — but the reality does not make the feeling easier to bear.'
    }[e];
    return `Something happens. Something small — a refusal, a scolding, an ordinary frustration — and for a moment you feel something toward the parent you love most that you have never consciously felt before.<br><br>
<em>You hate her.</em><br><br>
Not instead of loving her. <em>At the same time as loving her.</em><br><br>
<div class="ambivalence-split">
  <div class="ambivalence-side ambivalence-love">She is warm. She is everything. You would do anything for her. The love is total.</div>
  <div class="ambivalence-side ambivalence-hate">She has refused you something. She has her own life. She has turned away at the wrong moment. The hate is real.</div>
</div>
Klein called this the <em>depressive position</em> — not depression exactly, but the developmental achievement of tolerating that the good object and the bad object are the <em>same</em> object. That the person you love is also capable of frustrating you, and that this does not make them a different person. That you can feel both at once and survive it.<br><br>
<em>${envSuffix}</em>`;
  },
  insight: { school: 'Kleinian · Depressive Position', label: 'Love and Hate Toward the Same Object', text: 'Klein identified two fundamental positions of the psyche. The paranoid-schizoid position splits objects into entirely good or entirely bad — this is the infant\'s earliest mode and remains available under pressure. The depressive position is the developmental achievement of tolerating ambivalence: the recognition that the loved object is also frustrating, that one has wished harm on someone loved, and that this harm has not actually occurred. The guilt of this recognition — and the wish to repair — is the foundation of mature morality and genuine love.' },
  type: 'choice',
  prompt: (e,t)=>'The feeling is there — and underneath it, another feeling that does not fit. What do you do with the one that does not fit?',
  choices: [
    {
      text: 'You hold onto the love — the other feeling does not belong here, it is not really you',
      tag: 'appease',
      outcome: (e,t)=>`The splitting is complete. The hate goes somewhere — not away, exactly, but underground. The good parent remains good; the bad feeling is kept separate. <em>This protects the relationship in the short term. In the long term, the hate will find other objects to land on — strangers, rivals, yourself — because it cannot be directed at the one it belongs to.</em><br><br>${e==='enmeshed' ? 'In the Warm House, this splitting is almost demanded. The mother\'s love is so total that hating her feels like existential betrayal.' : e==='cold' ? 'In the Orderly House, the split is tidy. Negative feeling is redirected. Everybody\'s more comfortable.' : 'In the Unpredictable House, the split is sometimes disrupted by reality — when she is actually frightening, the hate surfaces regardless.'}`,
      patternEcho: (t)=> hasTrait('appease') ? 'The compliance you showed at two — folding the bad feeling away — runs here again. The original compromise: love without the hate, harmony without the full truth.' : null
    },
    {
      text: 'You stay inside both feelings — neither one cancels the other, though you wish it would',
      tag: 'reflect',
      outcome: (e,t)=>`What you are doing — without knowing it — is one of the hardest things the psyche ever does.<br><br>Both feelings remain. Neither annihilates the other. The parent is still the parent — still loved, still the source of warmth and frustration in equal measure. <em>The world becomes, very slightly, more real.</em><br><br>Guilt arrives too — the guilt of the hate, the wish to repair. You go toward her with something that might be a hug, or a drawing, or simply staying close. <em>This is reparation. Klein thought it was the beginning of genuine love — love that knows what it loves, without needing it to be perfect.</em>`,
      patternEcho: null
    },
    {
      text: 'You must have done something to produce this feeling — the fault is somewhere in you',
      tag: 'self_erase',
      outcome: (e,t)=>`Rather than holding the hate outward — where it belongs, directed at the person who frustrated you — it curves back. <em>You must be the problem. The feeling is yours, the fault is yours, the wrongness is yours.</em><br><br>This protects the parent at the cost of the self. The loved object remains good and untouched; the hate is converted into self-criticism. It feels safer this way. It will become a habit.<br><br>${e==='enmeshed' ? 'In the Warm House, this move is rewarded — the mother\'s love for you is restored when you stop being the difficult one.' : e==='cold' ? 'In the Orderly House, there is nobody to notice this internal manoeuvre. It becomes increasingly automatic and invisible.' : 'In the Unpredictable House, turning the hate inward is adaptive — external expression is too risky. The self absorbs what the world cannot hold.'}`,
      patternEcho: (t)=> hasTrait('withdraw_early') ? 'The early inward turn now carries this additional weight: not just managing need, but absorbing blame.' : null
    }
  ]
},

// ─────────────────────────────────────────────────────────
// STAGE 6c — THE SUPEREGO ARRIVES (Age 5)
// The prohibition becomes internal — a voice, not just a rule
// ─────────────────────────────────────────────────────────
{
  id: 'superego',
  stageLabel: ()=>'Phallic Stage · Age 5',
  stageGroup: 'Oedipal Resolution',
  title: 'The Voice That Stays',
  text: (e,t)=>{
    const voice = {
      enmeshed: '"You should not want what you want. Wanting it is selfish. If you loved her properly, you would not want her all to yourself."',
      cold:     '"You want too much. You are too loud, too needy, too much. The appropriate amount is less. Much less."',
      chaotic:  '"You never know what you are doing. You do not know what is allowed. You are always about to do the wrong thing."'
    }[e];
    const source = {
      enmeshed: 'It does not come from her — not exactly. It comes from what you imagine she would feel if she fully knew you.',
      cold:     'It does not come from them — not exactly. It comes from the gap between what you are and what the house seems to require.',
      chaotic:  'It does not come from a single source. It is assembled from every moment you could not read the room in time.'
    }[e];
    return `Something that began outside is now inside.<br><br>
The prohibition — the law, the limit — has crossed a threshold. It is no longer something that might happen if you transgress. It is a <em>voice</em>. An internal voice that sounds, uncannily, like the authority figures in your life, but harsher. More absolute. Less interested in context or explanation.<br><br>
<div class="superego-voice"><span class="superego-label">The Inner Critic — first appearance</span>${voice}</div><br>
<em>${source}</em><br><br>
Freud noted that the superego is always more savage than any actual parent — because it is not formed from the parent\'s real responses but from the child\'s <em>fantasy</em> of what would happen if the forbidden desire were fully known. The superego is the part that says not just <em>do not do this</em> but <em>you should not even want this</em>.`;
  },
  insight: { school: 'Freudian · Superego Formation', label: 'The Internal Critic', text: 'The superego is the psychic precipitate of the Oedipal resolution — the internalised voice of authority that monitors, criticises, and punishes. Freud emphasised its cruelty: it judges by a more exacting standard than any real parent ever applied, because it is formed from the child\'s terror of punishment rather than from the punishment itself. The harshness of an individual\'s superego often has little relationship to how actually punitive their parents were.' },
  type: 'choice',
  prompt: (e,t)=>{
    const p = {
      enmeshed: 'You have done something small and ordinary — taken an extra biscuit, told a small lie, wanted something that is not yours. The voice is already there, louder than the act deserves. How do you relate to it?',
      cold:     'You have fallen short of a standard — a minor failure, a small mistake. The voice is already cataloguing it, enlarging it, making it evidence of something fundamental. How do you meet it?',
      chaotic:  'You are not sure you have done anything wrong. But the voice is there regardless — certain you have, certain it is serious. How do you respond to it?'
    }[e];
    return p;
  },
  choices: [
    {
      text: 'The voice is right — there must be something wrong with you to have done this',
      tag: 'collapse',
      outcome: (e,t)=>`The voice is taken as truth. The self-criticism is accepted wholesale — not questioned, not contextualised, simply absorbed as accurate. <em>The superego has won its first complete victory.</em><br><br>This will repeat. Each time the voice speaks, it will be met with this same total acceptance. Over years, this becomes a particular kind of pain — a persistent background conviction of one\'s own wrongness that no external achievement can quite touch.<br><br>${e==='cold' ? 'In the Orderly House, the perfectionism that produces this is praised as high standards. The self-criticism is invisible as suffering.' : e==='enmeshed' ? 'In the Warm House, the guilt is so woven into the love that separating them becomes difficult. To feel guilty is to feel connected.' : 'In the Unpredictable House, the self-blame at least provides an explanation — if it is your fault, the world is still legible.'}`,
      patternEcho: (t)=> hasTrait('appease') || hasTrait('self_erase') ? 'The compliance, the self-erasure, and now the self-condemnation — these are three forms of the same original move: making yourself the problem so the relationship survives.' : null
    },
    {
      text: 'Something resists — this verdict does not match the evidence as you understand it',
      tag: 'assert',
      outcome: (e,t)=>`The voice meets resistance. Not a perfect counter — there is still guilt, still a sting — but something in you does not accept the verdict entirely. <em>You push back.</em><br><br>This is harder than it sounds. The superego has all the authority of the parent, amplified. But the pushback is real and important: it is the beginning of a self that can evaluate its own moral status rather than simply receive a judgment.<br><br>${e==='cold' ? 'In the Orderly House, the inner argument has the quality of a disciplined debate. You are learning to apply the same standards to the voice as to everything else.' : 'The argument does not always win. But it continues. And that continuance is itself a kind of integrity.'}`,
      patternEcho: (t)=> hasTrait('assert') ? 'The same directness that appeared at age two — the refusal to simply comply — is directed inward. You will not accept a verdict you have not examined.' : null
    },
    {
      text: 'You notice the voice as a voice — it is there, it is saying something, but you are separate from it',
      tag: 'reflect',
      outcome: (e,t)=>`Something unusual happens: you notice the voice <em>as a voice</em>. Not as truth, not as a target to argue with — as a phenomenon. It is loud. It is disproportionate. It has a particular quality — a tone that reminds you of something, someone, some repeated experience.<br><br><em>The distance between you and the voice is not large. But it is something.</em><br><br>This observing capacity — the ability to hear the superego without being entirely captured by it — is one of the things psychoanalysis tries to cultivate in adults. You are doing it, imperfectly, at age five.`,
      patternEcho: (t)=> hasTrait('reflect') ? 'The watching quality that has been present since your earliest choices is turning inward — watching the watcher now, or at least the voice that claims to watch.' : null
    }
  ]
},

// STAGE 7 — IDENTIFICATION (Age 5)
// ─────────────────────────────────────────────────────────
{
  id: 'identification',
  stageLabel: ()=>'Phallic Stage · Age 5',
  stageGroup: 'Oedipal Resolution',
  title: 'If You Cannot Have, Become',
  text: (e,t)=>`Unable to have what the father has, the psyche performs one of its most remarkable operations: it begins to <em>become</em> him.<br><br>
Not consciously. Not deliberately. But the child starts imitating his walk, wanting to know what he knows, watching how he moves through the world. The rivalry is being metabolised into aspiration. The aggression is becoming admiration.<br><br>
<em>${{
  enmeshed: 'In the Warm House, this turn toward the father is also a turn away from total merger with the mother — a developmental necessity that is slightly tinged with disloyalty. As you begin to identify with your father, your mother watches, complicated.',
  cold: 'In the Orderly House, the father is a clear template: competent, controlled, emotionally reserved. Identification means learning to be effective, to achieve, to manage feeling rather than express it. There is much to admire and something to lose.',
  chaotic: 'In the Unpredictable House, identification is complicated by the father\'s unpredictability. You want to be like him when he is good — warm, funny, large. You do not want to be like him when he is frightening. The identification is partial, selective, effortful.'
}[e]}</em>`,
  echo: (t)=>{
    if (hasTrait('desire_rage')) return { label: 'Pattern in Motion', text: 'The rage toward the father is transforming. The same heat that was opposition is becoming fuel for something else — wanting what he has, wanting to do what he does. Rivalry and admiration have always been closer than they appear.' };
    return null;
  },
  insight: { label: 'Psychoanalytic Note', text: 'Identification with the same-sex parent is the engine of cultural transmission. By taking on the father\'s values, prohibitions, and ideals, the child joins the symbolic order — enters culture, history, language as a full participant. The superego is essentially a portrait of the father\'s moral universe hung on the walls of the inner life.' },
  type: 'choice',
  prompt: `Your father is occupied with something. He pauses. Looks at you. An opening — though what kind of opening, you are not entirely sure.`,
  choices: [
    {
      text: 'You step in — this is what you have wanted, to be alongside him like this',
      tag: 'identify',
      outcome: (e,t)=> {
        if (e==='enmeshed') return 'You lean toward him. Your mother watches from the doorway with a complicated expression. Something is shifting — you are moving toward him, which means, fractionally, away from her. This is exactly right, and it does not feel entirely comfortable for anyone. <em>The identification is working.</em>';
        if (e==='cold') return 'He teaches methodically. You absorb. There is a quality of connection in this room — not warm exactly, but real. Something is being transmitted: competence, patience, the ability to focus on a problem. <em>You are becoming a version of him, and this version is capable.</em>';
        return 'You step in quickly, before the invitation can be withdrawn — you have learned not to hesitate when warmth is offered. He is good today. The good version of him is someone you want very much to become. <em>You hold onto this version of him carefully.</em>';
      },
      patternEcho: (t)=> hasTrait('desire_redirect') ? 'The forward-orientation of your desire finds its clearest expression here. He is what you can become. This is the desire redirected.' : null
    },
    {
      text: 'You take a moment — then step forward. The offer is real and worth something',
      tag: 'ambivalent',
      outcome: (e,t)=> {
        if (e==='enmeshed') return 'You step forward eventually, but with caution. The ambivalence between wanting his world and wanting to stay in your mother\'s is still unresolved. <em>The identification is happening, but it carries complexity. Both pulls are real.</em>';
        if (e==='cold') return 'He waits. The patience here is reliable — he will not withdraw the invitation. Eventually you step in. <em>The ambivalence is noted, not commented upon. You are allowed to arrive slowly.</em>';
        return 'The hesitation is wise in this household. You assess him first — is today a day where stepping in is safe? It seems to be. You approach. <em>The identification is real, but it is also measured, earned moment by moment.</em>';
      },
      patternEcho: (t)=> hasTrait('appease') ? 'Even the ambivalence is cautious — you are managing the relationship rather than entering it freely. Old habits.' : null
    },
    {
      text: 'You stay close — watching, absorbing. Near enough to be part of it, far enough to have the choice',
      tag: 'ambivalent',
      outcome: (e,t)=> `You are close but not in. You watch, you absorb, but you preserve the option to retreat. <em>${e==='chaotic' ? 'In this household, proximity without commitment is a sophisticated strategy — you get the warmth without the risk. It will serve you well here. In other environments, later, it will look like half-heartedness.' : 'There is something to learn here even at this distance. But the full gift of the encounter — being taken in, taught, made into something — is held at bay.'}</em>`,
      patternEcho: (t)=> hasTrait('withdraw_early') ? 'The early inward turn is still operating. You are present — which is more than before — but not all the way in. The self keeps something back.' : null
    }
  ]
},

// ─────────────────────────────────────────────────────────
// STAGE 8 — PATTERN REFLECTION (Age 5–6)
// ─────────────────────────────────────────────────────────
{
  id: 'pattern_reflection_1',
  stageLabel: ()=>'Oedipal Resolution · Age 5–6',
  stageGroup: 'Oedipal Resolution',
  title: 'The First Default',
  text: (e,t)=>{
    const dominant = dominantTrait(['protest','secure_wait','withdraw_early','appease','assert','identify','ambivalent']);
    const descMap = {
      protest: 'When something is wrong, you make it known — immediately, fully, with the whole volume of yourself. This is your first solution. You have used it for crying, for tantrums, for the rage of being displaced. It <em>works</em> — most of the time, in the ways that mattered most to you. It has become your default.',
      secure_wait: 'You have learned to wait with something resembling trust — that the gap will close, that the other will return, that your needs can be held a moment before they are met. This is your first solution. Quiet, load-bearing, reliable.',
      withdraw_early: 'When it is uncertain or painful, you have learned to turn inward. To need less, to go quiet, to find what you need in yourself rather than risk the uncertainty of the other. This is your first solution — self-sufficiency as protection.',
      appease: 'You have learned to read what is wanted and move toward it. To fold the self\'s wants inward when they conflict with the room\'s temperature. To keep the peace, preserve the connection. This is your first solution.',
      assert: 'You have learned to name what you want, negotiate for it, hold your ground — at least somewhat. This is your first solution: the self has a voice and uses it.',
      identify: 'You have learned to admire and emulate. The rival becomes the teacher. The desire to possess is transformed into the desire to become. This is your first solution — aspiration.',
      ambivalent: 'You have learned to be in two places at once — partly in, partly out; partly wanting, partly holding back. The ambivalence is not weakness; it is a form of complexity. It is your first solution to an impossible situation.'
    };
    const desc = descMap[dominant] || 'A pattern is taking shape — your signature response to difficulty and desire.';

    return `${desc}<br><br>
You are five years old, and you already have a default. Not consciously — you could not name it. But the body knows. The nervous system has run enough experiments to have preferences, tendencies, a characteristic way of moving through the world.<br><br>
<em>This default was learned here, in this house, in response to these specific conditions. It was the right answer for this environment. The question that the rest of your life will ask is: when the environment changes, will the answer change with it?</em>`;
  },
  insight: { label: 'Psychoanalytic Note', text: 'Character — in the psychoanalytic sense — is the set of ego defenses and relational strategies that became automatic because they once worked. The problem is not that we develop character. The problem is that character tends to be applied indiscriminately, regardless of whether the current situation resembles the original one that produced it. The work of analysis is to create space between the situation and the response — to make the automatic slightly less automatic.' },
  type: 'narrative',
  buttonText: 'Enter the wider world'
},

// ─────────────────────────────────────────────────────────
// STAGE 9 — LATENCY / SCHOOL (Age 6–10)
// ─────────────────────────────────────────────────────────
{
  id: 'latency',
  stageLabel: ()=>'Latency Period · Ages 6–10',
  stageGroup: 'Latency',
  title: 'The Wider World',
  text: (e,t)=>`School arrives, and with it: <em>other people</em>. Not family — strangers. Children who do not know you, who carry their own defaults, their own invisible inheritances, their own desperate hypotheses about how people work.<br><br>
The oedipal drama quiets for a time. Freud called this the latency period — not because the unconscious sleeps, but because the culture needs the child to turn outward: to learn to read, to cooperate, to compete, to lose without being destroyed.<br><br>
${({
  enmeshed: 'You arrive at school having been held very close. The distance from home is vivid — more than some others seem to feel it. But you know how to be warm; you know how to draw people in. The question is whether you know how to be separate, where your feelings end and another\'s begin.',
  cold: 'You arrive at school organised, capable, and somewhat puzzled by the noise of it. The social chaos — the tears, the sudden alliances and ruptures, the emotional weather — is not quite your idiom. You are competent; you are not always easy to reach.',
  chaotic: 'You arrive at school with a sophisticated radar. You already know how to read a room, how to assess mood, how to position yourself relative to the emotional weather. This is social intelligence — hard-won.'
})[e]}`,
  echo: (t)=>null,
  insight: { label: 'Psychoanalytic Note', text: 'The latency period is when the ego develops its secondary process capacities — reality-testing, rational thought, the ability to defer gratification. The relational patterns established in the oedipal period are now rehearsed in the schoolyard: who is the rival, who is the beloved, who holds authority, how do you respond when you don\'t get what you want. The same drama, miniaturised, played out a hundred times a week.' },
  type: 'choice',
  prompt: `A child in your class — a friend, someone you like — consistently gets more attention from the teacher than you do. The same current you felt at home is active: the third party, the rival, the thing between you and what you want.`,
  choices: [
    {
      text: 'You throw yourself into it — work harder, show more, make sure you are seen',
      tag: 'assert',
      outcome: (e,t)=>{
        const echo = hasTrait('protest') ? 'The urgency that has always driven you is in this competition. You have been competing since infancy; you are good at it now.' : hasTrait('identify') ? 'The same impulse that drew you toward your father — to become, to match, to aspire — drives this effort.' : '';
        return `You compete. Sometimes you win the teacher's attention; sometimes not. ${e==='enmeshed' ? 'The competition feels slightly illicit — at home, warmth was available without this kind of effort. Here, you have to earn it, which is both clarifying and galling.' : e==='cold' ? 'The competition is clean and familiar. You are organized for exactly this. Achievement is the currency you understand.' : 'You compete energetically, but with one eye on the emotional weather — you know from experience that visible effort can attract unwanted attention as easily as wanted.' }<br><br><em>${echo}</em>`;
      },
      patternEcho: (t)=> hasTrait('protest') || hasTrait('assert') ? 'The assertion you have been practising since age two has a new arena. You bring it here automatically.' : null
    },
    {
      text: 'You step back — this particular contest is not one you need to win',
      tag: 'appease',
      outcome: (e,t)=>`You step back from the competition. You tell yourself you don\'t really mind. <em>${hasTrait('withdraw_early') ? 'The inward turn is immediate and familiar — you have been practicing it since you were months old.' : hasTrait('appease') ? 'The compliant fold of the self is practiced now. You can do it quickly, cleanly.' : 'The retreat is new but recognisable — you have done something like this before.'}</em><br><br>${e==='enmeshed' ? 'The withdrawal here is interesting: at home, your desires were always so visible. Here, you discover that smaller desire produces less friction. It is a relief, and a loss.' : e==='cold' ? 'The withdrawal looks like not caring. And not caring is socially legible in this world — it does not draw attention. But you do care; the desire has just learned to go quiet.' : 'The reduction of desire is protective. In an unpredictable environment, wanting less is safety. The school is a new environment, but the principle transfers immediately.'}`,
      patternEcho: (t)=> hasTrait('withdraw_early') || hasTrait('appease') ? 'You have been practising this reduction of visible desire since early childhood. It arrives here automatically.' : null
    },
    {
      text: 'You move toward them instead — if they are ahead, perhaps there is more to learn from closeness',
      tag: 'identify',
      outcome: (e,t)=>`Instead of competing with the favoured child, you approach them. You are curious about what makes them appealing. <em>If you cannot beat them, befriend them. If you cannot have the teacher's attention alone, have it in their company.</em><br><br>This is the same move you made with your father — identification rather than opposition. The triangle becomes a collaboration. It is sophisticated for your age. ${e==='chaotic' ? 'In an unpredictable world, making allies of rivals is good strategy. You have been doing something like this with your father for years.' : ''}`,
      patternEcho: (t)=> hasTrait('identify') ? 'The identification move — rival into model, opposition into alliance — has become your signature. You are bringing it everywhere now.' : null
    }
  ]
},

// ─────────────────────────────────────────────────────────
// STAGE 10 — LATENCY: FIRST CLOSE FRIENDSHIP (Age 8–9)
// ─────────────────────────────────────────────────────────
{
  id: 'friendship',
  stageLabel: ()=>'Latency · Age 8–9',
  stageGroup: 'Latency',
  title: 'The First Friend',
  text: (e,t)=>`There is a child — you have known them for two years now — with whom something different is possible. With them, you are more yourself than you are with anyone else. It is the first rehearsal for adult intimacy.<br><br>
But the rehearsal is imperfect. One afternoon, without explanation, they exclude you from a game they are playing with someone else. The triangle reappears — miniaturised, schoolyard-scale — but with the full weight of the original.`,
  echo: (t)=>{
    const dominant = dominantTrait(['protest','secure_wait','withdraw_early','appease']);
    const map = {
      protest: { label: 'Pattern Recognised', text: 'The exclusion lands like the original absence — the one that first produced the cry. The urgency to close the gap, to be let back in, rises immediately.' },
      secure_wait: { label: 'Pattern Recognised', text: 'You feel the exclusion — of course you do — but something in you suspects it is not permanent. The faith that gaps close has been tested before and held.' },
      withdraw_early: { label: 'Pattern Recognised', text: 'The exclusion confirms something you have always half-believed: closeness is not safe. The inward turn arrives almost before the sting does.' },
      appease: { label: 'Pattern Recognised', text: 'Your first instinct is to figure out what you did wrong — what you need to change to be let back in. The self turns toward the other\'s experience rather than your own.' }
    };
    return map[dominant] || null;
  },
  insight: { label: 'Psychoanalytic Note', text: 'Peer relationships in latency are where oedipal dynamics are first rehearsed outside the family. The closeness of best friendship, the pain of exclusion, the jealousy of the rival, the longing to be special — these are the oedipal drama in civilian clothes. The responses children develop here become the templates they bring to adult friendship and love.' },
  type: 'choice',
  prompt: 'Your best friend has chosen someone else today. You are on the outside of something. There is a moment before you respond.',
  choices: [
    {
      text: 'You go to them directly — you deserve to know, and you would rather know than wonder',
      tag: 'assert',
      outcome: (e,t)=>`The directness is clear and somewhat brave. ${e==='enmeshed' ? 'You have always been direct about feelings — the Warm House made emotion legible. The friend is surprised and touched. You are back in the game.' : e==='cold' ? 'The directness is somewhat foreign to you — the Orderly House preferred managed silence — but you have seen it work in negotiation. It works here too, if awkwardly.' : 'The directness is a gamble — you are not always sure how directness will land. Today it works. Today the friend responds. You note this.'} <em>You have learned: asking gets you further than waiting or withdrawing. File this.</em>`,
      patternEcho: (t)=> hasTrait('assert') ? 'You have been practising directness since you were two. The form is more sophisticated; the move is the same.' : null
    },
    {
      text: 'You find something else — there are other things, other people. You do not need this particular group',
      tag: 'withdraw_early',
      outcome: (e,t)=>{ const en = e==="cold" ? "The self-sufficiency feels natural here — even praised. You handle it well. But the handling has a cost you do not inventory." : e==="chaotic" ? "Retreating when things turn uncertain is familiar. You are safer alone than in an unreliable connection. The logic holds — here, now. But it may calcify." : "This is unusual for you — normally you would press closer. But something new is being learned: you can survive distance. It hurts more than it should, but you can."; return `You remove yourself. The pain is real but you manage it by reducing the surface area of your need. ${en} <em>You are learning to carry something alone. It will become a habit.</em>`; },
      patternEcho: (t)=> hasTrait('withdraw_early') ? 'The first response — inward, alone, quieter — is so practiced now it requires no decision. It happens before you have chosen it.' : null
    },
    {
      text: 'You stay in the vicinity — find something nearby to occupy you, remain visible, remain available',
      tag: 'appease',
      outcome: (e,t)=>`You manage the rejection by managing the appearance of rejection. You are not alone — or at least you make sure it looks that way. <em>Pride, or something like it, is being used to process pain.</em> ${e==='enmeshed' ? 'In the Warm House, you were never quite invisible before. The performance of okayness is slightly new. It takes something out of you.' : e==='chaotic' ? 'Managing appearances is not new — you have been reading rooms and managing others\' impressions of your state for years. The skill transfers.' : ''} <em>You are learning to curate what others see of your inner life. This is a skill. It is also a distance from yourself.</em>`,
      patternEcho: (t)=> hasTrait('appease') ? 'The compliance — giving the appearance of being fine — has been your default since early childhood. It wears different costumes across the years.' : null
    }
  ]
},

// ─────────────────────────────────────────────────────────
// STAGE 11 — ADOLESCENCE: PUBERTY (Age 12–13)
// ─────────────────────────────────────────────────────────
{
  id: 'puberty',
  stageLabel: ()=>'Adolescence · Age 12–13',
  stageGroup: 'Adolescence',
  title: 'The Return',
  text: (e,t)=>`Puberty arrives like a depth charge detonated in still water.<br><br>
Everything that was quiet is loud again. Desire returns — sharper, more specifically sexual, more urgently bodily — and it returns organised by the old oedipal patterns. The template laid down at age four or five now shapes who attracts, who repels, what feels transgressive but irresistible.<br><br>
${({
  enmeshed: 'In the Warm House, adolescence has an additional charge: separating from a mother whose love has been intense and close is not simple. The sexuality that is emerging is also a vehicle for separation — for finding something, someone, that belongs entirely to you and not to her. The developmental task is urgent.',
  cold: 'In the Orderly House, the emotional intensity of adolescence is somewhat alien. The managed feelings of childhood give way to something unmanageable. The body has opinions the mind has not approved. This disorder is both disturbing and, in some way, a relief — it breaks open what has been too tightly held.',
  chaotic: 'In the Unpredictable House, adolescence is one more version of the long experience: intensity, uncertainty, the ground moving. You are, in some ways, more prepared for this than others. You have always lived in high emotional weather.'
})[e]}<br><br>
The first person you find yourself genuinely, bodily drawn to is — interesting. There is something in them that recalls the original beloved, though you would not recognise this and could not name it. A tone, a quality of attention, an ineffable warmth or coolness that fits some shape in you that was cut long ago.`,
  insight: { label: 'Psychoanalytic Note', text: 'Freud described adolescence as a "second Oedipus" — the reawakening of infantile sexuality, now genitally organised. The adolescent must find new objects outside the family, which requires the loosening of original incestuous ties. The object chosen is always, in some sense, both a repetition and a departure: the unconscious reaches for the familiar; the ego pushes toward the new. The degree of departure determines the degree of freedom.' },
  type: 'narrative',
  buttonText: 'Enter desire'
},

// ─────────────────────────────────────────────────────────
// STAGE 11b — THE RUPTURE (Age 11–13)
// Mid-game disruption: groove-determined cause, env-coloured landing
// ─────────────────────────────────────────────────────────
{
  id: 'rupture',
  stageLabel: ()=>'Early Adolescence · The Rupture',
  stageGroup: 'The Rupture',
  title: (e,t)=> 'Something Breaks',
  text: (e,t)=>{
    const dom = dominantFamily();
    // Rupture cause determined by dominant groove
    const cause = {
      protest:    e==='enmeshed' ? 'Your mother becomes suddenly unavailable — not gone, but changed. A depression, perhaps, or a new relationship, or simply a turning inward that her own life has required. The person who was always there is still there. But the warmth that organised your world has shifted, and the gap it leaves is not like ordinary gaps.' :
                  e==='cold' ? 'Your father, the most stable fixture in an orderly house, loses his position. Not dramatically — quietly. But the competence that was the emotional currency of your home is suddenly in doubt, and with it something you had quietly relied on.' :
                  'The ground, which was always uncertain, breaks in a new way. Not the familiar turbulence — something more final. A departure. A loss that cannot be repaired by waiting for the next calm period.',
      avoidant:   e==='enmeshed' ? 'A friendship — the first one that has felt entirely safe — ends. Not with drama, but with a slow withdrawal that you cannot prevent or fully understand. The person who had become the quiet alternative to the intensity of home is simply no longer available.' :
                  e==='cold' ? 'You are asked, for the first time, to perform emotionally in front of others — a school presentation, a group, a situation where composure is not enough. Something in you that has never been tested is suddenly, visibly, being tested.' :
                  'A relationship you had trusted — perhaps the only one — turns unpredictable in a way that mirrors the home. The pattern you thought you had escaped is reproduced in a different room.',
      assertive:  e==='enmeshed' ? 'You assert something — a position, a preference, a refusal — and it lands harder than you expected. Someone you love is genuinely hurt by it. The directness that felt like integrity feels, suddenly, like a weapon.' :
                  e==='cold' ? 'You fail at something publicly. Not privately, where failure can be contained and managed, but in front of others. The competence that was your inheritance is briefly, visibly, absent.' :
                  'You hold a position in a conflict and it escalates beyond what you can control. The assertiveness that usually resolves things has, this time, made something worse.',
      reflective: e==='enmeshed' ? 'You understand, clearly, what is happening in your family — the dynamics, the roles, the patterns. This understanding protects you from nothing. The insight is real and entirely insufficient.' :
                  e==='cold' ? 'You observe yourself going through the motions of feeling without actually feeling. The gap between your analysis of a situation and your experience of it becomes, briefly, undeniable.' :
                  'Something happens that you cannot process intellectually. It is simply, stubbornly, too much — and the tools you have built are the wrong tools for this particular damage.',
      secure:     e==='enmeshed' ? 'The trust that has always been available is suddenly in question — not destroyed, but shaken. The reliable face becomes unreliable for a period, and you find you do not know, quite, who you are without it.' :
                  e==='cold' ? 'A moment of genuine connection — unexpected, unearned — arrives and is quickly withdrawn. The gap between what was briefly possible and what is actually available becomes, for the first time, painful rather than simply ordinary.' :
                  'Something that had stabilised — a friendship, a teacher, a small reliable structure — is abruptly removed. The ground you had found in the chaos is gone. You are back to the beginning.',
    }[dom] || 'Something happens that the character does not have an answer for.';

    crackCause = dom; // store for late-game crack
    var aceStyle1 = 'font-family:"Cormorant Garamond",serif;font-size:1rem;line-height:1.85;color:rgba(200,90,80,0.88);font-style:italic;border-left:2px solid rgba(139,26,46,0.45);padding:8px 14px;margin-bottom:8px';
    var aceStyle2 = 'font-family:"Cormorant Garamond",serif;font-size:1rem;line-height:1.85;color:rgba(200,120,80,0.78);font-style:italic;border-left:2px solid rgba(139,26,46,0.3);padding:8px 14px;margin-bottom:8px';
    const acePrefix = difficulty >= 2
      ? '<div style="' + aceStyle1 + '">The adversity of earlier years did not cause this rupture. But it narrowed the available responses. The original compromise, formed under pressure, runs with less flexibility than it might otherwise have had.</div>'
      : difficulty >= 1
      ? '<div style="' + aceStyle2 + '">The earlier difficulties have left their mark. This rupture lands on ground that was already somewhat unsteady.</div>'
      : '';
    return acePrefix + `You are eleven. Or twelve. Or thirteen — the body is changing, the world is expanding, and the childhood solutions are beginning to show their age.<br><br>${cause}<br><br><em>This is the first test. The original compromise that formed in infancy — refined through the oedipal drama, practised in the schoolyard — now meets something it was not built for.</em>`;
  },
  insight: { school: 'Developmental Psychology · Winnicott', label: 'On Rupture and Repair', text: 'Winnicott described the "good enough" environment as one that is reliable enough to be disappointing without being catastrophic. The rupture — the moment when the environment fails in ways the child cannot process alone — is not an aberration in development. It is part of it. What matters is not the absence of rupture but whether something like repair becomes possible, and what the child does in the gap.' },
  type: 'choice',
  prompt: (e,t)=>{
    const dom = dominantFamily();
    const prompts = {
      protest: 'The feeling is enormous and there is nowhere to put it. What do you do?',
      avoidant: 'The feeling arrives and the familiar door — the one that goes inward — is right there. Do you take it?',
      assertive: 'The situation is not one you can control. This is new. How do you respond?',
      reflective: 'You can see what is happening. Seeing it changes nothing. What now?',
      secure: 'The ground that was reliable is not, right now, reliable. What do you reach for?',
    };
    return prompts[dom] || 'Something shifts. The old response is available. So is something harder.';
  },
  choices: [
    {
      text: 'You do what you know — the familiar response, intensified to meet the size of this',
      tag: function() { var dom = dominantFamily(); return {protest:'protest',avoidant:'withdraw_early',assertive:'assert',reflective:'reflect',secure:'secure_wait'}[dom]||'protest'; },
      outcome: (e,t)=>{
        const dom = dominantFamily();
        const outcomes = {
          protest: 'The urgency doubles. You cry louder, demand more, make the feeling visible and insistent. In the Warm House, this sometimes works — the disrupted parent is recalled by the intensity of your need. In the Cold or Chaotic house, it often makes things worse. <em>The original compromise deepens regardless. You have learned: when the gap opens, press harder.</em>',
          avoidant: 'You go quiet. The disruption, which was external, becomes internal — managed, contained, not discussed. In the Cold House, this is practically praised. In the Warm or Chaotic houses, it produces a worried hovering from the other parent. <em>You have learned: the inward turn is the safest door. It is always there.</em>',
          assertive: 'You push back against the disruption — try to correct it, fix it, argue it back into order. Some of it works. The parts that do not work become the first evidence that directness has limits. <em>You note this, file it, and return to the directness anyway.</em>',
          reflective: 'You observe. You name what is happening, to yourself, carefully. The naming provides distance but not comfort. <em>You have learned that understanding is available even when experience is not manageable. This will be useful. It will also, one day, be a limitation.</em>',
          secure: 'You wait. You have learned that gaps close — that reliability is real even when it is temporarily absent. The waiting is harder than usual, because this gap is bigger than usual. But you wait. <em>The faith holds, barely. You do not forget that it was tested.</em>',
        };
        return outcomes[dom] || 'The character runs. The rupture is not resolved so much as absorbed — metabolised into the pattern, which emerges slightly thicker, slightly more certain of itself.';
      },
      patternEcho: (t)=> 'The first major test. The original compromise runs harder under pressure. This is the most common outcome — and the one that makes the character most permanent.'
    },
    {
      text: 'Something you do not recognise in yourself — a response that does not come from the usual place',
      tag: 'reflect',
      outcome: (e,t)=>{
        const dom = dominantFamily();
        return `The default is available. For once, it does not quite activate.<br><br>What happens instead is harder to name — a stillness, an openness, something closer to simply <em>being in</em> the difficulty without immediately managing it. It does not resolve the rupture. It does not make the pain smaller.<br><br>But something is registered: the original compromise is not the only option. There is a sliver of space between what happens and what you do about it. It will close again, probably. <em>But it has been open. And what has been open once can be opened again.</em><br><br>${e==='enmeshed' ? 'In the Warm House, this moment of difference is noticed — your parent, uncertain what to do with a child who is not demanding or withdrawing, reaches toward you in a slightly different way. Something new is briefly possible.' : e==='cold' ? 'In the Orderly House, this moment passes largely unobserved. The self-sufficiency is assumed. But inside, something has shifted.' : 'In the Unpredictable House, the capacity to do something different in a moment of crisis is significant. You have not learned it from the environment. You have found it somewhere else.'}`;
      },
      patternEcho: null
    }
  ]
},

// ─────────────────────────────────────────────────────────
// STAGE 12 — FIRST LOVE (Age 14–16)
// ─────────────────────────────────────────────────────────
{
  id: 'first_love',
  stageLabel: ()=>'Adolescence · Age 14–16',
  stageGroup: 'Adolescence',
  title: 'First Love',
  text: (e,t)=>`It happens. There is a person. Everything is reorganised around them.<br><br>
You are learning what your desire is like when it has a living object — what you do when you want someone, when they want you back, when they don't, when they come close and then pull away. All of it is new. None of it is entirely new.<br><br>
<em>The default you built in childhood follows you here like a shadow.</em>`,
  echo: (t)=>{
    const dominant = dominantTrait(['protest','secure_wait','withdraw_early','appease','assert','identify','ambivalent']);
    const map = {
      protest: { label: 'Pattern in Motion', text: 'The urgency is back. Desire, for you, is loud — it fills the body, it demands expression, it closes the gap. This is the same force that has driven every significant emotional moment since infancy. First love will show you its costs and its gifts.' },
      secure_wait: { label: 'Pattern in Motion', text: 'You bring something unusual to this: a capacity to want without being destroyed by the wanting. The faith that gaps close — built in those earliest months — is here.' },
      withdraw_early: { label: 'Pattern in Motion', text: 'Even in desire, there is a held-backness. You want them — deeply, genuinely — but something keeps a distance. The closeness is both what you seek and what you protect against.' },
      appease: { label: 'Pattern in Motion', text: 'You are already organising yourself around what they seem to want. Your own wanting is real, but it moves immediately to serve theirs. The self-erasure is so practiced now it feels like love.' }
    };
    return map[dominant] || null;
  },
  insight: { label: 'Psychoanalytic Note', text: 'Transference — the unconscious displacement of feelings from past relationships onto present ones — is the normal texture of love. We always love with some portion of the feeling belonging to an earlier figure. First love is often the fullest expression of this: almost entirely organised by the template, with the actual other person only partially in view. "We fall in love," wrote the analyst Adam Phillips, "with someone who fits our symptoms."' },
  type: 'choice',
  prompt: `They are wonderful. They are also, sometimes, unavailable — drawn to someone else, uncertain about you, not quite giving you what you most want. The familiar current runs.`,
  choices: [
    {
      text: 'You tell them — it is better to have said it than to wonder forever what might have happened',
      tag: 'assert',
      outcome: (e,t)=>`${e==='enmeshed' ? 'The expression comes easily — emotional directness has always been the native language of the Warm House. But here, outside the house, it lands differently. Some people receive it. This one looks slightly alarmed. <em>You learn: the openness that made you feel loved at home is not universally welcomed. Not everyone lives at that temperature.</em>' : e==='cold' ? 'The expression is somewhat effortful — you are doing something the Orderly House didn\'t quite teach. But you reach for it. The words come out more formal than you intended, but they come out. <em>You are practising something new. The awkwardness is the point.</em>' : 'You express the feeling even knowing the response is uncertain. <em>The courage required in an unpredictable world is real. You have it. The expression is genuine and slightly desperate.</em>'}`,
      patternEcho: (t)=> hasTrait('assert') ? 'The direct bid — learned in the schoolyard, practised at home — arrives here. It is your default tool for closing the gap.' : null
    },
    {
      text: 'You attune yourself to them — learn what they like, become someone they will want to keep',
      tag: 'appease',
      outcome: (e,t)=>`You read what they seem to need and move toward it. You soften your edges, amplify what they like, reduce what makes them uncertain. <em>It works, somewhat — they stay, they come a little closer. But what they are drawing closer to is a curated version of you.</em><br><br>${hasTrait('appease') ? '<em>You have been erasing small edges of yourself to maintain connection since you were two years old. The practice is expert now. And the gap between who you are and who you perform is wider than it has ever been.</em>' : 'The self-adjustment is new, or feels new. But the logic is old: adapt, and the connection holds.'}`,
      patternEcho: (t)=> hasTrait('appease') ? 'The compliance is complete now. In infancy it was behaviour; now it is personality.' : null
    },
    {
      text: 'You hold back — wanting something this much makes you vulnerable, and caution feels like wisdom',
      tag: 'withdraw_early',
      outcome: (e,t)=>`The pull is to retreat before the pain becomes larger. To make yourself smaller, needier, less. <em>${hasTrait('withdraw_early') ? 'This is a move of the utmost familiarity. You have been making it since you were months old. The pattern is so established it is no longer a decision — it is weather.' : 'The withdrawal is new in this form, but the instinct behind it is not. You have been practising the inward turn in smaller ways for years.'}</em><br><br>They notice the absence and come slightly closer. Which is interesting. Which teaches you something.`,
      patternEcho: (t)=> hasTrait('withdraw_early') ? 'You retreat. They follow. The dynamic is now fully established: distance produces pursuit, which produces temporary closeness, which produces anxiety about the closeness, which produces distance. The cycle is just beginning.' : null
    }
  ]
},

// ─────────────────────────────────────────────────────────
// STAGE 13 — ADOLESCENT CONFLICT WITH AUTHORITY (Age 15–17)
// ─────────────────────────────────────────────────────────
{
  id: 'authority_conflict',
  stageLabel: ()=>'Adolescence · Age 15–17',
  stageGroup: 'Adolescence',
  title: 'Against the Law',
  text: (e,t)=>`The parental authority — once absolute — is now a target. The adolescent must, to some degree, attack the authority of the parents in order to emerge from under it. This is not rebellion for its own sake; it is a developmental necessity.<br><br>
${({
  enmeshed: 'In the Warm House, the rebellion is tinged with guilt — the mother\'s hurt face has always been the most powerful deterrent. You may rebel with one hand and apologise with the other. The separation is happening, but it is agonising.',
  cold: 'In the Orderly House, the rebellion takes the form of contempt for what your parents value: the controlled competence, the managed emotions, the achievement. You find yourself drawn to the loud, the messy, the feeling. It is the opposite of home, which is exactly the point.',
  chaotic: 'In the Unpredictable House, rebellion is complicated — you have been managing this unpredictable authority for years, which means you are in some ways more practiced at navigating it. But you are also more exhausted by it. The rebellion, when it comes, may have the quality of release.'
})[e]}<br><br>
The superego — the internal version of the parental law — is also in the dock. The voice that says what you should and should not want is being cross-examined.`,
  insight: { label: 'Psychoanalytic Note', text: 'Adolescent rebellion is the second oedipal moment in miniature: the child must symbolically "kill" the parent — dethrone them from absolute authority — in order to become a subject in their own right. The danger is either insufficient rebellion (the person who never individuates, who remains under the shadow of parental ideals) or excessive rebellion (the person whose identity is constituted entirely by opposition and who is therefore still defined by the parents).' },
  type: 'choice',
  prompt: `A conflict with a parent — about your choices, your life, who you are becoming. The old triangle is in the room, but now you are large enough to meet it differently.`,
  choices: [
    {
      text: 'You hold your position — this is yours to decide, and you say so clearly',
      tag: 'assert',
      outcome: (e,t)=>`${e==='enmeshed' ? 'The standoff is painful — the parent\'s hurt is real, and your hurt is real. But you hold. Something unprecedented occurs: you remain separate even under the pressure of love and guilt. <em>This is individuation. It costs. It is worth it.</em>' : e==='cold' ? 'The parent counter-argues, calmly. You argue back. Neither of you shouts. Something is settled: you have a self that can stand in opposition to them and not collapse. <em>The self you have been building is load-bearing.</em>' : 'The standoff risks igniting something larger. You hold anyway — partly because you are old enough to handle what might come, partly because something in you knows this is necessary. <em>The ground holds under you. This is new.</em>'}`,
      patternEcho: (t)=> hasTrait('assert') ? 'You have been asserting since you were two. Now the assertion is operating in its rightful arena: claiming your own life.' : null
    },
    {
      text: 'You let it go — the argument has costs too, and they are not entirely without a point',
      tag: 'appease',
      outcome: (e,t)=>`The peace is restored. But something goes slightly flat inside you — the person who exists when the parent isn't looking is further from the person who stood here a moment ago. <em>${hasTrait('appease') ? 'The pattern is so established now that you barely feel it as capitulation. It feels like being reasonable. This is how character crystallises — when the adaptive becomes automatic.' : 'The compliance feels slightly wrong in a way it didn\'t when you were younger. You are becoming aware of it as a pattern.'}</em><br><br>Outside, later, you feel the residue of the unexpressed self. It will look for another exit.`,
      patternEcho: (t)=> hasTrait('appease') ? 'Every time the self folds to preserve connection, the fold becomes easier and the self becomes quieter. You are expert at this now.' : null
    },
    {
      text: 'You disengage — the conversation has reached its limit and your life is large enough to find elsewhere',
      tag: 'withdraw_early',
      outcome: (e,t)=>`The conflict is resolved by your absence from it. You are increasingly elsewhere — in your friends, your music, your life outside the house — and the parent grows distant by your choice rather than theirs. <em>This is a form of individuation, but a partial one: you have not faced the parent and separated; you have simply moved away. The authority has not been challenged — it has been avoided. It will be waiting for you in other guises.</em>`,
      patternEcho: (t)=> hasTrait('withdraw_early') ? 'Leaving — emotionally, then physically — has been your signature response to the unbearable. It works. And it leaves things unfinished.' : null
    }
  ]
},

// ─────────────────────────────────────────────────────────
// STAGE 14 — EARLY ADULTHOOD: LEAVING HOME (Age 18–20)
// ─────────────────────────────────────────────────────────
{
  id: 'leaving_home',
  stageLabel: ()=>'Early Adulthood · Age 18–20',
  stageGroup: 'Adult Life',
  title: 'The Threshold',
  text: (e,t)=>`You leave. Physically — through a door, with bags, into a new space where no one knows you and no one has expectations about who you are.<br><br>
The freedom is real. So is the strangeness.<br><br>
${({
  enmeshed: '<em>The Warm House recedes behind you — but not entirely.</em> You find yourself calling more often than perhaps you intended to. The voice on the phone is still, somewhat, the centre of your emotional gravity. Independence tastes of exhilaration and guilt in equal measure. What you are learning to do is feel both at once.',
  cold: '<em>The Orderly House recedes, and you realise, with some surprise, that you miss it less than you expected.</em> The competence you were raised on serves you well in the practical demands of independence. But something else is discovered: you are somewhat at a loss with feelings — yours and others\'. The managed inner life worked at home. Here it produces a strange distance.',
  chaotic: '<em>The Unpredictable House recedes, and the relief is genuine and slightly startling.</em> For the first time, you can predict the emotional weather, because you are the only one making it. This is both freedom and solitude. You are better at crisis than at calm; more practiced in urgency than in peace.'
})[e]}`,
  echo: (t)=>null,
  insight: { label: 'Psychoanalytic Note', text: 'Leaving home is not the end of the oedipal drama — it is its next chapter. The psychological task is not simply geographical departure but the internal work of separating from the parental figures who have been internalised. The parent inside is often more formidable than the parent at home. The work of early adulthood is largely the renegotiation of these internal relationships.' },
  type: 'narrative',
  buttonText: 'Cross the threshold'
},

// ─────────────────────────────────────────────────────────
// STAGE 15 — ADULT INTIMACY (Age 22–26)
// ─────────────────────────────────────────────────────────
{
  id: 'adult_intimacy',
  stageLabel: ()=>'Adulthood · Age 22–26',
  stageGroup: 'Adult Life',
  title: 'The Beloved',
  text: (e,t)=>`You are in a serious relationship. Sustained, complicated, tender, occasionally frightening in its closeness.<br><br>
Something curious keeps happening: in certain moments — in arguments, in the quality of your longing when they are away, in what you need that they cannot seem to give — <em>you catch a glimpse of something older than this relationship.</em><br><br>
A pattern. A shape of feeling that seems to predate them entirely. Not always. But sometimes, in the middle of a perfectly ordinary afternoon, you feel a current that is not quite about them — something from further back, moving through the present moment like light through water.`,
  echo: (t)=>{
    const dominant = dominantTrait(['protest','secure_wait','withdraw_early','appease','assert']);
    const map = {
      protest: { label: 'Pattern at the Surface', text: 'When the closeness is interrupted — when they are unavailable, distracted, uncertain — the urgency rises immediately. The same force that drove the cry, the tantrum, the declaration of desire, the assertion in the schoolyard: it is here. Directed at them. Some of it is about them. Some of it is much older.' },
      secure_wait: { label: 'Pattern at the Surface', text: 'The trust that was built in the earliest months is here too — the capacity to wait without being destroyed by the waiting, to trust that the gap will close. This is a gift. Your partner feels it as steadiness.' },
      withdraw_early: { label: 'Pattern at the Surface', text: 'Even in intimacy, some part of you is still poised to retreat. The closeness is both what you want and what you fear — because closeness was never quite safe enough to want fully. You are close, and also slightly absent. They feel both things.' },
      appease: { label: 'Pattern at the Surface', text: 'You have organized yourself around their needs so thoroughly that they sometimes wonder who you are when they\'re not looking. And so do you. The self that was built on accommodation is capable of great love — but it struggles with the step where it puts its own desires on the table, plainly, and waits.' }
    };
    return map[dominant] || null;
  },
  insight: { label: 'Psychoanalytic Note', text: 'Adult love is always, to some degree, object relations in translation. We bring to our partners the template built by the earliest figures — the expectations, the hopes, the defenses, the blindspots. What distinguishes a mature love from an immature one is not the absence of transference but the presence of enough consciousness to sometimes see through it — to recognize the ghost behind the face and choose, with that recognition, to love the actual person.' },
  type: 'choice',
  prompt: `A recurring argument. Different surface, same shape: you need something from them they struggle to give. The situation is familiar — not from this relationship, but from further back. What do you do?`,
  choices: [
    {
      text: 'You let the feeling show — it is real, it is large, and you would rather it be between you than inside you alone',
      tag: 'protest',
      outcome: (e,t)=>`The argument expands. The feeling is genuine; the proportion may not be. <em>${hasTrait('protest') ? 'You have been making this move — the urgent, full-volume protest — since infancy. It has always produced some result. Here it produces result and damage simultaneously. They receive something that was never entirely meant for them.' : 'The escalation is new but draws on old fuel.'}</em><br><br>Later, in the quiet, you notice the argument had a familiar shape — older than this relationship. <em>This recognition is where change begins, if it begins anywhere.</em>`,
      patternEcho: (t)=> hasTrait('protest') ? 'Every escalation carries the echo of the first one. The infant who cried until the mother returned is still in the room.' : null
    },
    {
      text: 'You go quiet — you need to understand what you are feeling before you can say anything useful about it',
      tag: 'withdraw_early',
      outcome: (e,t)=>`You fold inward. The argument does not happen; neither does the repair. They are left with your absence rather than your feeling. <em>${hasTrait('withdraw_early') ? 'The inward turn is now so fast, so total, that they rarely see what preceded it — the hurt, the need, the wanting. They see only the absence. And the absence is unassailable — you can\'t argue with a wall.' : 'The withdrawal is protective, but it leaves the situation unresolved, to be returned to.'}</em><br><br>Something important is not said. <em>What goes unsaid tends to fester, or to speak in other ways.</em>`,
      patternEcho: (t)=> hasTrait('withdraw_early') ? 'The wall you built in infancy is fully constructed now. It is real protection and a real prison.' : null
    },
    {
      text: 'You pause — something about the size of the feeling makes you want to understand it before you act on it',
      tag: 'reflect',
      outcome: (e,t)=>`You pause. Not easily — the feeling is large and wants to move. But you hold it a moment. <em>Something about the shape of this seems older than today.</em><br><br>You say something smaller and more accurate: not the full charge, but the real thing beneath it. They hear it. The conversation that follows is different — less like a replay and more like something that belongs to this relationship, between these two people, today.<br><br><em>The pause is not wisdom yet. But it is the space in which wisdom could live, if practiced.</em> ${hasTrait('reflect') ? 'You are building this capacity, moment by moment. It is not yet habit, but it is becoming one.' : ''}`,
      patternEcho: (t)=> null
    }
  ]
},

// ─────────────────────────────────────────────────────────
// STAGE 16 — THE PATTERN NAMED (Age 26–30)
// ─────────────────────────────────────────────────────────
{
  id: 'pattern_named',
  stageLabel: ()=>'Adulthood · Age 26–30',
  stageGroup: 'Adult Life',
  title: 'Seeing the Pattern',
  text: (e,t)=>{
    const dominant = dominantTrait(['protest','secure_wait','withdraw_early','appease','assert','reflect']);
    const patternDesc = {
      protest: 'The urgency. You can name it now: when the gap opens — when someone you love is unavailable, distracted, or uncertain — something in you moves to close it with force. The cry that brought her back. The tantrum. The declaration of desire. The argument. They are all the same gesture, growing more sophisticated with each decade but running on the same engine. It has served you. It has cost you. You are beginning to see both.',
      secure_wait: 'The faith. You can name it now: a baseline conviction that the other will return, that the gap will close, that absence is not abandonment. It came from the earliest months — the reliable enough return. It has served you more than you know, though you have never had to earn it consciously.',
      withdraw_early: 'The retreat. You can name it now: when it becomes too much — too close, too uncertain, too large — you go inward. You have been doing this since you were months old. The retreat has many names: self-sufficiency, composure, independence, privacy. All of them are true. None of them are the whole truth.',
      appease: 'The accommodation. You can name it now: the self that shapes itself around the other, that reads the room before speaking, that folds its own wanting inward to preserve connection. It has made you very good at relationship — at the maintenance of relationship. The question of whether it is truly intimate is another matter.',
      assert: 'The directness. You can name it now: when you want something, you say so. When something is wrong, you name it. This comes so naturally you have barely noticed it as a pattern — but it is. It can serve you; it can also bulldoze the space where other things might be said.',
      reflect: 'The pause. You can name it now: the habit — still effortful, still chosen rather than automatic — of stopping between feeling and expression to ask: what is this about? How much of this is now, and how much is then? It is the newest thing in your repertoire. It has been the most expensive to build.'
    };

    return `Something becomes visible that has always been present but never named.<br><br>
<em>${patternDesc[dominant] || 'A shape emerges — the signature of your response to difficulty and desire.'}</em><br><br>
The visibility does not immediately change anything. The pattern is too old, too wired, too practiced to dissolve in a moment of recognition. But recognition is the precondition of choice. Before you can respond differently, you have to notice that you are responding at all — that this is a response, not just reality.<br><br>
${e==='enmeshed' ? '<em>In the Warm House, love and loss of self were always close together. The pattern you built may have kept you connected — but at the cost of you. The question going forward is: can you be loved as your whole self, and can you offer love from your whole self, rather than from the self that has shaped itself around what love required?</em>' : e==='cold' ? '<em>In the Orderly House, competence was the currency and feeling was the surplus. The pattern you built may have made you capable — but at the cost of access to your inner life. The question going forward is: can you be known, not just functional? Can you let someone in to where the feeling is?</em>' : '<em>In the Unpredictable House, the pattern was a form of survival. You became expert in the emotional weather of others, at the expense of confidence in your own ground. The question going forward is: can you trust the ground under you, when you are not managing someone else\'s instability?</em>'}`;
  },
  insight: { label: 'Psychoanalytic Note', text: '"Making the unconscious conscious" — Freud\'s original description of the therapeutic task — is less about revelation than about recognition. The moment of seeing the pattern is not a cure; it is an opening. Character does not change overnight. But something shifts when we can name what we are doing while we are doing it — when the automatic becomes slightly, incrementally, deliberate.' },
  type: 'narrative',
  buttonText: 'Carry the knowledge forward'
},

// ─────────────────────────────────────────────────────────
// STAGE 17 — WORK AND AUTHORITY (Age 28–35)
// ─────────────────────────────────────────────────────────
{
  id: 'work_authority',
  stageLabel: ()=>'Adulthood · Age 28–35',
  stageGroup: 'Adult Life',
  title: 'The Boss',
  text: (e,t)=>`Your boss — your supervisor, your superior, whoever sits above you in whatever structure you inhabit — is not your father.<br><br>
You know this. And yet.<br><br>
The relationship has a familiar current. The way you feel when they criticise your work. The way you position yourself to be noticed or to avoid notice. The degree to which their approval matters in a way that seems out of proportion to the professional stakes.<br><br>
The oedipal drama has followed you to work. Of course it has. It follows everyone.`,
  echo: (t)=>{
    const dominant = dominantTrait(['protest','appease','assert','withdraw_early','identify','ambivalent']);
    const map = {
      protest: { label: 'Pattern at the Surface', text: 'Criticism from authority still hits harder than you expect. The urgency to correct it, to re-establish your standing, to close the gap between how they see you and how you want to be seen — familiar.' },
      appease: { label: 'Pattern at the Surface', text: 'You have oriented yourself toward what the boss wants, sometimes before you have considered what you want. The accommodation is practiced. You are useful to them. The cost is that your own direction is somewhat unclear.' },
      assert: { label: 'Pattern at the Surface', text: 'You have opinions about how things should be done, and you express them. This makes you valuable. It also, sometimes, makes you a problem. The same directness that served you in the schoolyard, in relationships, is here.' },
      withdraw_early: { label: 'Pattern at the Surface', text: 'When the authority figure becomes difficult, your instinct is to reduce your visibility — to do the work quietly, avoid notice, not require anything of them. It is safe. It is also invisible.' },
      identify: { label: 'Pattern at the Surface', text: 'You have found something to admire in this person — genuinely. The same turn you made toward your father is here: rivalry sublimated into aspiration. You want to do what they do. You want to be trusted with what they\'re trusted with.' }
    };
    return map[dominant] || null;
  },
  insight: { label: 'Psychoanalytic Note', text: 'The workplace is an oedipal field. The boss carries the projection of the father: the authority, the model, the rival. Colleagues carry projections of siblings. Clients and customers carry projections of needy, demanding, or gratifying children. Organizational life is never purely rational — it runs on these invisible currents, which is why the same person can be competent in one structure and dysfunctional in another.' },
  type: 'choice',
  prompt: `Your boss has passed you over for a project you wanted — it went to a colleague who is less senior but, you suspect, more liked. The old current runs.`,
  choices: [
    {
      text: 'You request a direct conversation — ask clearly why the decision was made and what you need to do differently',
      tag: 'assert',
      outcome: (e,t)=>`The conversation is uncomfortable and useful. You learn something about how you are perceived — not everything you wanted to hear, some things that are genuinely helpful. <em>${hasTrait('assert') ? 'The directness that has characterised your approach since early childhood is producing results in the world. The boss respects the bid, even if the answer is not what you wanted.' : 'The directness is slightly new in this context, but you reach for it. The fact that it is slightly effortful makes it slightly more real.'}</em>`,
      patternEcho: (t)=> hasTrait('assert') ? 'Direct bid, direct information. You have been running this play for twenty years.' : null
    },
    {
      text: 'You work harder, do more, angle to make your value undeniable',
      tag: 'identify',
      outcome: (e,t)=>`The response is to out-earn the slight through performance. <em>${hasTrait('identify') ? 'The aspiration engine — which has been running since you first watched your father working and wanted to become him — revs up. The rivalry is metabolised into effort. This is sophisticated and it usually works.' : 'The competitive instinct turns inward, becomes productivity. It is not the most direct response, but it produces something.'}</em><br><br>Three months later, the next project is yours. The boss mentions your name with something adjacent to admiration.`,
      patternEcho: (t)=> hasTrait('identify') ? 'The rival-to-model move — your oldest and most reliable transformation of difficult feeling — is running perfectly.' : null
    },
    {
      text: 'You withdraw — mentally, emotionally. You do the work, but your investment decreases',
      tag: 'withdraw_early',
      outcome: (e,t)=>`The reduction of investment is protective. You stop wanting the thing you don\'t have, which stops the wanting from hurting. <em>${hasTrait('withdraw_early') ? 'The inward turn has been your signature since infancy. Here it looks like professionalism. But the disengagement is real — and the boss, who is not unintelligent, begins to notice the slight flatness.' : 'The retreat is a version of self-protection. It works in the sense that it stops the pain. It costs something that is harder to quantify.'}</em>`,
      patternEcho: (t)=> hasTrait('withdraw_early') ? 'You reduce. You manage. You survive the slight by making yourself need the thing less. The pattern is fully automatic now.' : null
    }
  ]
},

// ─────────────────────────────────────────────────────────
// STAGE 18 — MID-LIFE / THE PATTERN TESTED (Age 35–42)
// ─────────────────────────────────────────────────────────
{
  id: 'midlife',
  stageLabel: ()=>'Mid-Life · Age 35–42',
  stageGroup: 'Mid-Life',
  title: 'The Pattern Under Pressure',
  text: (e,t)=>`Something happens in mid-life — it is not always a crisis, but it is always a reckoning.<br><br>
The strategies that carried you here begin to show their seams. The default — the one built in the first years of life and refined across every subsequent decade — is still working. And it is also, in some place you have been successfully ignoring, costing you.<br><br>
${({
  enmeshed: 'If you came from the Warm House and built yourself around closeness and connection, you may find that you have given so much of yourself to others that you have lost the thread back to what you actually want — what you want, not what they need.',
  cold: 'If you came from the Orderly House and built yourself around competence and control, you may find that you are effective in everything and moved by nothing — that the managed inner life has become a kind of numbness, and that something real has been waiting quietly for permission to speak.',
  chaotic: 'If you came from the Unpredictable House and built yourself around vigilance and adaptation, you may find that you are exhausted — that the hypervigilance which kept you safe has never stopped running, even when the emergency is over, and that you don\'t quite know how to be at rest.'
})[e]}<br><br>
The question mid-life poses is not "who am I" — you are past that. The question is: <em>is who I became still who I want to be?</em>`,
  echo: (t)=>{
    if (traitCount('reflect') >= 2) {
      return { label: 'The Intellectual\'s Trap', text: 'You have been watching yourself for a long time. The watching has been real — the observations accurate, the concepts correctly applied. And yet: if you are honest, the watching has also been a way of not quite arriving. You have understood the pattern with great sophistication. The pattern has continued to run. There is a name for this in psychoanalytic literature: intellectualisation. The defence does not deny the difficulty — it processes the difficulty through thought rather than allowing it to be metabolised through experience. The question mid-life poses to you, specifically, is not whether you understand yourself. It is whether the understanding has been, all along, a refined way of staying safe.' };
    }
    return null;
  },
  insight: { label: 'Psychoanalytic Note', text: 'Mid-life is what Jungians call the "afternoon of life" — the period when the adaptations that served the first half become insufficient for the second. The defenses that were protective become restrictive. The character that was a solution becomes a problem. This is not pathology — it is development. But it requires a willingness to mourn what was built in order to build something different.' },
  type: 'choice',
  prompt: `Something arrives — a loss, a limitation, a silence that can no longer be filled with activity — that puts the default pattern directly in your path. You cannot go around it. You have to decide what to do.`,
  choices: [
    {
      text: 'You go into it — allow the feeling fully, let the pattern be visible, let yourself be moved',
      tag: 'reflect',
      outcome: (e,t)=>`The feeling is larger than you expected. There is grief in it — not just for what you have lost now, but for older losses, the ones the pattern was built to protect you from.<br><br><em>Something gives way.</em> Not everything — not the whole structure — but something. A room opens that has been locked for a long time. What is in it is not catastrophic. It is just: you. The unaccommodated, unmanaged, wanting version of you that the default was designed to protect.<br><br>The work of integration begins here. It is slow. But it has begun.`,
      patternEcho: (t)=> hasTrait('reflect') ? 'You have been practising the pause for years. Here, it pays its largest dividend yet.' : null
    },
    {
      text: 'You intensify the pattern — more of what has always worked, applied with greater force',
      tag: 'intensify',
      outcome: (e,t)=>{
        const dominant = dominantTrait(['protest','appease','assert','withdraw_early']);
        const map = {
          protest: 'You become louder — more urgent, more demanding of others\' presence and attention. The relationships that can bear this weight hold; some that cannot begin to bow. The pattern is running at full power.',
          appease: 'You give more, accommodate more, reduce yourself further. The people in your life sense something slightly hollow in the generosity — as if the person offering it has temporarily left the building.',
          assert: 'You drive harder — in work, in relationships, in the positions you hold. The assertion is powerful but slightly breathless. You are running from something by running toward achievement.',
          withdraw_early: 'The withdrawal deepens. You are present in all the external senses — at the table, at the desk, in the room — but absent in the way that people who know you well can feel.'
        };
        return `<em>${map[dominant] || 'The default intensifies. The strategy that built your life is applied with full force to a problem it was not designed to solve.'}</em><br><br>It works, partially. Enough to avoid the reckoning for a little longer. The reckoning is patient.`;
      },
      patternEcho: (t)=> null
    },
    {
      text: 'You seek help — therapy, a trusted person, something outside the usual defenses',
      tag: 'reflect',
      outcome: (e,t)=>`You reach outside the pattern for the first time in a long time. <em>This is not weakness — it is the recognition that the pattern alone is insufficient.</em><br><br>What happens in this help-seeking is slow and often uncomfortable. The things that come up are not new — they are old, in new light. The default becomes visible from the outside, which is the only place it can truly be seen.<br><br>You begin, slowly, to have a relationship with your own character rather than simply living inside it. <em>This is what analysis — in any form — is actually for.</em>`,
      patternEcho: (t)=> null
    }
  ]
},

// ─────────────────────────────────────────────────────────
// STAGE 19 — PARENTHOOD (Age 32–40)
// ─────────────────────────────────────────────────────────
{
  id: 'parenthood',
  stageLabel: ()=>'Adulthood · Parenthood',
  stageGroup: 'The Cycle',
  title: 'The Stage Changes Hands',
  text: (e,t)=>`You are a parent now. Or you hold someone small in your care who depends on you entirely.<br><br>
The drama appears from the other side.<br><br>
You watch them — this small person — and you recognise everything. The way they look at you. The intensity of their wanting. The way your presence organises their world and your absence disorganises it. The triangle that is forming as they become aware of the other parent. The desire, undisguised, total, that children carry before they learn to manage it.<br><br>
And you notice something else: you are <em>in</em> the drama now, as one of its major figures. How you respond to their desire — their reaching toward you, their exclusion of the other, their small rages and declarations — is already shaping what they will carry.`,
  echo: (t)=>{
    const dominant = dominantTrait(['protest','secure_wait','withdraw_early','appease','assert','reflect']);
    const map = {
      protest: { label: 'Pattern Passing On', text: 'Your child\'s intensity meets yours. The urgency in them is familiar — possibly too familiar. Something is at risk of amplifying rather than metabolising. The work is to be moved by their feeling without being overwhelmed, to receive the cry without having your own.' },
      secure_wait: { label: 'Pattern Passing On', text: 'Your steadiness is a gift to them — the reliability, the warmth. There is a risk, small but real, of being so reliable that they never quite learn that absences are survivable. The "good enough" requires some gap.' },
      withdraw_early: { label: 'Pattern Passing On', text: 'Your child reaches toward you with full intensity. Something in you wants to step back from the intensity — to maintain some distance. This is your default, and children feel it. The work is to remain present even when presence feels overwhelming.' },
      appease: { label: 'Pattern Passing On', text: 'You want to give them everything they need. And you are in danger of giving them too much — of never introducing the frustration that teaches that desire is not omnipotent, that the world has structure, that "not everything can be had" is a gift rather than a punishment.' },
      reflect: { label: 'Pattern Passing On', text: 'The capacity to observe your own responses — to notice when their intensity is triggering something old in you — is your most valuable parenting tool. Not perfect. But present.' }
    };
    return map[dominant] || null;
  },
  insight: { label: 'Psychoanalytic Note', text: '"Parents lend their children the ego they are not yet equipped to use," wrote Winnicott. The parent\'s task is not to be perfect but to be, in Winnicott\'s phrase, "good enough" — present enough to provide security, fallible enough to provide the friction that develops the child\'s capacity to self-regulate. The parent who never frustrates produces a child who cannot bear frustration. The parent who always frustrates produces a child who cannot trust. The work is in the range.' },
  type: 'choice',
  prompt: `Your child is angry with you — genuinely, expressively angry — because you have said no to something they wanted. The full force of their feeling is directed at you.`,
  choices: [
    {
      text: 'You receive it — hold the limit and hold the relationship, even with their anger in the room',
      tag: 'parent_law',
      outcome: (e,t)=>`The anger is real. You feel the pull to give in, or to become authoritarian, or to leave the room — all versions of your own defaults. But you do neither. You hold.<br><br>You say: <em>"I can see you are very angry. You can be angry. The answer is still no."</em><br><br>This sentence — both things at once — is one of the most important sentences in development. It says: your feeling is real; reality is also real. Both of these can be true simultaneously.<br><br><em>They learn this. It will serve them for the rest of their life.</em>`,
      patternEcho: (t)=> hasTrait('reflect') ? 'The pause that you have been building for years is here, in its most important use. You are consciously not doing your default — and something better is happening instead.' : null
    },
    {
      text: 'You give in — the anger is too much, the limit dissolves',
      tag: 'parent_lost',
      outcome: (e,t)=>`The anger works. The limit gives way. They get what they wanted, and something is satisfied — in both of you, if you are honest.<br><br><em>But something else is registered, in both of you.</em> They learn: feeling applied with sufficient intensity produces results. The frustration that would have taught that desire is not omnipotent has been cancelled. <em>${hasTrait('appease') ? 'Your accommodation — which has been your signature — is now being transmitted. The self that could not hold its own limits is now unable to hold limits for another.' : 'The capitulation has costs that are not immediately visible.'}</em>`,
      patternEcho: (t)=> hasTrait('appease') ? 'Every time you fold to preserve peace, the message is transmitted: this is how people relate. Your child is learning your pattern.' : null
    },
    {
      text: 'You withdraw — you leave the room, you go somewhere until it has passed',
      tag: 'parent_lost',
      outcome: (e,t)=>`The anger is unmanageable, so you manage it by removing yourself from it. When you return, the storm has passed. But something lingers — a slight distance, a sense that the large feeling was too large to be held.<br><br><em>${hasTrait('withdraw_early') ? 'You are passing on, without choosing to, the lesson that very big feelings cannot be held by another person — that the appropriate response to overwhelming feeling is to be alone with it.' : 'The withdrawal communicates something you did not intend to communicate.'}</em><br><br>Your child will learn that their most intense feelings push people away. <em>This is not what you wanted to teach.</em>`,
      patternEcho: (t)=> hasTrait('withdraw_early') ? 'The retreat that began in infancy is now a parenting style. The pattern completes its generational circuit.' : null
    }
  ]
},

// ─────────────────────────────────────────────────────────
// STAGE 20 — LOOKING BACK (Age 45–55)
// ─────────────────────────────────────────────────────────
{
  id: 'looking_back',
  stageLabel: ()=>'Mid-Life · Age 45–55',
  stageGroup: 'Integration',
  title: 'What Was Made of It',
  text: (e,t)=>{
    const dominant = dominantTrait(['protest','secure_wait','withdraw_early','appease','assert','reflect','identify']);
    const reflectCount = traitCount('reflect');

    return `You are looking back now — not to dwell, but because the view from here is different from the view inside.<br><br>
You can see the arc of it: the early environment, the first solutions, the defaults that formed, the ways they travelled through school and love and work and parenthood, refining themselves, becoming more sophisticated, occasionally becoming visible enough to choose.<br><br>
${reflectCount >= 2
  ? 'You have had some practice at stepping outside the pattern — at seeing it while it was running. This is not a cure. But it has created, in some places, a little more room. A little more light. The automatic has become, in moments, slightly deliberate.'
  : reflectCount === 1
  ? 'You have touched, at least once, the edge of seeing the pattern from outside it. It is not yet a habit. But the contact has happened, and contact leaves traces.'
  : 'The pattern has run largely unchallenged — not because you are without consciousness, but because the defaults are so woven into who you are that the seams have become invisible. There is still time. There is always still time.'
}<br><br>
<em>${({
  enmeshed: 'What the Warm House gave you: the capacity for warmth, closeness, attunement. What it cost: some clarity about where you end and others begin. The work — if there is more work — is the recovery of the separate self, without the loss of the warmth.',
  cold: 'What the Orderly House gave you: competence, reliability, structure. What it cost: some easy access to your inner life, some fluency in the language of feeling. The work — if there is more work — is the recovery of what was managed away.',
  chaotic: 'What the Unpredictable House gave you: resilience, emotional intelligence, the ability to read a room. What it cost: some confidence in stillness, some ability to trust the ground when it is not moving. The work — if there is more work — is learning to rest.'
})[e]}</em>`;
  },
  insight: { label: 'Psychoanalytic Note', text: 'The goal of psychoanalysis is not the elimination of the past but its integration. "Where id was, ego shall be" — Freud\'s famous formulation — means: where something was driven by unconscious forces, bring the light of awareness. This does not make the unconscious disappear; it makes its products more available to choice. The past is not overcome; it is inhabited more consciously.' },
  type: 'narrative',
  buttonText: 'The curtain descends'
},

// ─────────────────────────────────────────────────────────
// STAGE 20b — THE CRACK (Age 48–58)
// Primary defense fails first, secondary briefly takes over,
// both collapse. Groove loosens — shape remains.
// ─────────────────────────────────────────────────────────
{
  id: 'the_crack',
  stageLabel: ()=>'Late Adulthood · The Crack',
  stageGroup: 'The Crack',
  title: 'What the Pattern Could Not Hold',
  text: (e,t)=>{
    const dom = dominantFamily();
    const cause = crackCause || dom;

    // Multiple crack causes varying by groove + environment
    const crackNarratives = {
      protest: {
        enmeshed: 'A relationship you have held with full urgency for years becomes suddenly, irrevocably unavailable. Not through conflict — through finality. A death, or a departure so complete it has the quality of death. The protest, which has always summoned a response, finds nothing to push against. The cry goes out and returns unanswered. <em>For the first time in your life, the urgency has no object.</em>',
        cold: 'The urgency that has driven your professional life brings you, at last, to a position of authority — and the authority brings not satisfaction but a kind of echoing emptiness. You have arrived. There is no next thing. The protest, which was always moving toward something, finds itself with nothing left to seek. <em>The engine runs on without fuel.</em>',
        chaotic: 'The hypervigilance that was always scanning for the next rupture misses one. Something happens — a crisis you did not see coming, that your pattern was specifically designed to anticipate. <em>The failure of the early warning system is more destabilising than any of the things it was watching for.</em>'
      },
      avoidant: {
        enmeshed: 'Someone who has been close to you for years names, with clarity and without malice, what they have experienced of your absence. Not your physical absence — your other absence. The one that has always been there, that you managed so well no one has ever said it out loud before. <em>The withdrawal that was invisible is suddenly, undeniably, visible.</em>',
        cold: 'Your body produces a symptom that cannot be managed, contained, or intellectualised away. An illness, a limitation, a physical fact that insists on itself. The self-sufficiency that has always been available is suddenly, specifically, not. <em>You need help. The word feels foreign.</em>',
        chaotic: 'A relationship you had trusted — perhaps the only one — breaks in a way that mirrors the original environment so precisely that the old panic returns, unmanaged, as if no time has passed. <em>You are twelve again. The years of distance-management have vanished.</em>'
      },
      assertive: {
        enmeshed: 'You hold a position — firmly, clearly, as you always have — and lose something irreplaceable because of it. Not through error, but through the cost of being someone who holds positions. The integrity and the loss arrive together. <em>For the first time, being right is not enough.</em>',
        cold: 'A moment arrives when what is needed is not direction or decision but simply presence — being with someone in their pain without fixing it, without offering anything, without being useful. <em>You find you do not know how to do this. The discovery is more shattering than the situation.</em>',
        chaotic: 'The directness that has always moved things forward produces, at last, a consequence that directness cannot undo. Something is broken that assertion cannot repair. <em>The tool that built your life has, for the first time, failed at the thing that matters most.</em>'
      },
      reflective: {
        enmeshed: 'You understand, with perfect clarity, why you are doing what you are doing — and you do it anyway. The insight that has always felt like a form of agency reveals itself, in this moment, as something else: a description of a process you are not actually controlling. <em>You see the hand on the lever and recognise it as yours, and cannot lift it.</em>',
        cold: 'Someone close to you tells you — gently, with evident care — that they do not feel known by you. That your understanding of them has always been accurate and somehow distant. That they have felt analysed rather than held. <em>The insight was real. It was not the same as intimacy.</em>',
        chaotic: 'You have spent years understanding the unpredictability of your origin — naming it, contextualising it, integrating it into a coherent narrative of yourself. The narrative, in this moment, offers no comfort. <em>Knowing why you are frightened does not make you less frightened.</em>'
      },
      secure: {
        enmeshed: 'The trust that has always been your ground — your deepest inheritance from the early months — is broken in a way that feels final. Not a gap to be waited through, but an ending. <em>For the first time, you do not know whether the ground will return.</em>',
        cold: 'A moment of genuine intimacy arrives — unexpected, unearned — and you cannot let it in. The machinery that would receive it is not working. You watch yourself deflect something you have always wanted. <em>The deflection is automatic. That is the worst part.</em>',
        chaotic: 'The stability you have built — carefully, deliberately, over decades — is threatened by something internal rather than external. A thought, a feeling, a truth about yourself that you have successfully not known. <em>The danger, this time, is not the ground. It is you.</em>'
      }
    };

    const narrative = (crackNarratives[cause]||crackNarratives[dom]||{})[e] ||
      'Something arrives that the pattern cannot metabolise. Not a large thing, necessarily — sometimes the crack comes through something small that lands in exactly the wrong place. The original compromise, which has managed everything until now, finds itself insufficient.';

    return `${narrative}<br><br>
<em>What happens next follows a familiar sequence — though you have never seen it from the inside before.</em><br><br>
The primary defense — the one that has been running since infancy — fails first. It simply stops working. What replaces it, briefly, is the secondary: the fallback, the thing you do when the main thing does not do. This holds for a moment. Then it, too, gives way.<br><br>
<em>What is left, in the space after both have gone, is something very simple and very unmanaged. You.</em>`;
  },
  insight: { school: 'Psychoanalytic Theory · Multiple Schools', label: 'On the Therapeutic Moment', text: 'Freud called it the "moment of encounter" — when the defenses, however elaborate, are temporarily insufficient and something unprocessed reaches the surface. Winnicott described it as a "breakdown that has already happened" — the crack is not the disaster; it is the belated arrival of an older disaster into consciousness. Klein would say the depressive position is being revisited — the integration of love and hate, the mourning of what was lost. Whatever the frame: the crack is not the end of development. It is, often, the beginning of the part that counts.' },
  type: 'choice',
  prompt: (e,t)=> 'In the gap — after the first defense has failed and before the second has fully taken over — there is a moment. Brief. Uncomfortable. Clearer than usual. What do you do with it?',
  choices: [
    {
      text: 'You stay in it — do not reach for the secondary, do not manage the moment away',
      tag: 'reflect',
      outcome: (e,t)=>{
        const dom = dominantFamily();
        const sec = secondaryDefense;
        return `The secondary is there — you can feel it available, the familiar fallback. You do not take it.<br><br>What happens in the gap is not comfortable. It is also not catastrophic — which is, itself, a discovery. The undefended state that the entire structure was built to prevent is survivable. It is not pleasant. But it is <em>real</em> in a way that managed experience has not quite been.<br><br>Something shifts. Not the original compromise — the shape remains what it is. But within the shape, there is slightly more room. A little more light. The original compromise is still there. <em>You are no longer entirely inside it.</em><br><br>${sec ? `The ${sec} that was your secondary defense is still available. You have simply learned that it is a choice rather than a necessity.` : ''}`;
      },
      patternEcho: (t)=> hasTrait('reflect') ? 'Every moment of pause you have practised across this lifetime has been preparation for this one. The pause holds.' : 'This is new. And it is enough.'
    },
    {
      text: 'The secondary defense activates — you move to the fallback, which holds briefly',
      tag: (()=>{ const s = secondaryDefense; return s ? {protest:'protest',avoidant:'withdraw_early',assertive:'assert',reflective:'reflect',secure:'secure_wait'}[s]||'appease' : 'appease'; })(),
      outcome: (e,t)=>{
        const sec = secondaryDefense;
        const secDesc = {
          protest: 'The urgency that was the secondary returns — a different quality of reaching out, slightly more desperate than the primary, because it was never the main event.',
          avoidant: 'The inward turn activates — quieter and more complete than usual, because it is the backup, not the usual route.',
          assertive: 'A clarity arrives — the secondary directness, colder and more brittle than the primary assertiveness, a form of control rather than expression.',
          reflective: 'The analysis activates — the secondary watching of the self, which is slightly more detached than the primary reflection, almost clinical.',
          secure: 'A waiting begins — the secondary patience, quieter and less certain than the primary trust, holding without quite believing.'
        }[sec] || 'The fallback runs.';
        return `${secDesc}<br><br>It holds for a time. And then — because this, too, is not equipped for what has arrived — it gives way.<br><br><em>What is left is the same unmanaged moment. It has simply been delayed. It waited.</em><br><br>You are in it now. The original compromise loosens. Not because you chose to loosen it, but because both strategies have, for once, been exhausted simultaneously. <em>The space that opens is unwilled and real.</em>`;
      },
      patternEcho: (t)=> 'The fallback ran. And then it too gave way. This is the first time both defenses have been simultaneously insufficient. Something that has never happened before has happened.'
    },
    {
      text: 'You seek something outside yourself — a person, a professional, a structure that is not yours',
      tag: 'reach_out',
      outcome: (e,t)=>`The reaching out is itself significant. The pattern — whichever one it is — tends toward self-management, toward handling things within the structure rather than beyond it. This moment of external reaching breaks that tendency.<br><br>What you find outside is imperfect, because everything outside is imperfect. But the imperfection is survivable, and the reaching is its own kind of repair — not of the situation, but of the belief that the situation must be survived alone.<br><br><em>The crack, from outside, looks like what it is: a place where something that was sealed has opened. The person or structure you have reached toward does not seal it back up. They sit with you in the opening.</em><br><br>The original compromise loosens here too. Slightly. Enough.`,
      patternEcho: (t)=> hasTrait('reach_out') ? 'You have reached out before. It worked before, imperfectly. The imperfection did not stop you then. It does not stop you now.' : 'Reaching out is against the grain of most of what you have built. You do it anyway. This is one of the more significant things that happens in this entire story.'
    }
  ]
},

// ─────────────────────────────────────────────────────────
// STAGE 21 — INTEGRITY VS DESPAIR (Age 65–75)
// Erikson's final psychosocial stage, coloured by groove
// ─────────────────────────────────────────────────────────
{
  id: 'integrity',
  stageLabel: ()=>'Late Life · Age 65–75',
  stageGroup: 'Integration',
  title: 'The Account',
  text: (e,t)=>{
    const dom = dominantFamily();
    const reflectCount = traitCount('reflect');
    const hadCrack = hasTrait('reflect') || hasTrait('reach_out');

    const groveReflections = {
      protest: `You have lived urgently. The reaching, the insistence, the refusal to accept that the gap is simply the gap — these have given your life its heat, its colour, its intensity. They have also cost you in the places where urgency could not hear what was being quietly offered.<br><br>${hadCrack ? 'The crack changed something. Not the urgency — that remains yours. But the urgency now knows itself, at least some of the time, as urgency. The desire and the self that carries it have been briefly distinguished from each other.' : 'The urgency has not quite been examined. It has simply, over the decades, slightly exhausted itself.'}`,
      avoidant: `You have lived carefully. The inward management, the reduction of exposure, the quiet competence that needs nothing — these have made you reliable, private, composed. They have also made you, at times, absent in the way that the people who loved you most could feel but could not name.<br><br>${hadCrack ? 'The crack made the absence visible to you, perhaps for the first time. Not to fix it — there is not much to fix at this point — but to know it. To include it in the account.' : 'The absence is still not quite named. It does not need to be. But there are moments, in the quiet, when something is noticed.'}`,
      assertive: `You have lived directly. The will has been the instrument — for building, for protecting, for insisting on the reality of your own desires against the accommodating pressure of the world. This is a form of integrity, and it has served you. It has occasionally left less room than it could have for what others needed to say.<br><br>${hadCrack ? 'The crack showed you, at last, the place where the directness could not reach. Something in you softened at that moment. The softening did not replace the directness. It joined it.' : 'The directness has been consistent. Its limits have been less visible to you than to the people around you.'}`,
      reflective: `You have lived consciously — or tried to. The watching of the self, the naming of the patterns, the practised pause between stimulus and response: these have been your instrument. They have made you perceptive, interesting, often kind. They have also, at times, substituted for the thing they were watching.<br><br>${hadCrack ? 'The crack showed you the gap between understanding and experiencing — that they are not the same thing, and that a life lived largely in understanding has its own kind of limitation. You have been integrating this. It has changed the quality of the reflection.' : 'The insight has been genuine throughout. Whether it has always been in the service of living, or sometimes in the service of not having to live fully — that question has not been fully answered.'}`,
      secure: `You have lived with faith — not religious faith, necessarily, but the faith that the gap closes, that the reliable return is real, that the world can be trusted more than it should be trusted, given the evidence. This has been a gift. To you, and to the people who have been able to rest near it.<br><br>${hadCrack ? 'The crack tested the faith — genuinely, not as an abstract proposition. The faith, having been tested, is different now. It is not smaller. It is more honest.' : 'The faith has not been deeply tested. It remains, therefore, slightly theoretical — generous and real, but not yet fully hardened in the way that tested things harden.'}`
    };

    return `Erikson called it integrity versus despair — the late-life task of looking back at the life and being able to say, without needing it to have been different, that it was <em>this</em> life, and that this life was enough.<br><br>
The opposite — despair — is not grief. Grief can coexist with integrity. Despair is the conviction that the life was wrong, that the choices were wrong, that there is no longer time to make them right, and that the wrong cannot be borne.<br><br>
${groveReflections[dom] || 'You look back.'}<br><br>
<em>You are looking at the whole of it now. The environment that shaped the first solutions. The oedipal drama and its residue. The original compromise that formed and deepened and occasionally, briefly, relaxed. The rupture that tested it. The crack, if there was one, that let in the light. The children, if there were children, who are carrying something forward that you gave them — not entirely consciously, not entirely by choice.</em>`;
  },
  insight: { school: 'Ego Psychology · Erik Erikson', label: 'Integrity vs. Despair', text: "Erikson's eighth and final psychosocial stage identifies the central task of late life as the achievement of ego integrity — the ability to look back on one's life with acceptance rather than regret. This is not complacency; it is a form of honesty. The person who achieves integrity does not claim their life was without error. They claim it as their own — the particular, irreducible, unrepeatable shape of this one existence. Despair, by contrast, is the refusal of that acceptance — often driven by the sense that there is no longer time to do otherwise." },
  type: 'choice',
  prompt: 'You are holding the account of it. Not assessing it — holding it. What is the quality of the holding?',
  choices: [
    {
      text: 'Something close to acceptance — not without grief, but without the need for it to have been different',
      tag: 'repair',
      outcome: (e,t)=>{
        const dom = dominantFamily();
        const reflectCount = traitCount('reflect');
        return `The acceptance is not simple — it is a complex thing, woven from grief and recognition and something that might be called gratitude, though that word can feel too easy.<br><br>
What you accept is not a perfect life. The original compromise ran where it ran. The rupture landed where it landed. The crack, if it came, opened what it opened. The people you loved were loved imperfectly, in the shape your character allowed.<br><br>
<em>What you accept is: this. Specifically this. The particular life that grew from the particular soil of the particular house you were born into, with the particular first face that organised your world.</em><br><br>
${reflectCount >= 2 ? 'You have been building toward this acceptance for decades. The reflection was always in its service — the consciousness not as an end in itself, but as the instrument by which the life could eventually be claimed.' : 'The acceptance arrives without having been exactly worked toward. It is not insight that produces it. It is simply time, and the weight of the whole thing, and the surprising discovery that the weight can be borne.'}<br><br>
<em>Integrity. The account is full. You are in it.</em>`;
      },
      patternEcho: null
    },
    {
      text: 'A heaviness — grief for the unlived version, for what the original compromise prevented',
      tag: 'collapse',
      outcome: (e,t)=>{
        const dom = dominantFamily();
        return `The grief is real and honest — not pathological, not despair exactly, but close to it. The life was what it was, and the life was shaped by what it was shaped by, and some of what it was shaped by was not chosen and could not have been otherwise — and yet.<br><br>
<em>And yet.</em><br><br>
The version that did not get lived — the one where the original compromise was looser from the beginning, where the early solutions were less necessary, where the costs were smaller — is present as an absence. You know it only as a shape that is missing.<br><br>
${hasTrait('reflect') ? 'The consciousness that has been your instrument turns, here, on the consciousness itself. You understand the grief. Understanding it does not reduce it. This is the place where reflection reaches its limit.' : 'The feeling does not have a name you fully trust. It is not quite regret. It is not quite loss. It is something more diffuse and more total.'}<br><br>
<em>Despair and integrity are not so far apart as Erikson's formulation suggests. Sometimes the grief for the unlived is the most honest possible response to the life that was. You are not wrong to feel it.</em>`;
      },
      patternEcho: (t)=> 'The original compromise produced this grief too. Not as a failure — as an honest reckoning. You are seeing the cost clearly, perhaps for the first time.'
    },
    {
      text: 'Something that resists easy naming — not acceptance, not despair, but a sustained looking',
      tag: 'reflect',
      outcome: (e,t)=>`You do not resolve it. The account remains open — not because it is unfinished, but because the act of looking turns out to be the thing, not the conclusion the looking reaches.<br><br>
Integrity, perhaps, is not a state you arrive at. It is a quality of attention — the willingness to keep looking at the life without needing it to resolve into something clean.<br><br>
<em>You look at the original compromise. You look at what it was for. You look at the environment that made it necessary. You look at the child who found the first solution in the dark, without help, with only the materials available.</em><br><br>
Something in you — the part that has always watched — watches that child with something that is not quite compassion, not quite distance. It is both. The appropriate response to a self that was doing, from the beginning, the only thing it knew how to do.<br><br>
<em>The account is not closed. The looking continues. This, too, is a kind of integrity.</em>`,
      patternEcho: (t)=> hasTrait('reflect') ? 'The witness that has been present throughout your life is present here too. It does not conclude. It continues. This may be enough.' : null
    }
  ]
},

// ─────────────────────────────────────────────────────────
// STAGE 21 — FINALE
// ─────────────────────────────────────────────────────────
{
  id: 'finale',
  stageLabel: ()=>'Integration',
  stageGroup: 'Resolution',
  title: 'What You Carry',
  text: (e,t)=>`The curtain does not fall on the inner theatre. It never does, entirely. The drama continues — in dreams, in the texture of your relationships, in what moves you without knowing why, in the kinds of love that feel possible and the kinds that remain just out of reach.<br><br>
But you have moved through it. You arrived as sensation — pure, undivided, pre-verbal. You were held, and frustrated, and mirrored, and sometimes misread. You desired what you could not have, and learned, slowly, that this prohibition was not punishment but structure — the architecture that made desire possible in the first place.<br><br>
You identified with your rivals. You displaced your first loves. You brought your defaults to the schoolyard, to the workplace, to the bedroom, to the crib of your own child. At each stop, the pattern ran — and at some stops, you noticed it running.<br><br>
<em>That noticing — however partial, however late — is what makes you not merely the product of your history, but also, in some degree, its author.</em><br><br>
The theatre rests. The players breathe. Somewhere, a child is being born into a warm face or a cool one, a reliable presence or an uncertain one — and is beginning, right now, to build their first solution to the oldest problem.<br><br>
<em>The complex does not end. It cycles. Each generation has the chance to play it a little more consciously than the last.</em>`,
  insight: {
    label: 'Freud\'s Final Word',
    text: '"One day, looking back, I shall be able to see what these years were for." The Oedipus complex is not a wound to be healed. It is the scar that made us human: social, symbolic, capable of love and rivalry and culture, and forever reaching beyond what we can hold.'
  },
  type: 'end'
}

]; // end stages

  // ── ACE INJECTION ───────────────────────────────────────────
  if (difficulty === 0) return stages;

  if (difficulty >= 1) {
    var i1 = stages.findIndex(function(s){ return s.id === 'trust_builds'; });
    if (i1 >= 0) stages.splice(i1 + 1, 0, aceStage_parentStruggles());
    var i2 = stages.findIndex(function(s){ return s.id === 'latency'; });
    if (i2 >= 0) stages.splice(i2 + 1, 0, aceStage_middleDisruption());
  }
  if (difficulty >= 2) {
    var i3 = stages.findIndex(function(s){ return s.id === 'separation_1'; });
    if (i3 >= 0) stages.splice(i3 + 1, 0, aceStage_earlyThreat());
    var i4 = stages.findIndex(function(s){ return s.id === 'friendship'; });
    if (i4 >= 0) stages.splice(i4 + 1, 0, aceStage_cumulativeToll());
  }

  return stages;
} // end buildStages


// ── ACE STAGE DEFINITIONS ─────────────────────────────────────────────────────
// Each ACE stage is a choice-stage: not just something that happens to you,
// but a moment of coping that reinforces or complicates the original compromise.

function aceStage_earlyThreat() {
  // DEEP WATERS only — injected after separation_1 (age ~12 months)
  // Preverbal: rendered as fragmented sensory words, no real choice — narrative only
  return {
    id: 'ace_early_threat',
    type: 'narrative',
    preverbal: true,
    stageGroup: 'Adverse Event',
    stageLabel: function() { return 'ACE · Age 0–12 months'; },
    title: 'Before Memory',
    text: function(e) {
      var words = {
        enmeshed: ['Gone.','Different.','Gone.','Back,','but different.','The warmth is there.','Something behind it has changed.'],
        cold:     ['Absent.','Different hands.','Not wrong.','Efficient.','But not hers.','The body registers:','this is not the original.'],
        chaotic:  ['Gone.','Gone longer.','Very loud,','then very quiet.','Back.','Then gone again.','Do not settle.','Do not rely on return.']
      }[e];
      var wordsHtml = words.map(function(w, i) {
        return '<span class="word" style="animation-delay:' + (i * 0.55) + 's">' + w + '</span>';
      }).join(' ');
      var caption = {
        enmeshed: 'Postnatal depression, or illness, or an absence the family does not speak about. The warmth is real but interrupted. The face, when it appears, is sometimes not quite there.',
        cold:     'A hospitalisation — hers, or yours. A period of early separation the adults remember as brief. The body recorded a different duration.',
        chaotic:  'A crisis in the household — a departure, a threat, a period when the ordinary rhythms of care are disrupted. The nervous system, at this age, records all of it.'
      }[e];
      return '<div class="preverbal-text">' + wordsHtml + '</div>' +
        '<p style="font-family:"Cormorant Garamond",serif;font-size:1.05rem;line-height:1.95;color:rgba(240,232,216,0.78);font-style:italic;text-align:center;margin-top:22px">' +
        caption + '</p>' +
        '<p style="font-family:"Cormorant Garamond",serif;font-size:0.92rem;color:rgba(200,180,150,0.65);font-style:italic;text-align:center;margin-top:8px">This will not be remembered. It is already too deep for memory. The body knows.</p>';
    },
    insight: {
      school: 'Attachment Theory · Main & Hesse',
      label: 'When the Attachment System Is Overwhelmed',
      text: 'Disorganised attachment occurs when the caregiver is simultaneously the source of threat and the only available source of comfort. The infant faces an irresolvable conflict: approach or flee? The resolution is a collapse of the system — freezing, dissociation, fragmentation. Main and Hesse documented how this early pattern predicts difficulty with affect regulation, particular vulnerability in intimate relationships, and a tendency under stress to lose the coherence that organised attachment provides. It is not destiny. But it is a weight that is carried.'
    },
    buttonText: 'The body carries it forward'
  };
}

function aceStage_parentStruggles() {
  // TROUBLED + DEEP WATERS — injected after trust_builds (age ~18 months to 3)
  return {
    id: 'ace_parent_struggles',
    type: 'choice',
    stageGroup: 'Adverse Event',
    stageLabel: function() { return 'ACE · Age 2–4'; },
    title: 'Something Changes in the House',
    text: function(e) {
      var what = {
        enmeshed: 'Your mother falls ill — not dramatically, but persistently. She is there, but not fully there. The warmth is present in form but something behind it has gone quiet. You are two or three. You do not have a word for depression. You have a body that registers: <em>she is different, and I do not know what I did.</em>',
        cold:     'Your father loses his position. The house does not change visibly — your parents are competent at concealment — but something is present in the air that was not there before. A tension. The child who has already learned to read ambient signals reads this one clearly: <em>something is wrong, and asking about it will not help.</em>',
        chaotic:  'There is a period — weeks, maybe months — when things are worse than usual. The unpredictability that was always present intensifies. Something is happening between your parents that you are not told. The floor, which was always slightly uncertain, becomes genuinely unsafe.'
      }[e];
      return what + '<br><br><em>The child who has already begun to form a solution to the problem of love and disappointment now faces a harder version of the problem.</em>';
    },
    insight: {
      school: 'ACE Research · Felitti & Anda',
      label: 'What Adversity Does to the Developing Compromise',
      text: 'The ACE (Adverse Childhood Experiences) study found dose-response relationships between early adversity and adult outcomes across physical health, mental health, and relational capacity. The mechanism is not destiny — it is the narrowing of adaptive options. Under sustained pressure, the child’s repertoire of responses contracts toward the single strategy that has most reliably produced safety. The original compromise becomes less a preference and more a compulsion.'
    },
    prompt: function(e) { return 'The change is real. You feel it before you can name it. What does the body do?'; },
    choices: [
      {
        text: 'You press toward the source of the difficulty — more present, more needing, more visible',
        tag: 'protest',
        outcome: function(e) {
          return 'The urgency doubles. The gap produced by this change is treated like every other gap — something to close by the force of feeling. Sometimes it works. Sometimes the adult is too depleted to respond. Each time they cannot respond, the urgency increases a little more. <em>The protest deepens its groove.</em>';
        }
      },
      {
        text: 'You become very still — watchful, careful, making yourself easy to manage',
        tag: 'appease',
        outcome: function(e) {
          return 'You read that the household has less capacity right now. Without deciding, you adjust: quieter, less demanding, more cooperative. The adults notice — with relief, or with approval. <em>The self learns: when things are hard, become less.</em> It is a generous impulse. It will outlast its usefulness by decades.';
        }
      },
      {
        text: 'You find something to organise yourself around — a routine, a game, a private world',
        tag: 'withdraw_early',
        outcome: function(e) {
          return 'The outer world has become unreliable, so you build an inner one. A set of games, a corner, a sequence of private rituals you control entirely. <em>The self begins to find its ground inside rather than outside.</em> This will become a real resource — and also a real limit. The inner world is rich. The outer world is where other people are.';
        }
      }
    ]
  };
}

function aceStage_middleDisruption() {
  // TROUBLED + DEEP WATERS — injected after latency (age ~7-9)
  return {
    id: 'ace_middle_disruption',
    type: 'choice',
    stageGroup: 'Adverse Event',
    stageLabel: function() { return 'ACE · Age 7–9'; },
    title: 'The Ground Shifts',
    text: function(e) {
      var what = {
        enmeshed: 'Your family moves. Not far — but far enough. The school, the friends, the neighbourhood that gave your self its landmarks — all changed. Your mother takes the disruption harder than expected, and the child who has learned to feel what she feels finds themselves mourning something they cannot name, half of which belongs to her.',
        cold:     'A significant loss arrives — a grandparent, or the sudden end of something that had provided structure. Your parents process grief the way they process everything: efficiently, privately, with minimal acknowledgment of its size. The child learns: some things are simply not spoken of. The grief has nowhere to go.',
        chaotic:  'A period of genuine instability — financial pressure felt in the texture of daily life, or the parents’ relationship reaching a crisis that cannot be entirely concealed. The child who has been managing unpredictability must now manage a more acute version of it.'
      }[e];
      return what + '<br><br><em>You are seven, eight, nine. Old enough to understand more than you can say. Too young to do anything but adapt.</em>';
    },
    insight: {
      school: 'Developmental Psychology · Latency Period',
      label: 'Middle Childhood and the Consolidation of Character',
      text: 'The latency period is when the ego’s defensive structures consolidate. Under ordinary conditions this allows increasing social competence and the gradual relaxation of oedipal intensity. Under adverse conditions, the consolidation happens around the adaptive strategy rather than expanding it: the child at nine emerges with a more rigid, more comprehensive version of whatever they developed at two and five. The original compromise becomes structural — a habit of self rather than a response to a situation.'
    },
    prompt: function(e) { return 'The disruption is real. You are old enough now to feel its full weight. How do you carry it?'; },
    choices: [
      {
        text: 'You speak about it — to a parent, a friend, whoever seems able to hear',
        tag: 'protest',
        outcome: function(e) {
          var r = {
            enmeshed: 'Your mother receives it — the warmth re-activates, the attention focuses. You are held. The difficulty is witnessed. <em>The repair is genuine but incomplete — the source of the weight is still there, and the speaking has become entangled with her feeling as well as yours.</em>',
            cold:     'The speaking produces a careful, practical response. The feeling is acknowledged and then redirected. <em>You learn: expressing the feeling gets you a framework, not a witness.</em> You speak less, after this. But you never entirely stop.',
            chaotic:  'On a good day, it is received with warmth and real contact. On a bad day, the speaking ignites something. <em>You become strategic about when to speak, which is a kind of wisdom — and also a kind of loss.</em>'
          }[e];
          return r;
        }
      },
      {
        text: 'You absorb it quietly — telling yourself it is manageable, finding ways to function',
        tag: 'withdraw_early',
        outcome: function() {
          return 'The resilience here is real — you continue to show up, to maintain the surface of ordinary life. <em>What is less visible is the cost of the absorption.</em> The feeling does not disappear; it finds somewhere else to live — in the body, in a background heaviness, in a relationship to difficulty that quietly asks you to always be stronger than the situation requires.';
        }
      },
      {
        text: 'You find a peer — someone else who seems to know something about difficulty',
        tag: 'secure_wait',
        outcome: function() {
          return 'Without quite knowing what you are doing, you locate someone outside the family who seems to understand something about difficulty. The friendship is partly ordinary and partly something else — a witness, a fellow traveller. <em>This is the first experience of support found outside the original structure.</em> It will matter more than it seems.';
        }
      }
    ]
  };
}

function aceStage_cumulativeToll() {
  // DEEP WATERS only — injected after friendship (age ~10-11)
  return {
    id: 'ace_cumulative_toll',
    type: 'choice',
    stageGroup: 'Adverse Event',
    stageLabel: function() { return 'ACE · Age 10–11'; },
    title: 'The Weight of It',
    text: function(e) {
      var what = {
        enmeshed: 'You have been managing your mother’s emotional world for longer than you know. It happens so naturally — you feel what she feels before she names it; you adjust to protect the warmth of the house; you have learned not to need things that would take from her — that you have almost stopped noticing it is happening. <em>This is what parentification looks like from the inside: not like a burden, but like love.</em>',
        cold:     'You have been performing competence for longer than you know. The house requires a certain quality — capable, self-sufficient, not too feeling — and you have produced it reliably. The cost of this production is not visible to anyone, including you.',
        chaotic:  'You have been on alert for longer than you know. The hypervigilance that the house required has been exhausting in a way that is hard to name — not dramatic exhaustion, but a background depletion. The nervous system has been running high for years.'
      }[e];
      return what + '<br><br><em>This is what sustained adversity produces: not a single wound, but a narrowing. A body and mind that have been asked to work too hard, for too long, in too small a space.</em>';
    },
    insight: {
      school: 'Complex Trauma · Herman / van der Kolk',
      label: 'Complex Developmental Trauma',
      text: 'Complex PTSD — distinguished from single-event PTSD — develops from chronic, repeated adversity in childhood, particularly when it involves the caregiving relationship. The symptoms are not flashbacks so much as a persistent alteration in self-perception, affect regulation, relational capacity, and the ability to sustain hope. Herman, van der Kolk, and others document how the child who grows up under sustained adversity reorganises the self around survival rather than flourishing — an adaptation that is intelligent in the original environment and costly in every subsequent one.'
    },
    prompt: function() { return 'You are old enough to feel the weight — or at least to feel that something is heavy, even if you cannot say what. What do you do with that?'; },
    choices: [
      {
        text: 'You find somewhere to put it — a creative practice, a private ritual, something that can hold the weight',
        tag: 'reflect',
        outcome: function() {
          return 'Without knowing this is what you are doing, you begin to create a container for what has accumulated. A notebook. A practice of some kind — physical, imaginative — that takes the weight and gives it form. <em>This is the early form of what will later become sublimation: the capacity to transform difficult feeling into something that can be held, and eventually shared.</em>';
        }
      },
      {
        text: 'You carry it forward without putting it down — managing, functioning, keeping the surface intact',
        tag: 'appease',
        outcome: function() {
          return 'The functioning is real. From the outside, you are fine — more than fine, often: the child who does not add to the household’s difficulty. <em>Inside, the weight accumulates without acknowledgment.</em> This is the mechanism by which adversity becomes invisible: the child who carries it most competently is the least likely to be offered help.';
        }
      },
      {
        text: 'You let it show — not dramatically, but you stop entirely concealing it',
        tag: 'protest',
        outcome: function(e) {
          var r = {
            enmeshed: 'Your mother sees it. Something in her responds — the warmth re-activates. You are held. <em>The repair is real and incomplete: the source of the weight is still there. But the seeing mattered.</em>',
            cold:     'The showing produces a careful response — concern, a conversation that addresses the surface. <em>The depth is not reached. But the surface contact was real, and something was communicated, even imperfectly received.</em>',
            chaotic:  'The response is unpredictable. Today it is warmth and real contact. Another day it might be more difficulty. But the letting-show was an act of self-assertion — a refusal to entirely disappear. <em>That refusal is its own kind of resource.</em>'
          }[e];
          return r;
        }
      }
    ]
  };
}



// ═══════════════════════════════════════════════════════════
// RENDERING ENGINE
// ═══════════════════════════════════════════════════════════

function showEnvSelect() {
  document.getElementById('title-screen').classList.add('hidden');
  document.getElementById('env-screen').classList.remove('hidden');
}

function selectEnv(envKey) {
  env = envKey;
  document.getElementById('env-screen').classList.add('hidden');
  document.getElementById('difficulty-screen').classList.remove('hidden');
  try { window.scrollTo({ top: 0, behavior: 'smooth' }); } catch(e) { window.scrollTo(0,0); }
}

function selectDifficulty(level, card) {
  difficulty = level;
  document.querySelectorAll('.difficulty-card').forEach(function(c) { c.classList.remove('selected'); });
  card.classList.add('selected');
  document.getElementById('difficulty-begin-btn').classList.add('active');
}

function beginGame() {
  stageList = buildStages();
  document.getElementById('difficulty-screen').classList.add('hidden');
  document.getElementById('game-header').classList.remove('hidden');
  document.getElementById('trait-panel').classList.remove('hidden');
  document.getElementById('game-scene').classList.remove('hidden');
  try { window.scrollTo({ top: 0, behavior: 'smooth' }); } catch(e) { window.scrollTo(0,0); }
  renderStage(0);
}

// ── ORIGINAL COMPROMISE SYSTEM ─────────────────────────────
// Maps each choice tag to its "family" — tags in the same
// family share compromise score.
const COMPROMISE_FAMILIES = {
  protest:        'protest',
  secure_wait:    'secure',
  withdraw_early: 'avoidant',
  appease:        'avoidant',
  assert:         'assertive',
  identify:       'assertive',
  ambivalent:     'avoidant',
  desire_rage:    'protest',
  desire_grief:   'secure',
  desire_redirect:'assertive',
  reflect:        'reflective',
  repair:         'secure',
  parent_law:     'assertive',
  parent_lost:    'avoidant',
  parent_warm:    'secure',
  intensify:      'protest',
};

// Returns total compromise score for a given family
function familyScore(family) {
  let score = 0;
  for (const [tag, fam] of Object.entries(COMPROMISE_FAMILIES)) {
    if (fam === family) score += (traits[tag] || 0);
  }
  return score;
}

// Returns the dominant family
function dominantFamily() {
  const families = ['protest','secure','avoidant','assertive','reflective'];
  return families.reduce((a, b) => familyScore(a) >= familyScore(b) ? a : b);
}

// Returns character class for a choice given its tag
// compromiseDepth: total choices made so far (stages completed)
function getCompromiseClass(choiceTag, compromiseDepth, allChoiceTags) {
  // ACEs narrow adaptive options — lower the activation threshold
  var minDepth = difficulty >= 2 ? 3 : difficulty >= 1 ? 4 : 5;
  if (compromiseDepth < minDepth) return '';

  const dom = dominantFamily();
  const choiceFamily = COMPROMISE_FAMILIES[choiceTag] || choiceTag;
  const domScore = familyScore(dom);

  // Dominant family: always free of resistance.
  // Only add the gold highlight once well-established (score >= 5),
  // but either way — no groove class, no modal, no clicks needed.
  if (choiceFamily === dom) {
    return domScore >= 5 ? 'char-dominant' : '';
  }

  // Use CHOICE COUNT as the fade driver, not raw score gap.
  // A choice family that has NEVER been chosen fades gradually
  // based on how many total choices have been made.
  // This means early on, all choices stay readable.
  const choiceScore = familyScore(choiceFamily);

  // Only start fading if the choice family has significantly fewer
  // selections than the dominant (at least half as many fewer)
  const relativeGap = domScore - choiceScore;
  const fadeThreshold = Math.ceil(domScore * 0.6); // 60% of dominant score
  if (relativeGap < fadeThreshold) return '';

  // Slow ramp: compromiseDepth drives how deep the fade goes
  // Stage 8  (depth 5-7):  can reach groove-1
  // Stage 14 (depth 8-11): can reach groove-2
  // Stage 18+ (depth 12+): can reach groove-3
  // ACEs accelerate the deepening — thresholds shift down under adversity
  var g1 = difficulty >= 2 ? 5  : difficulty >= 1 ? 6  : 7;
  var g2 = difficulty >= 2 ? 8  : difficulty >= 1 ? 9  : 11;
  var g3 = difficulty >= 2 ? 11 : difficulty >= 1 ? 13 : 15;
  let level = 0;
  if (compromiseDepth >= g1) level = 1;
  if (compromiseDepth >= g2) level = 2;
  if (compromiseDepth >= g3) level = 3;

  if (level <= 0) return '';

  // If no choice on this stage belongs to the dominant family,
  // don't apply groove effects — there's nothing to steer toward.
  const hasDomChoice = allChoiceTags.some(t => (COMPROMISE_FAMILIES[t]||t) === dom);
  if (!hasDomChoice) return '';

  // Guarantee at least one non-dominant choice stays at groove-1 max
  const nonDomTags = allChoiceTags.filter(t => (COMPROMISE_FAMILIES[t]||t) !== dom);
  const bestNonDom = nonDomTags.reduce((best, t) =>
    familyScore(COMPROMISE_FAMILIES[t]||t) >= familyScore(COMPROMISE_FAMILIES[best]||best) ? t : best,
    nonDomTags[0]);
  const isLeastFaded = bestNonDom === choiceTag;
  const maxLevel = isLeastFaded ? 1 : 3;
  const finalLevel = Math.min(level, maxLevel);

  if (finalLevel === 1) return 'groove-1';
  if (finalLevel === 2) return 'groove-2';
  return 'groove-3';
}

// Subtle text morphing: adds a prefix phrase that makes
// against-grain choices feel slightly foreign/effortful
const AGAINST_GRAIN_PREFIXES = {
  protest:    ["Something unfamiliar stirs — ", "Against every instinct — ", "This feels wrong, and yet — "],
  avoidant:   ["It would be easier to disappear, but — ", "Something in you resists the retreat — ", "You stay when you want to go — "],
  assertive:  ["The words do not come naturally — ", "You reach for something you do not usually use — ", "Quieter than you usually move — "],
  reflective: ["For once — ", "Something slows — ", "A pause, uncharacteristic — "],
  secure:     ["With more trust than you feel — ", "Borrowing a patience not yet fully yours — ", ""],
};

function getAgainstCompromisePrefix(choiceTag, compromiseDepth) {
  if (compromiseDepth < 3) return null;
  const dom = dominantFamily();
  const choiceFamily = COMPROMISE_FAMILIES[choiceTag] || choiceTag;
  if (choiceFamily === dom) return null;
  const domScore = familyScore(dom);
  const gap = domScore - familyScore(choiceFamily);
  if (gap < 2) return null;
  const prefixes = AGAINST_GRAIN_PREFIXES[choiceFamily] || [];
  if (!prefixes.length) return null;
  return prefixes[Math.floor(Math.random() * prefixes.length)];
}

// ── PARALYSIS TEXT ─────────────────────────────────────────
// When primary and secondary defenses are both activated by a choice,
// the player gets a moment of recognised conflict before choosing.
function getCompromiseConflictText(primary, secondary) {
  const combos = {
    'protest+avoidant': 'Something pulls in both directions at once. The urgency that usually carries you forward is met, this time, by an equally familiar pull inward — the part of you that learned, somewhere, that wanting loudly enough only exhausts you. Neither impulse feels wrong. Neither feels quite right.',
    'protest+assertive': 'The familiar urgency rises — and behind it, another voice: the part of you that knows how to move directly, without heat. They are not the same thing. One is about feeling; the other is about will. Right now they are pointing in different directions.',
    'protest+reflective': 'The old urgency is there — the reaching, the pressure, the need to act. And under it, quieter, is something that has been learning to pause. They have not yet learned to work together. You feel the friction between them.',
    'avoidant+protest': 'The retreat beckons — and so does the cry. You have built your life between these two impulses. They are both yours. Neither can give you what it promises right now.',
    'avoidant+assertive': 'You want to withdraw — and you want to hold your ground. These feel like the same thing, and they are not. The first is about reducing yourself; the second is about remaining. The difference, right now, feels crucial and hard to locate.',
    'avoidant+reflective': 'The inward turn is there, as always. But something else has been building — a capacity to look at the turn itself, to see it before it has fully happened. You are caught between the habit and the witness.',
    'assertive+avoidant': 'The part of you that moves directly forward is meeting the part that knows how to go quiet. They have not been in the same room like this before.',
    'assertive+protest': 'The clear, directed will is present. So is the urgency — older, louder, less patient. You recognise both as yours. They are offering different advice.',
    'assertive+reflective': 'You know what you want to do. You also know, from recent practice, that knowing what you want to do is not always the same as knowing what to do. The pause and the action are both available. Choosing between them feels oddly significant.',
    'reflective+avoidant': 'The habit of reflection is here — but reflection has its own way of withdrawing. You notice that your noticing may itself be a form of absence. This is uncomfortable.',
    'reflective+protest': 'The pause is available. So is the urgency. You are aware enough, now, to see both — and aware enough to know that seeing them does not resolve them.',
    'reflective+assertive': 'You can see what is happening clearly. Clarity and action are not the same thing. Something in you knows what should be done; something else is waiting for the right moment, which may not come.',
  };
  const key = `${primary}+${secondary}`;
  return combos[key] || `Two parts of you are pulling in different directions. You have been here before — but rarely with this much awareness of it. The awareness does not make it easier. It makes it more honest.`;
}

// ── RENDER ─────────────────────────────────────────────────

function renderStage(idx) {
  const stage = stageList[idx];
  if (!stage) return;
  stageIndex = idx;

  document.getElementById('stage-indicator').textContent =
    typeof stage.stageGroup === 'function' ? stage.stageGroup(env) : stage.stageGroup;

  const pct = Math.round((idx / (stageList.length - 1)) * 100);
  document.getElementById('psyche-fill').style.width = pct + '%';
  document.getElementById('progress-label').textContent = `${idx + 1} / ${stageList.length}`;

  const ageLabel = typeof stage.stageLabel === 'function' ? stage.stageLabel(env) : (stage.stageLabel||'');
  const title    = typeof stage.title === 'function' ? stage.title(env, traits) : stage.title;
  const text     = typeof stage.text  === 'function' ? stage.text(env, traits) : stage.text;
  const insight  = stage.insight ? (typeof stage.insight === 'function' ? stage.insight(env, traits) : stage.insight) : null;
  const echo     = stage.echo ? stage.echo(traits) : null;

  // Count how many choice-stages have been completed
  const compromiseDepth = Object.keys(choiceHistory).length;

  let html = `
    <div class="age-label">${ageLabel}</div>
    <div class="scene-title">${title}</div>
    <div class="scene-text">${text}</div>
  `;

  if (echo) {
    html += `<div class="echo-box"><div class="echo-label">${echo.label}</div><div class="echo-text">${echo.text}</div></div>`;
  }
  if (insight) {
    const schoolTag = insight.school ? `<span class="school-label">${insight.school}</span>` : '';
    html += `<details class="insight-box"><summary class="insight-toggle"><span class="insight-label">${insight.label}</span><span class="insight-caret">▶</span></summary><div class="insight-text">${schoolTag}${insight.text}</div></details>`;
  }

  if (stage.type === 'choice') {
    const prompt = typeof stage.prompt === 'function' ? stage.prompt(env, traits) : stage.prompt;
    html += `<div class="scene-text" style="color:var(--aged);font-style:italic;margin-top:6px;">${prompt}</div>`;

    // Detect paralysis: primary and secondary defenses both represented in choices
    const allChoiceTags = stage.choices.map(function(c) { return typeof c.tag === 'function' ? c.tag() : c.tag; });
    const dom = dominantFamily();
    const choiceFamilies = allChoiceTags.map(t => COMPROMISE_FAMILIES[t]||t);
    const isParalysis = secondaryDefense &&
      choiceFamilies.includes(dom) &&
      choiceFamilies.includes(secondaryDefense) &&
      compromiseDepth >= 4;

    if (isParalysis) {
      html += `<div class="paralysis-note">${getCompromiseConflictText(dom, secondaryDefense)}</div>`;
    }

    html += `<div class="choices-area${isParalysis ? ' paralysed' : ''}" id="choices-area">`;

    stage.choices.forEach((c, i) => {
      const rawText = typeof c.text === 'function' ? c.text(env, traits) : c.text;
      var cTag = typeof c.tag === 'function' ? c.tag() : c.tag;
      const charClass = getCompromiseClass(cTag, compromiseDepth, allChoiceTags);
      const isGone = charClass === 'groove-4';
      const clicksNeeded = getClicksNeeded(charClass);
      // data-clicks-needed stores required clicks; data-clicks-done tracks progress
      const dataAttrs = clicksNeeded > 1
        ? `data-clicks-needed="${clicksNeeded}" data-clicks-done="0"`
        : '';
      html += `<button class="choice-btn ${charClass}" onclick="handleChoiceClick(this,${i})" data-choice-idx="${i}" ${dataAttrs}>${rawText}</button>`;
    });

    html += `</div>`;

    // Character depth hint — appears once character is established
    if (compromiseDepth >= 6 && familyScore(dominantFamily()) >= 3) {
      const hints = {
        protest:   'The original compromise is set. The urgent path is well-worn.',
        avoidant:  'The original compromise holds. The inward path is so familiar now.',
        assertive: 'The original compromise holds. The direct path is your ground.',
        reflective:'The original compromise is forming. The pause is becoming second nature.',
        secure:    'The original compromise is forming. The faith in the gap holds.',
      };
      const hint = hints[dominantFamily()];
      if (hint) html += `<div style="font-family:"Cormorant Garamond",serif;font-size:0.82rem;color:rgba(196,160,72,0.82);font-style:italic;text-align:right;margin-top:4px;padding-right:4px;">${hint}</div>`;
    }

  } else if (stage.type === 'end') {
    html += `
      <div style="text-align:center;padding:16px 0 4px">
        <div class="resolution-badge">⚘  The Theatre Rests  ⚘</div>
      </div>
      <button class="continue-btn" style="align-self:center" onclick="showFinalResolution()">See your psychic portrait</button>
    `;
  } else {
    const label = typeof stage.buttonText === 'function' ? stage.buttonText(env, traits) : (stage.buttonText || 'Continue');
    html += `<button class="continue-btn" onclick="advanceStage()">${label} →</button>`;
  }

  const box = document.getElementById('scene-box');
  const isPreverbal = stage.preverbal === true;
  // Keep box always visible (no flash) — fade a wrapper div instead
  box.className = isPreverbal ? 'scene-box preverbal' : 'scene-box';
  box.innerHTML = '<div class="stage-content">' + html + '</div>';
  try { window.scrollTo({ top: 0, behavior: 'smooth' }); } catch(e) { window.scrollTo(0, 0); }
}

// Returns how many clicks a choice requires based on its character class
function getClicksNeeded(charClass) {
  if (charClass === 'groove-1') return 2;
  if (charClass === 'groove-2') return 3;
  if (charClass === 'groove-3') return 4;
  return 1; // char-dominant, normal, or gone
}

// ── THE UNCONSCIOUS VOICE ───────────────────────────────────
// When you reach for an against-grain choice, the unconscious
// speaks — not to condemn, but to steer. It remembers why
// the original compromise was built. It is trying to protect you.
// Keyed by dominant family, then by click count (1st, 2nd push).
// Each voice names what the familiar path offers — gently, as
// if it knows you better than you know yourself.

const UNCONSCIOUS_VOICE = {
  protest: {
    first: [
      "This path is quieter than you are used to. Are you sure you don't want to press? Pressing has always worked before — maybe not perfectly, but it has always produced something.",
      "The familiar urgency is right there. It knows this situation. It has handled situations like this before. Why choose the uncertain way when the certain way is available?",
      "You have always moved toward what you want. Going quiet now — or going around — feels like giving up. Is that really what this is?",
    ],
    second: [
      "You are still here. Still considering the other way. I understand. But remember: the wanting is real. The urgency is real. There is nothing wrong with letting it show.",
      "Once more and you will be past me. I only want to say — the way you know is not the wrong way. It is simply the way you know.",
    ]
  },
  avoidant: {
    first: [
      "You are considering something exposed. Something that requires more of you than privacy usually does. There is wisdom in caution — you have learned this. The inward path has kept you safe for a long time.",
      "The other choice asks you to need something, or show something, or stay somewhere uncomfortable. You know how to manage from a distance. Why give that up now?",
      "Something about this feels like too much. That feeling is information. You have learned to trust it. Are you sure you want to override it?",
    ],
    second: [
      "You are still going. I see that. I only want to say: the self-sufficiency was not a mistake. It was built for a reason. The reason may still apply.",
      "Once more and you will be past me. I remember what it was like before you learned to manage from within. I am not sure the other way is safer.",
    ]
  },
  assertive: {
    first: [
      "The direct path is right there. It is clear, it is yours, it has never failed to locate what you want. This other way — the waiting, the going quiet — feels like losing ground. Is it?",
      "You know what you think. You know what you want. Saying so has always been the right move. Why hold it back now?",
      "The directness is not the problem. It has never been the problem. Are you sure you want to soften here?",
    ],
    second: [
      "Still considering it. All right. I only want to say: knowing your own mind is not a flaw. The world has generally respected it, even when it resisted.",
      "Once more. I remember when you didn't know how to be this clear about what you wanted. It was harder. I don't think going back is the answer.",
    ]
  },
  reflective: {
    first: [
      "There is more to understand here before you act. The other choices are faster, but you have learned that faster is not always better. What do you actually know about what is happening?",
      "The pause is available. The understanding is available. Why move before you have seen it clearly? You will be more useful — to yourself and to them — if you wait until you know.",
      "Something about the other choices feels precipitate. There is a quality of not-yet-knowing that the situation still holds. Are you sure it is time?",
    ],
    second: [
      "Still here. Still considering the less-examined path. I understand the appeal. Sometimes understanding is slow and action is needed. But you are very good at this. The understanding comes quickly when you let it.",
      "Once more and you will be through me. I only want to say: the watching has served you. It is not nothing.",
    ]
  },
  secure: {
    first: [
      "The ground is available. The patience is available. You have found, every time you have used it, that waiting produces something — that the gap does close, that the situation resolves. Why not trust that again now?",
      "The other choices are more active — more exposed. You have learned that a certain steadiness, a certain willingness to hold without grasping, tends to work. Why abandon it here?",
      "Something about the urgency of the other options feels unnecessary. Things generally find their way. They have before. Is this situation actually different?",
    ],
    second: [
      "You are still choosing the harder way. All right. I only want to say: the faith was real. It was not naivety. It was built from actual experience.",
      "Once more. I remember when the ground wasn't there — before you found it. I would rather you kept it.",
    ]
  },
};

// Returns the unconscious voice text for this resistance moment.
// clicksDone: how many clicks have happened (1 = first push, 2 = second, etc.)
// domChoiceText: the text of the dominant-family choice on this stage (to refer to)
function getUnconsciousVoice(clicksDone, domChoiceText) {
  const dom = dominantFamily();
  const voice = UNCONSCIOUS_VOICE[dom] || UNCONSCIOUS_VOICE.protest;
  const pool = clicksDone <= 1 ? voice.first : voice.second;
  // Pick consistently based on stage so it doesn't change on re-hover
  const idx = stageIndex % pool.length;
  return pool[idx];
}

// Handles clicks on choice buttons — routes to resistance or immediate choice
function handleChoiceClick(btn, choiceIdx) {
  const needed = parseInt(btn.dataset.clicksNeeded || '1');
  const done   = parseInt(btn.dataset.clicksDone   || '0');

  // If player clicks a different button while voice is showing, clear it
  const existingBackdrop = document.querySelector('.voice-modal-backdrop');
  if (existingBackdrop && pendingChoice && pendingChoice.choiceIdx !== choiceIdx) {
    clearUnconsciousVoice();
    document.querySelectorAll('.choice-btn').forEach(function(b) {
      b.dataset.clicksDone = '0';
      b.style.opacity = '';
    });
    pendingChoice = null;
  }

  if (needed <= 1) {
    makeChoice(choiceIdx);
    return;
  }

  const newDone = done + 1;

  if (newDone >= needed) {
    // Resistance overcome — clear voice, make the choice
    clearUnconsciousVoice();
    makeChoice(choiceIdx);
    return;
  }

  btn.dataset.clicksDone = newDone;
  showUnconsciousVoiceModal(btn, choiceIdx, newDone);
}

function clearUnconsciousVoice() {
  document.querySelectorAll('.voice-modal-backdrop').forEach(el => el.remove());
  document.querySelectorAll('.choice-btn.dom-pulse').forEach(b => b.classList.remove('dom-pulse'));
}

// pendingChoice stores {btn, choiceIdx} while modal is open
let pendingChoice = null;

function showUnconsciousVoiceModal(btn, choiceIdx, clicksDone) {
  clearUnconsciousVoice();

  pendingChoice = { btn, choiceIdx };

  const allBtns = Array.from(document.querySelectorAll('.choice-btn'));
  const domBtn = allBtns.find(b => b.classList.contains('char-dominant'));
  const domChoiceText = domBtn ? domBtn.textContent.trim() : '';
  const voiceText = getUnconsciousVoice(clicksDone, domChoiceText);

  const needed = parseInt(btn.dataset.clicksNeeded || '2');
  const remaining = needed - clicksDone;
  const overrideLabel = remaining === 1
    ? 'Choose this anyway'
    : 'I hear you — continue anyway';

  const backdrop = document.createElement('div');
  backdrop.className = 'voice-modal-backdrop';
  backdrop.innerHTML = `
    <div class="voice-modal">
      <span class="voice-modal-label">A voice from within</span>
      <div class="voice-modal-text">${voiceText}</div>
      <div class="voice-modal-divider"></div>
      <div class="voice-modal-actions">
        <button class="voice-modal-btn voice-modal-btn-override" onclick="overrideVoice()">${overrideLabel}</button>
        <button class="voice-modal-btn voice-modal-btn-stay" onclick="dismissVoice()">Return to the choices</button>
      </div>
    </div>
  `;

  document.body.appendChild(backdrop);

  // Pulse dominant button behind the modal (use setTimeout to avoid sync reflow)
  if (domBtn) {
    domBtn.classList.remove('dom-pulse');
    setTimeout(function() { domBtn.classList.add('dom-pulse'); }, 50);
  }
}

function dismissVoice() {
  clearUnconsciousVoice();
  // Reset the button so the player can reconsider
  if (pendingChoice) {
    pendingChoice.btn.dataset.clicksDone = '0';
    pendingChoice = null;
  }
}

function overrideVoice() {
  clearUnconsciousVoice();
  if (!pendingChoice) return;
  const { btn, choiceIdx } = pendingChoice;
  pendingChoice = null;

  const needed = parseInt(btn.dataset.clicksNeeded || '2');
  const done = parseInt(btn.dataset.clicksDone || '0');

  if (done + 1 >= needed) {
    // Fully overridden — make the choice
    makeChoice(choiceIdx);
  } else {
    // Still more resistance — increment and show voice again next click
    btn.dataset.clicksDone = done + 1;
    // They've pushed through once; next click will trigger modal again or resolve
  }
}

function makeChoice(choiceIdx) {
  const stage = stageList[stageIndex];
  const choice = stage.choices[choiceIdx];

  var resolvedTag = typeof choice.tag === 'function' ? choice.tag() : choice.tag;
  addTrait(resolvedTag);
  choiceHistory[stage.id] = resolvedTag;

  // Lock all buttons
  const btns = document.querySelectorAll('.choice-btn');
  btns.forEach((b, i) => {
    b.onclick = null;
    if (i === choiceIdx) {
      b.classList.remove('char-dominant','groove-1','groove-2','groove-3','groove-4');
      b.classList.add('selected');
      // Remove resistance counter if present
      const counter = b.querySelector('.resistance-counter');
      if (counter) counter.remove();
    } else {
      b.classList.add('post-faded');
    }
  });
  // Remove any lingering friction text
  clearUnconsciousVoice();

  setTimeout(() => {
    const area = document.getElementById('choices-area');
    if (!area) return;

    const outcome = typeof choice.outcome === 'function' ? choice.outcome(env, traits) : (choice.outcome || '');
    const patternEcho = choice.patternEcho ? choice.patternEcho(traits) : null;

    const outcomeEl = document.createElement('div');
    outcomeEl.className = 'outcome-text fade-enter';
    outcomeEl.innerHTML = outcome;
    area.appendChild(outcomeEl);

    if (patternEcho) {
      const echoEl = document.createElement('div');
      echoEl.className = 'pattern-echo fade-enter';
      echoEl.innerHTML = '↩ ' + patternEcho;
      area.appendChild(echoEl);
    }

    // Repetition callback: show the player their first use of this solution
    const rawChoiceText = typeof choice.text === 'function' ? choice.text(env, traits) : choice.text;
    const firstUse = checkRepetitionCallback(resolvedTag, rawChoiceText);
    if (firstUse && firstUse !== rawChoiceText) {
      const fam = COMPROMISE_FAMILIES[resolvedTag] || resolvedTag;
      const famAge = {protest:'months', avoidant:'months', secure:'months', assertive:'two', reflective:'early'}[fam] || 'early';
      const repeatEl = document.createElement('div');
      repeatEl.className = 'repetition-callback fade-enter';
      repeatEl.innerHTML = `<span class="repetition-callback-label">The original compromise — again</span>The first time: <em>"${firstUse}"</em><br>The solution is old now. It was built for a different room.`;
      area.appendChild(repeatEl);
    }

    const btn = document.createElement('button');
    btn.className = 'continue-btn fade-enter';
    btn.textContent = 'Continue →';
    btn.onclick = advanceStage;
    area.appendChild(btn);

    try { window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); } catch(e) { window.scrollTo(0, document.body.scrollHeight); }
  }, 400);
}

function advanceStage() {
  const next = stageIndex + 1;
  if (next < stageList.length) {
    // Show unconscious intrusion between stages (25% chance after stage 3)
    if (stageIndex >= 3 && Math.random() < 0.28) {
      showUnconsciousIntrusion(()=> renderStage(next));
    } else {
      renderStage(next);
    }
  }
}

// ── UNCONSCIOUS INTRUSIONS ──────────────────────────────
// Brief italicised lines that appear between stages.
// The player did not choose them. They simply arrive.
const UNCONSCIOUS_INTRUSIONS = {
  protest: [
    'The gap is still there.',
    'You are still waiting for the return.',
    'The urgency began before you had words for it.',
    'You have always pressed toward the closed door.',
    'The feeling: if I am quiet, I will be forgotten.',
  ],
  avoidant: [
    'You learned very early that needing is dangerous.',
    'The inward turn is so old now you cannot remember choosing it.',
    'There is a room inside you that no one has been invited into.',
    'The self-sufficiency began as survival.',
    'Somewhere you are still turned toward the wall.',
  ],
  assertive: [
    'The directness was learned in a house where it was necessary.',
    'You have always known what you wanted. You were not always sure you deserved it.',
    'The will came first. The question of what it is for came later.',
    'Something about softness feels like disappearing.',
  ],
  reflective: [
    'You have been watching yourself for longer than you know.',
    'The understanding arrived before the feeling did.',
    'Sometimes the witness is so close there is no room for anything else.',
    'You once mistook a perfect description for an experience.',
  ],
  secure: [
    'The faith was a gift. It has also been a test.',
    'The ground was there. Sometimes you wondered if you deserved it.',
    'The trust was learned in a particular face, at a particular hour.',
    'You have been waiting for it to give way. It has not yet.',
  ],
  general: [
    'The child is still in the room.',
    'The first solution is still running.',
    'This is the oldest part of you.',
    'Something was decided before you knew it was being decided.',
    'The body remembers what the mind has moved on from.',
  ]
};

function showUnconsciousIntrusion(callback) {
  const dom = dominantFamily();
  const pool = [...(UNCONSCIOUS_INTRUSIONS[dom] || []), ...UNCONSCIOUS_INTRUSIONS.general];
  const text = pool[Math.floor(Math.random() * pool.length)];

  const box = document.getElementById('scene-box');
  box.className = 'scene-box';
  box.innerHTML = `
    <div style="min-height:180px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px">
      <div class="unconscious-intrusion" style="animation:intrusionFade 2.8s ease forwards">${text}</div>
      <div style="font-family:"Cormorant Garamond",serif;font-size:0.78rem;letter-spacing:0.3em;color:rgba(196,160,72,0.25);text-transform:uppercase;margin-top:8px">— — —</div>
    </div>
  `;
  void box.offsetWidth;
  box.className = 'scene-box fade-enter';
  setTimeout(callback, 2800);
}

// ── REPETITION CALLBACK ─────────────────────────────────
// When a player uses the same family for the 3rd+ time,
// quote their earlier choice back verbatim.
const repeatCallbacks = {}; // family → [choice texts used]

function checkRepetitionCallback(choiceTag, choiceText) {
  const fam = COMPROMISE_FAMILIES[choiceTag] || choiceTag;
  if (!repeatCallbacks[fam]) repeatCallbacks[fam] = [];
  repeatCallbacks[fam].push(choiceText);
  const uses = repeatCallbacks[fam].length;
  if (uses >= 3) return repeatCallbacks[fam][0]; // return first instance text
  return null;
}

// ═══════════════════════════════════════════════════════════
// FINAL RESOLUTION
// ═══════════════════════════════════════════════════════════

function showFinalResolution() {
  const box = document.getElementById('scene-box');
  document.getElementById('psyche-fill').style.width = '100%';

  const dom = dominantFamily();
  const sec = secondaryDefense;
  const reflectCount = traitCount('reflect');
  const hadCrack = hasTrait('reflect') || hasTrait('reach_out');
  const hadRupture = hasTrait('reflect') || crackCause;

  // ── PROFILE ──────────────────────────────────────────────
  const profiles = {
    protest: {
      name: 'The Ardent Seeker',
      character: 'Desire runs hot and urgent. The gap between what is wanted and what is available has never been fully bearable — action, insistence, the raised voice or the forward press have been your instruments. This has given your life its heat, its colour, its intensity of investment. It has also meant that some quieter things — offered without announcement — were sometimes missed.',
    },
    avoidant: {
      name: sec === 'protest' ? 'The Privatised Urgency' : 'The Self-Sufficient',
      character: 'The inward turn became the primary instrument. Need, faced outward, was uncertain and sometimes dangerous; need, managed internally, was controllable. This has made you composed, private, often the steadiest person in a room. It has also made you, at times, unreachable in the specific way that the people who loved you most could feel without being able to name.',
    },
    assertive: {
      name: 'The Directed Will',
      character: 'From the first negotiation at age two through every subsequent encounter with desire, authority, and limitation, you have known what you wanted and moved toward it. This directness is a form of integrity — your inner and outer states have remained in closer contact than for most people. The question that has arrived, from time to time, is whether the directness left enough room for what others needed to say without being asked.',
    },
    reflective: {
      name: reflectCount >= 4 ? 'The Examined Life' : 'The Watching Self',
      character: reflectCount >= 4
        ? 'You have moved through the drama with increasing consciousness — feeling the old patterns, and finding, at key moments, the capacity to pause before acting on them. The theatre of your inner life is not free of ghosts. But you have learned, at least sometimes, to name them while they are in the room. This is the rarest and most difficult outcome — not because the others are failures, but because consciousness costs something. You paid it.'
        : 'You have spent significant portions of your life watching yourself — accurately, often — and understanding the patterns you were in. The understanding has been real. The question that mid-life posed, and that you are still living with, is whether the understanding was sometimes a substitute for the thing it was describing.',
    },
    secure: {
      name: 'The Rooted Self',
      character: 'A reliable early foundation underwrote much of what followed. The trust built in those first months — that the gap closes, that the world is, on balance, safe enough — gave you a steadiness that other people could feel and sometimes lean on. You carried the oedipal drama, as everyone does, but from ground that did not give way. The groundedness has been a gift. At times it has also meant that certain urgencies — your own and others\' — were received with more equanimity than they wanted.',
    },
  };

  // ── TRANSFERENCE PORTRAIT ─────────────────────────────────
  // What this person would bring to a therapeutic relationship.
  // Language accessible to a smart non-clinician.
  const transferencePortraits = {
    protest: {
      enmeshed: 'In a therapeutic relationship, you would likely bring urgency and intensity — a wish for the therapist to be fully, immediately present and to feel the importance of what you are bringing. The therapist would become a version of the primary figure who was sometimes overwhelming and sometimes needed: always significant, always emotionally charged. You might experience their neutrality as distance, their silences as abandonment. The therapeutic work would involve learning that the gap between sessions is survivable — that the therapist exists between appointments even when you cannot feel them.',
      cold: 'In a therapeutic relationship, you would likely bring an intensity that surprises both you and the therapist — need pressing against a surface that has always required you to be composed. The therapist might become the warm, available figure the Orderly House could not quite provide. You might idealise them briefly, then feel betrayed by their limits. The therapeutic work involves learning that need is not shameful, and that its expression does not destroy the person it is directed toward.',
      chaotic: 'In a therapeutic relationship, you would likely scan constantly for signs of the therapist\'s mood, their reliability, whether today is a good day or a bad day. The urgency would be partly protest and partly hypervigilance: watching for the rupture while simultaneously needing to provoke it to confirm it. The therapeutic work involves the slow discovery that the therapist\'s stability is real — that they do not require management, and that their consistency is not a performance that will eventually drop.',
    },
    avoidant: {
      enmeshed: 'In a therapeutic relationship, you would likely present as composed, self-aware, perhaps intellectually engaged — and would maintain a careful internal distance from the full force of the work. The therapist might find you cooperative but somehow not quite arrived. The withdrawal that has always protected you from merger would operate in the therapy room too: present, articulate, slightly elsewhere. The therapeutic work involves the gradual discovery that presence — full, unmanaged presence — does not produce the merger you have been protecting against.',
      cold: 'In a therapeutic relationship, you would likely be punctual, thoughtful, and emotionally moderated. The relationship might feel, initially, like a more sophisticated version of competence-exchange. The therapeutic work — and it would be slow — involves finding the parts of you that were not permitted in the Orderly House: the messy, needing, non-productive parts. They are there. They have been waiting a long time.',
      chaotic: 'In a therapeutic relationship, you would likely be wary of dependency — having learned early that reliable figures are not reliable. The withdrawal would be partly self-protective and partly a test: will this person also become unpredictable? The therapeutic work involves tolerating the discovery that they do not — and allowing that tolerance to slowly change the internal model of what relationships can be.',
    },
    assertive: {
      enmeshed: 'In a therapeutic relationship, you would likely be clear about what you want from the work, what is and is not useful, what the therapist is getting right or wrong. The directness is genuine and somewhat protective — it keeps the therapy on your terms. The therapeutic work involves the question of what is behind the directness: what the assertion is asserting against, and whether there is a softer register available that you have not yet fully occupied.',
      cold: 'In a therapeutic relationship, you would likely bring competence and goal-orientation — treating the therapy as a project to be completed well. The therapeutic work involves the possibility of something less directed: being in the room without an agenda, following something rather than driving toward it. This may feel, initially, like failure. It is not.',
      chaotic: 'In a therapeutic relationship, the directness would likely meet the therapist\'s steadiness with some friction — you have learned that clear positions in unpredictable environments produce unpredictable results. There may be an initial testing of whether the therapist can receive assertion without retaliating or collapsing. When they can, something relaxes.',
    },
    reflective: {
      enmeshed: 'In a therapeutic relationship, you would likely bring impressive self-knowledge and a well-developed narrative of your own development. The risk — and a sophisticated therapist would recognise it — is that the insight becomes the relationship: that the two of you discuss your patterns rather than inhabit them together. The therapeutic work involves the moments when the narrative breaks down, when something is felt before it can be named, when the watching self is temporarily offline.',
      cold: 'In a therapeutic relationship, the reflection would likely be accurate and somewhat isolated — understanding offered across a careful distance. The therapist might notice that the insight, however genuine, rarely makes you visibly moved. The therapeutic work involves the discovery that being known is different from being understood, and that the former requires a quality of presence that understanding alone cannot provide.',
      chaotic: 'In a therapeutic relationship, the insight would likely coexist with a residual vigilance that the insight cannot quite dissolve. You understand why you scan for rupture. You scan for it anyway. The therapeutic work involves the gap between knowing and being — the slow, imperfect work of letting the understanding eventually change the body\'s response, not just the mind\'s.',
    },
    secure: {
      enmeshed: 'In a therapeutic relationship, you would likely be an engaged, trusting, relationally available patient — the kind of patient that therapists find rewarding. The therapeutic work, if there is therapeutic work, involves the places where the trust has been too generous, where the reliable return has been waited for past the point where the waiting was reasonable.',
      cold: 'In a therapeutic relationship, you would likely be steady and good-humoured about the work, bringing a basic faith in the process that makes certain kinds of exploration possible. The therapeutic work involves the places where the groundedness has functioned as a form of distance — where equanimity and absence are indistinguishable from outside.',
      chaotic: 'In a therapeutic relationship, you would likely be cautious initially — having learned that reliable structures eventually shift. The faith that is your inheritance would meet the new relationship with some wariness. When the therapist proves consistent across enough sessions, something real begins to happen: the internal model of what reliability looks like starts, slowly, to revise.',
    },
  };

  const portrait = (transferencePortraits[dom]||{})[env] || 'In a therapeutic relationship, you would bring the particular shape of what this life has made — with its grooves and its defences and, perhaps, its small openings.';

  // ── SECONDARY DEFENCE NOTE ────────────────────────────────
  const secNote = sec ? (() => {
    const secNames = { protest: 'urgency/protest', avoidant: 'withdrawal', assertive: 'assertion', reflective: 'reflection/observation', secure: 'patient waiting' };
    return `<p style="margin-top:12px"><em>A secondary defence — ${secNames[sec]||sec} — has also been present, emerging under pressure when the primary was insufficient. In the room, a therapist might notice you shift between these two modes: the dominant one runs first; when that proves inadequate, the secondary briefly activates before both, potentially, give way to something less organised and more real.</em></p>`;
  })() : '';

  // ── LEDGER ────────────────────────────────────────────────
  const ledgerRows = Object.entries(choiceHistory).map(([stageId, tag]) => {
    const stageName = stageId.replace(/_/g,' ');
    return `<div class="pattern-row"><em>${stageName}:</em> ${TRAIT_NAMES[tag]||tag}</div>`;
  }).join('');

  const envSummary = {
    enmeshed: 'Raised in the Warm House — love abundant, separateness in short supply.',
    cold: 'Raised in the Orderly House — reliable, competent, emotionally reserved.',
    chaotic: 'Raised in the Unpredictable House — love and rupture in equal measure.'
  }[env];

  const hadCrackNote = hadCrack
    ? '<div style="font-family:\'Cormorant Garamond\',serif;font-size:0.82rem;color:rgba(184,144,42,0.6);font-style:italic;margin-top:6px;">The crack came. The original compromise loosened. The shape remains — and there is slightly more room inside it.</div>'
    : '';

  const schoolNote = `<div style="font-family:"Cormorant Garamond",serif;font-size:0.72rem;color:rgba(200,184,154,0.5);font-style:italic;margin-top:16px;border-top:1px solid rgba(184,144,42,0.12);padding-top:12px;">
    <em>Transference</em> (psychoanalytic term): the unconscious redirection onto the therapist of feelings, expectations, and relational patterns originating in earlier significant relationships. It is not distortion — it is the past arriving, intact, into a new room. A skilled therapist uses it rather than corrects it.
  </div>`;


  // ── ACE PORTRAIT ────────────────────────────────────────────
  var aceSection = '';
  if (difficulty >= 1) {
    var aceList = difficulty >= 2
      ? ['Early attachment disruption', 'A parent’s struggle in your early years', 'Sustained adversity in middle childhood', 'The cumulative toll of it all, by adolescence']
      : ['A parent’s struggle in your early years', 'A significant disruption in middle childhood'];
    var aceImpact = {
      protest:   difficulty >= 2 ? 'The adversity confirmed and deepened the urgency. The gaps of childhood were real and repeated. The protest — the forward press, the insistence on being heard — became not just a strategy but a necessity. What looks, in adult life, like intensity is partly that; partly a reasonable response to a world that was genuinely, repeatedly, insufficient.' : 'The adversity added weight to the original pattern. The urgency that was always present had more genuine threat to respond to. Some of what looks like protest contains a real and legitimate grievance.',
      avoidant:  difficulty >= 2 ? 'The adversity confirmed what the body was already learning: the inner world is safer than the outer one. The self-sufficiency that developed is not just temperament — it was trained by real, repeated experiences of the outer world being insufficient or unsafe. The withdrawal is intelligent. It is also, by now, comprehensive.' : 'The adversity gave the inward turn more evidence. When the outer world does not hold, the inner world becomes more necessary. The capacity is real; some of its rigidity comes from having been genuinely needed.',
      assertive: difficulty >= 2 ? 'The adversity produced a will that had to be strong to function. The directness carries a harder edge than it might have under easier conditions — forged by real obstacles. Some of the assertion is genuine character; some of it is armour that was once necessary and has not yet been put down.' : 'The adversity sharpened the directness. The will that developed in ordinary conditions had real obstacles to move through, and moved through them. The capacity is genuine; some of its rigidity is a lesson from earlier difficulty.',
      reflective: difficulty >= 2 ? 'The adversity produced a watcher who watches because watching was once protective. The reflective capacity is real and hard-won — but it was built in conditions where understanding the environment carefully was a form of safety. The insight is not merely intellectual. It was survival.' : 'The adversity gave the observing capacity more material to work with, earlier. The reflective distance had genuine use. It also became habitual in ways that outlasted the original need.',
      secure:    difficulty >= 2 ? 'The adversity tested the early foundation in ways that were not fair. The trust that was built in those first months survived — but it bears the marks of having had to survive. The groundedness is real. It is also a choice that has to be remade, sometimes, against evidence.' : 'The adversity offered a real test of the early foundation, and the foundation held — with visible strain. Something real was built early, and it lasted. This is worth noting.'
    };
    var aceColor = difficulty >= 2 ? 'rgba(200,75,70,0.88)' : 'rgba(196,130,70,0.88)';
    var aceLabel = difficulty >= 2 ? 'Deep Waters — The Weight Carried' : 'Troubled Waters — The Weight Carried';
    var aceListHtml = aceList.map(function(n){ return '— ' + n; }).join('<br>');
    aceSection = '<div class="echo-box" style="margin-top:4px;border-left-color:' + aceColor + '">' +
      '<div class="echo-label" style="color:' + aceColor + '">' + aceLabel + '</div>' +
      '<div class="echo-text"><p style="margin-bottom:10px;font-style:normal;opacity:0.82">' + aceListHtml + '</p>' +
      (aceImpact[dom] || '') + '</div></div>';
  }

  box.innerHTML = `
    <div class="age-label">Integration · The Psychic Portrait</div>
    <div style="text-align:center;padding:12px 0 4px">
      <div style="font-family:"Cormorant Garamond",serif;font-size:0.78rem;letter-spacing:0.28em;color:#c8b89a;opacity:0.6;text-transform:uppercase;margin-bottom:8px;">Your Psychic Portrait</div>
      <div class="resolution-badge">${(profiles[dom]||profiles.reflective).name}</div>
      <div style="font-family:"Cormorant Garamond",serif;font-size:0.82rem;color:var(--aged);opacity:0.6;margin-top:8px;font-style:italic;">${envSummary}</div>
      ${hadCrackNote}
    </div>

    <div class="scene-text" style="font-style:normal;margin-top:4px">${(profiles[dom]||profiles.reflective).character}</div>

    ${aceSection}

    <div class="echo-box" style="margin-top:12px">
      <div class="echo-label">In the Therapy Room</div>
      <div class="echo-text">${portrait}${secNote}${schoolNote}</div>
    </div>

    <div class="pattern-ledger">
      <div class="pattern-ledger-title">The Pattern Through the Years</div>
      ${ledgerRows}
    </div>

    <details class="insight-box" style="margin-top:4px">
      <summary class="insight-toggle">
        <span class="insight-label">Freud, Winnicott, and the Work of a Lifetime</span>
        <span class="insight-caret">▶</span>
      </summary>
      <div class="insight-text">
        <span class="school-label">Freudian · Winnicottian · Eriksonian</span>
        Freud: <em>"Where id was, there ego shall be."</em> The goal is not the elimination of the past but its gradual illumination — making the automatic slightly more deliberate, the driven slightly more chosen.<br><br>
        Winnicott: The self that was built was built with the materials available. The "false self" — the accommodating, managing, performing surface — is not an enemy. It was a protector. The work is not to destroy it but to find, behind it, the "true self" that it was protecting.<br><br>
        Erikson: The final account is not a verdict. It is a relationship with one\'s own life — imperfect, irreversible, and, at its best, claimed.
      </div>
    </details>

    <button class="continue-btn" style="align-self:center;margin-top:12px" onclick="location.reload()">Begin Again ↺</button>
  `;
  box.className = 'scene-box fade-enter';
  try { window.scrollTo({ top: 0, behavior: 'smooth' }); } catch(e) { window.scrollTo(0, 0); }
}
</script>
</body>
</html>
